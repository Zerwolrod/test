前言
为了准备期末考试，同时也是为了之后复习方便，特对计算机网络的知识进行了整理。本篇内容大部分是来源于我们老师上课的ppt。而我根据自己的理解，将老师的PPT整理成博文的形式以便大家复习查阅，同时对于一些不是很清楚的地方，我去查阅了相关资料进行补充，当然也会有少部分个人看法夹带其中来帮助大家理解。

应评论要求这里放上本文的思维导图以供大家更好的查看


一、计算机网络概述
1 互联网的构成
网络边缘:位于互联网边缘与互联网相连的计算机和其他设备,如桌面计算机、移动计算机、服务器、其他智能终端设备
网络核心:由互联端系统的分组交换设备和通信链路构成的网状网络
如：分组交换路由器、链路层交换机、通信链路(光纤、铜缆、无线电、激光链路)

2.网络分类
个域网PAN（ Personal Area Network ）

能在便携式消费电器与通信设备之间进行短距离通信的网络
覆盖范围一般在10米半径以内，如蓝牙耳机等
局域网LAN（Local Area Network）

局部地区形成的区域网络，如企业网络
分布地区范围有限，可大可小，大到一栋建筑、小到办公室内的组网
电脑WLAN接入，打印机共享等等
城域网MAN（Metropolitan Area Network ）

范围覆盖一个城市的网络
广域网WAN（Wide Area Network）

覆盖很大地理区域，乃至覆盖地区和国家
3.接入网
接入网的用途

接入网的用途是将主机连接到边缘路由器上
边缘路由器是端系统Host去往任何其他远程端系统的路径上的第一台路由器
各种异构网络通过边缘路由器接入

接入网分类：

光纤到户FTTH
数字用户线DSL
同轴电缆
无线接入
企业和家庭网络
4.网络核心的两大功能
①路由
确定数据分组从源到目标所使用的路径（全局操作）

②转发
路由器或交换机将接收到的数据分组转发出去（即移动到该设备的某个输出接口）（本地操作）

5.网络分层
①OSI 7层模型


数据链路层 (Data Link Layer)

实现相邻（Neighboring）网络实体间的数据传输
成帧（Framing）：从物理层的比特流中提取出完整的帧
错误检测与纠正：为提供可靠数据通信提供可能
物理地址（MAC address）：48位，理论上唯一网络标识，烧录在网卡，不便更改
流量控制，避免“淹没”（overwhelming）:当快速的发送端遇上慢速的接收端，接收端缓存溢出
共享信道上的访问控制（MAC）：同一个信道，同时传输信号。如同：同一个Wifi热点（AP）连接着多个无线用户（手机），则多个用户同时需要发送数据，如何控制发送顺序？
网络层 (Network Layer)

将数据包跨越网络从源设备发送到目的设备（host to host）
路由（Routing）：在网络中选取从源端到目的端转发路径，常常会根据网络可达性动态选取最佳路径，也可以使用静态路由
路由协议：路由器之间交互路由信息所遵循的协议规范，使得单个路由器能够获取网络的可达性等信息
服务质量（QoS）控制：处理网络拥塞、负载均衡、准入控制、保障延迟
异构网络互联：在异构编址和异构网络中路由寻址和转发
传输层 (Transport Layer)

将数据从源端口发送到目的端口（进程到进程）
网络层定位到一台主机（host），传输层的作用域具体到主机上的某一个进程
网络层的控制主要面向运营商，传输层为终端用户提供端到端的数据传输控制
两类模式：可靠的传输模式，或不可靠传输模式
可靠传输：可靠的端到端数据传输，适合于对通信质量有要求的应用场景，如文件传输等
不可靠传输：更快捷、更轻量的端到端数据传输，适合于对通信质量要求不高，对通信响应速度要求高的应用场景，如语音对话、视频会议等
会话层 (Session Layer)

利用传输层提供的服务，在应用程序之间建立和维持会话，并能使会话获得同步
表示层（Presentation Layer）

关注所传递信息的语法和语义，管理数据的表示方法，传输的数据结构
应用层（Application Layer）

通过应用层协议，提供应用程序便捷的网络服务调用
②TCP/IP 4层模型


③两种模型比较


注：我们教材的是以下分层来讲述的


二、物理层
物理层考虑的是怎样才能在连接各种计算机的传输媒体上传输数据比特流，而不是指具体的传输媒体。
物理层的作用是要尽可能地屏蔽掉不同传输媒体和通信手段的差异。
用于物理层的协议也常称为物理层规程 (procedure)。
1.物理介质
①引导型介质
信号在固体介质中传播，例如铜、光纤、同轴电缆

光纤

高速运行
高速点对点传输（10-100 Gbps）
低错误率
中继器相距很远，对电磁噪声免疫

双绞线

两根绝缘铜线互相缠绕为一对
电话线为1对双绞线，网线为4对双绞线，广泛用于计算机网络（以太网）双向传输
第5类：100 Mbps~1 Gbps；第6类：10Gbps
传输距离一般为为100米


同轴电缆

两根同心铜导线，双向传输
电缆上的多个频率通道
带宽可达100Mbps
传输距离一般为200米


②非引导型介质
信号自由传播，例如无线电（陆地无线电、卫星无线电信道)

无线电

电磁频谱中各种“波段”携带的信号
没有物理“电线”
不依赖介质的广播
半双工（发送方到接收方）
无线链路类型

无线局域网（WiFi）
10-100 Mbps；10米
广域（如3/4/5G蜂窝）
在~10公里范围内
蓝牙：短距离，有限速率
地面微波：点对点；45 Mbps
同步卫星：36000km高空， 280毫秒的往返时延
低轨卫星：近地，但围绕地球高速运动，需要大量卫星才能覆盖地球
2.数据交换方式
①分组交换
分组交换采用把一个个小的数据包存储转发传输来实现数据交换。

主要的一些缺点：
1、不具有实时性。
2、存在延时。
3、会造成通信阻塞。
4、存在无用的重复数据。
5、会出现丢包的情况。

优点：
1、设计简单。
2、资源利用率很高。

②电路交换
电路连接的三个阶段：

1、建立连接。
2、数据传输。
3、释放连接。

优点：
1、传输速度快、高效。
2、实时。

缺点：
1、资源利用率低。
2、新建连接需要占据一定的时间，甚至比通话的时间还长。

电路交换的多路复用
频分多路复用FDM
时分多路复用TDM



3.信道复用
复用 (multiplexing) 是通信技术中的基本概念。
它允许用户使用一个共享信道进行通信，降低成本，提高利用率。

①频分复用
将整个带宽分为多份，用户在分配到一定的频带后，在通信过程中自始至终都占用这个频带。
频分复用的所有用户在同样的时间占用不同的带宽资源（请注意，这里的“带宽”是频率带宽而不是数据的发送速率）。


②时分复用
时分复用则是将时间划分为一段段等长的时分复用帧（TDM 帧）。每一个时分复用的用户在每一个 TDM 帧中占用固定序号的时隙。


③波分复用
波分复用就是光的频分复用。使用一根光纤来同时传输多个光载波信号。


④码分复用
各用户使用经过特殊挑选的不同码型，因此彼此不会造成干扰。

三、数据链路层
1.功能（要解决的问题）
成帧 （Framing）
将比特流划分成“帧”的主要目的是为了检测和纠正物理层在比特传输中可能出现的错误，数据链路层功能需借助“帧”的各个域来实现
差错控制 （Error Control）
处理传输中出现的差错，如位错误、丢失等
流量控制 （Flow Control）
确保发送方的发送速率，不大于接收方的处理速率，避免接收缓冲区溢出

2.数据链路层提供的服务
1.无确认 无连接 服务（ Unacknowledged connectionless ）

接收方不对收到的帧进行确认
适用场景：误码率低的可靠信道；实时通信；
网络实例：以太网
2.有确认 无连接 服务（ Acknowledged connectionless ）

每一帧都得到单独的确认
适用场景：不可靠的信道（无线信道）
网络实例：802.11
3.有确认 有连接 服务（ Acknowledged connection-oriented ）

适用场景：长延迟的不可靠信道
3.成帧（Framing）
3.1 要解决的关键问题：如何标识一个帧的开始？
接收方必须能从物理层接收的比特流中明确区分出一帧的开始和结束，这个问题被称为帧同步或帧定界
关键：选择何种定界符？定界符出现在数据部分如何处理？
3.2 成帧（framing）的方式
①带比特填充的定界符法
定界符：两个0比特之间，连续6个1比特，即01111110，0x7E

发送方检查有效载荷：若在有效载荷中出现连续5个1比特，则直接插入1个0比特


接收方的处理：
若出现连续5个1比特，
若下一比特为0，则为有效载荷，直接丢弃0比特；
若下一比特为1，则连同后一比特的0，构成定界符，一帧结束

②物理层编码违例
核心思想：选择的定界符不会在数据部分出现
4B/5B编码方案
4比特数据映射成5比特编码，剩余的一半码字（16个码字）未使用，可以用做帧定界符
例如： 00110组合不包含在4B/5B编码中，可做帧定界符
前导码
存在很长的 前导码（preamble），可以用作定界符
例如：传统以太网、802.11
曼切斯特编码 / 差分曼切斯特编码
正常的信号在周期中间有跳变，持续的高电平（或低电平）为违例码，可以用作定界符
例如：802.5令牌环网
4.差错控制
4.1 背景
链路层存在的一个问题：信道的噪声导致数据传输问题

差错（ incorrect ）：数据发生错误
丢失（ lost ）：接收方未收到
乱序（out of order）：先发后到，后发先到
重复（repeatedly delivery）：一次发送，多次接收
解决方案：差错检测与纠正、确认重传

确认：接收方校验数据（差错校验），并给发送方应答，防止差错
定时器：发送方启动定时器，防止丢失
顺序号：接收方检查序号，防止乱序递交、重复递交
4.2 差错检验与纠正
目标

保证一定差错检测和纠错能力的前提下，如何减少冗余信息量？

考虑的问题

信道的特征和传输需求
冗余信息的计算方法、携带的冗余信息量
计算的复杂度等
两种主要策略

检错码（error-detecting code）
在被发送的数据块中，包含一些冗余信息，但这些信息只能使接收方推断是否发生错误但不能推断哪位发生错误，接收方可以请求发送方重传数据主要用在高可靠、误码率较低的信道上，例如光纤链路偶尔发生的差错，可以通过重传解决差错问题

纠错码（error-correcting code)
发送方在每个数据块中加入足够的冗余信息，使得接收方能够判断接收到的数据是否有错，并能纠正错误（定位出错的位置）主要用于错误发生比较频繁的信道上，如无线链路也经常用于物理层，以及更高层（例如，实时流媒体应用和内容分发）使用纠错码的技术通常称为前向纠错（FEC，Forward Error Correction)

常用的检错码包括：

①奇偶检验 (Parity Check)
1位奇偶校验是最简单、最基础的检错码。

1位奇偶校验：增加1位校验位，可以检查奇数位错误。


②校验和 (Checksum)
主要用于TCP/IP体系中的网络层和传输层


③循环冗余校验 (Cyclic Redundancy Check，CRC)
数据链路层广泛使用的校验方法

CRC校验码计算方法

设原始数据D为k位二进制位模式
如果要产生n位CRC校验码，事先选定一个n+1位二进制位模式G (称为生成多项式，收发双方提前商定)，G的最高位为1
将原始数据D乘以2^n （相当于在D后面添加 n 个 0），产生k+n位二进制位模式，用G对该位模式做模2除，得到余数R（n位，不足n位前面用0补齐）即为CRC校验码


CRC校验码计算示例

D = 1010001101
n = 5
G = 110101 或 G = x5 + x4 + x2 + 1
R = 01110
实际传输数据：101000110101110

④汉明码
目标：以奇偶校验为基础，找到出错位置，提供1位纠错能力

给定n位待发送的数据，首先确定校验位的个数k（根据2^k≥k+n+1）
确定校验位在码流中的位置，2^i,i=0,1,2,……，得到校验位P_1,P_2,P_4,P_8,……
确定分组，即每个校验位分别负责哪些数据位
P_1负责位置号的二进制符合XXXX1形式的数据位，即1,3,5,7,9,……
P_2负责位置号的二进制符合XXX1X形式的数据位，即2,3,6,7,10,……
P_3负责位置号的二进制符合XX1XX形式的数据位，即4,5,6,7,12,13,14,15,……
基于偶校验确定每组的校验位（0或1）
注： 汉明码是采用奇偶校验的码。它采用了一种非常巧妙的方式，把这串数字分了组，通过分组校验来确定哪一位出现了错误。

实际的海明码编码的过程也并不复杂，我们通过用不同过的校验位，去匹配多个不同的数据组，确保任何一个数据位出错，都会产生一个多个校验码位出错的唯一组合。这样，在出错的时候，我们就可以反过来找到出错的数据位，并纠正过来。当只有一个校验码位出错的时候，我们就知道实际出错的是校验码位了。

5.流量控制
链路层存在的另一个问题：接收方的处理速率

接收方的接收缓冲区溢出
解决方案

基于反馈 (feedback-based) 的流量控制
接收方反馈，发送方调整发送速率
基于速率 (rate-based) 的流量控制
发送方根据内建机制，自行限速
6.媒体接入控制 MAC (Medium Access Control)子层
数据链路层分为两个子层：
MAC子层：介质访问
LLC子层：承上启下（弱层）


6.1 信道分配问题
① 时分多址接入-TDMA
TDMA: time division multiple access

按顺序依次接入并使用信道
每个用户使用固定且相同长度的时隙
某时隙轮到某用户使用时，该用户没有数据要发送，则该时隙被闲置
例子: 6-user LAN, 1,3,4时隙有数据发送, 2,5,6时隙被闲置


② 频分多址接入-FDMA
FDMA: frequency division multiple access

信道总频带被划分为多个相同宽度的子频带
每个用户占用一个子频带，不管用户是否有数据发送
例子: 6-user LAN, 1,3,4频带有数据发送, 2,5,6频带被闲置


6.2 多路访问协议


6.2.1 随机访问协议
特点：冲突不可避免

①ALOHA
纯ALOHA协议

原理：想发就发！

特点：

冲突：两个或以上的帧
随时可能冲突
冲突的帧完全破坏
破坏了的帧要重传
分隙ALOHA

分隙ALOHA是把时间分成时隙（时槽）
时隙的长度对应一帧的传输时间。
帧的发送必须在时隙的起点。
冲突只发生在时隙的起点

②载波侦听多路访问协议CSMA
特点：“先听后发”
改进ALOHA的侦听/发送策略分类


非持续式CSMA

1.特点
①经侦听，如果介质空闲，开始发送
②如果介质忙，则等待一个随机分布的时间，然后重复步骤①

2.好处
等待一个随机时间可以减少再次碰撞冲突的可能性

3.缺点
等待时间内介质上如果没有数据传送，这段时间是浪费的

持续式CSMA

p-持续式CSMA

1.特点

①经侦听，如介质空闲，那么以 p的概率 发送，以(1–p)的概率延迟一个时间单元发送
②如介质忙，持续侦听，一旦空闲重复①
③如果发送已推迟一个时间单元，再重复步骤①

1-持续式CSMA

1.特点
①经侦听，如介质空闲，则发送
②如介质忙，持续侦听，一旦空闲立即发送
③如果发生冲突，等待一个随机分布的时间再重复步骤①

2.好处：持续式的延迟时间要少于非持续式

3.主要问题：如果两个以上的站等待发送，一旦介质空闲就一定会发生冲突

4.注意
1-持续式是p-持续式的特例

6.2.2 受控访问协议


特点：克服了冲突

①位图协议（预留协议）




竞争期：在自己的时槽内发送竞争比特

举手示意
资源预留
传输期：按序发送

明确的使用权，避免了冲突
②令牌传递
令牌：发送权限

令牌的运行：发送工作站去抓取，获得发送权

除了环，令牌也可以运行在其它拓扑上，如令牌总线
发送的帧需要目的站或发送站将其从共享信道上去除；防止无限循环
缺点：令牌的维护代价



③二进制倒计数协议


站点：编序号，序号长度相同
竞争期：有数据发送的站点从高序号到低序号排队，高者得到发送权
特点：高序号站点优先

6.2.3 有限竞争协议
利用上述二者的优势

①自适应树搜索协议（Adaptive Tree Walk Protocol）
在一次成功传输后的第一个竞争时隙，所有站点同时竞争。
如果只有一个站点申请，则获得信道。
否则在下一竞争时隙，有一半站点参与竞争（递归），下一时隙由另一半站点参与竞争
即所有站点构成一棵完全二叉树。

6.3虚拟局域网VLAN
广播域（Broadcasting Domain）

广播域是广播帧能够到达的范围；
缺省情况下，交换机所有端口同属于一个广播域，无法隔离广播域；
广播帧在广播域中传播，占用资源，降低性能，且具有安全隐患。


VLAN是一个在物理网络上根据用途，工作组、应用等来逻辑划分的局域网络，与用户的物理位置没有关系。



通过路由器或三层交换机进行VLAN间路由，实现VLAN间通信。

VLAN类型

基于端口的VLAN


基于MAC地址的VLAN


基于协议的VLAN


基于子网的VLAN


6.4无线局域网WLAN
无线局域网（Wireless Local Area Network，WLAN)：指以无线信道作为传输介质的计算机局域网

基础架构模式（Infrastructure）


分布式系统（DS）
访问点（AP）
站点（STA）
基本服务集（BSS）
扩展服务集（ESS）
站点之间通信通过AP转发
自组织模式（Ad hoc）


站点（STA）
独立基本服务集（IBSS）
站点之间直接通信
共享同一无线信道
无线局域网需要解决的问题

1.有限的无线频谱带宽资源

通道划分、空间重用
提高传输速率，解决传输问题
提高抗干扰能力和保密性
2.共享的无线信道

介质访问控制方法（CSMA/CA）
可靠性传输、安全性
3.组网模式管理

BSS构建、认证、关联
移动性支持（漫游）
睡眠管理（节能模式）
四、网络层
1.网络层概述
网络层在数据链路层提供的两个相邻端点之间的数据帧的传送功能上，进一步管理网络中的数据通信，将数据设法从源端经过若干个中间节点传送到目的端，从而向运输层提供最基本的端到端的数据传送服务。


2.网络层关键功能
路由（控制面）
选择数据报从源端到目的端的路径
核心：路由算法与协议
转发（数据面）
将数据报从路由器的输入接口传送到正确的输出接口
3.Internet网际协议
3.1 IPv4协议及其相关技术
3.1.1 基本概念
IPv4协议，网际协议版本4，一种无连接的协议，是互联网的核心，也是使用最广泛的网际协议版本，其后继版本为IPv6

internet协议执行两个基本功能

寻址(addressing)
分片(fragmentation)
3.1.2 IPv4数据报格式


版本： 4bit ，表示采用的IP协议版本
首部长度： 4bit，表示整个IP数据报首部的长度
区分服务： 8bit ，该字段一般情况下不使用
总长度： 16bit ，表示整个IP报文的长度,能表示的最大字节为2^16-1=65535字节
标识： 16bit ， IP软件通过计数器自动产生，每产生1个数据报计数器加1；在ip分片以后，用来标识同一片分片
标志： 3bit，目前只有两位有意义。
MF，置1表示后面还有分片，置0表示这是数据报片的最后1个；
DF，不能分片标志，置0时表示允许分片
片偏移： 13bit，表示IP分片后，相应的IP片在总的IP片的相对位置
生存时间TTL(Time To Live) ：8bit,表示数据报在网络中的生命周期，用通过路由器的数量来计量，即跳数（每经过一个路由器会减1）
协议：8bit，标识上层协议（TCP/UDP/ICMP…）
首部校验和：16bit ，对数据报首部进行校验，不包括数据部分
源地址：32bit，标识IP片的发送源IP地址
目的地址：32bit，标识IP片的目的地IP地址
选项：可扩充部分，具有可变长度，定义了安全性、严格源路由、松散源路由、记录路由、时间戳等选项
填充：用全0的填充字段补齐为4字节的整数倍
3.1.3 数据报分片
分片原因

数据报长度大于传输链路的MTU

MTU（Maximum Transmission Unit）, 最大传输单元

链路MTU
路径MTU (Path MTU)
分片策略

允许途中分片：根据下一跳链路的MTU实施分片
不允许途中分片：发出的数据报长度小于路径MTU（路径MTU发现机制）
重组策略

途中重组，实施难度太大
目的端重组（互联网采用的策略）
重组所需信息：原始数据报编号、分片偏移量、是否收集所有分片



IPv4分片策略

IPv4分组在传输途中可以多次分片
源端系统，中间路由器（可通过标志位设定是否允许路由器分片，DF标志位）
IPv4分片只在目的IP对应的目的端系统进行重组
IPv4分片、重组字段在基本IP头部
标识、标志、片偏移
IPv6分片机制有较大变化（见IPv6部分的介绍）
注：分组 (packet) 与 帧(frame)的关系



3.1.4 IP协议功能及报头字段总结
网络层基本功能

支持多跳寻路将IP数据报送达目的端：目的IP地址
表明发送端身份：源IP地址
根据IP头部协议类型，提交给不同上层协议处理：协议
其它相关问题

数据报长度大于传输链路的MTU的问题，通过分片机制解决：标识、标志、片偏移
防止循环转发浪费网络资源（路由错误、设备故障…），通过跳数限制解决：生存时间TTL
IP报头错误导致无效传输，通过头部机校验解决：首部校验和
3.2 IP地址
3.2.1 概述
IP地址，网络上的每一台主机（或路由器）的每一个接口都会分配一个全球唯一的32位的标识符

将IP地址划分为固定的类，每一类都由两个字段组成

网络号相同的这块连续IP地址空间称为地址的前缀，或网络前缀

IP地址共分为A、B、C、D、E五类，A类、B类、C类为单播地址

IP地址的书写采用点分十进制记法，其中每一段取值范围为0到255



IP特殊地址


3.2.1 子网划分
子网划分(subnetting)，在网络内部将一个网络块进行划分以供多个内部网络使用，对外仍是一个网络
子网(subnet )，一个网络进行子网划分后得到的一系列结果网络称为子网
子网掩码(subnet mask )，与 IP 地址一一对应，是32 bit 的二进制数，置1表示网络位，置0表示主机位
子网划分减少了 IP 地址的浪费、网络的组织更加灵活、便于维护和管理



3.2.3 无类域间路由
将32位的IP地址划分为前后两个部分，并采用斜线记法，即在IP地址后加上“/”，然后再写上网络前缀所占位数


一个 CIDR 地址块可以表示很多地址，这种地址的聚合常称为路由聚合（route aggregation），也称为构成超网 (supernet)
聚合技术在Internet中大量使用，它允许前缀重叠，数据包按具体路由的方向发送，即具有最少IP地址的最长匹配前缀
注：当路由器收到一个IP数据包时，它会将数据包的目的IP地址与自己本地路由表中的所有路由表进行逐位（Bit-By-Bit）对比，直到找到匹配度最长的条目，这就是最长前缀匹配机制。（路由比对之前会用相应路由的目的网络掩码进行逻辑与运算，再拿结果与路由路径比对）

3.3 DHCP动态主机配置协议
DHCP ：动态主机配置协议

当主机加入IP网络，允许主机从DHCP服务器动态获取IP地址
可以有效利用IP地址，方便移动主机的地址获取
工作模式：客户/服务器模式（ C/S ）
基于 UDP 工作，服务器运行在 67 号端口， 客户端运行在 68 号端口



DHCP 客户从UDP端口68以广播形式向服务器发送发现报文（DHCPDISCOVER）
DHCP 服务器广播发出提供报文（DHCPOFFER）
DHCP 客户从多个DHCP服务器中选择一个，并向其以广播形式发送DHCP请求报文（DHCPREQUEST）
被选择的DHCP服务器广播发送确认报文（DHCPACK）
3.4 ARP地址解析协议
背景
网络设备有数据要发送给另一台网络设备时，必须要知道对方的网络层地址（即IP地址）。IP地址由网络层来提供，但是仅有IP地址是不够的，IP数据报文必须封装成帧才能通过数据链路进行发送。数据帧必须要包含目的MAC地址，因此发送端还必须获取到目的MAC地址。通过目的IP地址二获取的MAC地址的过程是由ARP（Address Resolution Protocol）协议来实现的。

注：因为下层协议是通过MAC地址来确定各自身份的，所以下层发送必须要MAC地址

IP 与 MAC地址


ARP协议工作过程


A已知B的IP地址，需要获得B的MAC地址（物理地址）
如果A的ARP表中缓存有B的IP地址与MAC地址的映射关系，则直接从ARP表获取
如果A的ARP表中未缓存有B的IP地址与MAC地址的映射关系，则A广播包含B的IP地址的ARP query分组
在局域网上的所有节点都可以接收到ARP query
B接收到ARP query分组后，将自己的MAC地址发送给A
A在ARP表中缓存B的IP地址和MAC地址的映射关系
超时时删除
路由到另一个局域网


A创建IP数据包（源为A、目的为E）
在源主机A的路由表中找到路由器R的IP地址223.1.1.4
A根据R的IP地址223.1.1.4，使用ARP协议获得R的MAC地址
A创建数据帧（目的地址为R的MAC地址）
数据帧中封装A到E的IP数据包
A发送数据帧，R接收数据帧
3.5 网络地址转换(NAT)
定义
网络地址转换(NAT)用于解决IPv4地址不足的问题，是一种将私有（保留）地址转化为公有IP地址的转换技术

私有IP地址：
A类地址：10.0.0.0–10.255.255.255
B类地址：172.16.0.0–172.31.255.555
C类地址：192.168.0.0–192.168.255.255

NAT工作机制


出数据报：外出数据报用 NAT IP地址(全局), 新port # 替代 源IP地址(私有), port #

NAT转换表：每个 (源IP地址, port #)到(NAT IP地址, 新port #) 映射项

入数据报：对每个入数据报的地址字段用存储在NAT表中的(源IP地址, port #)替代对应的 (NAT IP地址, 新port #)

NAT根据不同的IP上层协议进行NAT表项管理
TCP，UDP，ICMP

传输层TCP/UDP拥有16-bit 端口号字段
所以一个WAN侧地址可支持60,000个并行连接

NAT的优势

节省合法地址，减少地址冲突
灵活连接Internet
保护局域网的私密性
3.6 ICMP: 互联网控制报文协议
ICMP: 互联网控制报文协议

ICMP 允许主机或路由器报告差错情况和提供有关异常情况的报告
由主机和路由器用于网络层信息的通信
ICMP 报文携带在IP 数据报中： IP上层协议号为1
ICMP报文类型

ICMP 差错报告报文
终点不可达：不可达主机、不可达网络，无效端口、协议
ICMP 询问报文
回送请求/回答 (ping使用)
ICMP 报文格式


ICMP报文的前 4 个字节包含格式统一的三个字段：类型、代码、检验和
相邻的后四个字节内容与ICMP的报文类型有关
ICMP报文类型及功能


4.路由算法
路由算法须满足的特性：

正确性
简单性
鲁棒性
稳定性
公平性
有效性
根据路由算法是否随网络的通信量或拓扑自适应划分

静态路由选择策略（非自适应路由选择）
动态路由选择策略（自适应路由选择）
4.1 距离向量路由
算法基本思想

每个节点周期性地向邻居发送它自己到某些节点的距离向量；

当节点x接收到来自邻居的新DV估计，它使用B-F方程更新其自己的DV :
Dx(y) ← minv{c(x,v) + Dv(y)} for each node y ∊ N

上述过程迭代执行，Dx(y)收敛为实际最小费用 dx(y)

距离向量算法特点：迭代的、分布式的

每次本地迭代由下列引起: 本地链路费用改变、邻居更新报文
分布式:各节点依次计算，相互依赖
注：路由器只掌握物理相连的邻居以及链路费用

算法过程
路由器启动时初始化自己的路由表

初始路由表包含所有直接相连的网络路径，距离均为0

路由器周期性地向其相邻路由器广播自己知道的路由信息

相邻路由器可以根据收到的路由信息修改和刷新自己的路由表


路由器经过若干次更新后，最终都会知道到达所有网络的最短距离

所有的路由器都得到正确的路由选择信息时网络进入“收敛”（convergence）状态



特殊情况考虑
计数到无穷问题（The Count-to-Infinity Problem）







好消息传播快，坏消息传播慢，是距离向量路由的一个主要缺点

4.2 链路状态路由
注：所有路由器掌握完整的网络拓扑和链路费用信息

算法过程
链路状态（Link State）路由可分为五个部分：

发现邻居，了解他们的网络地址；


设置到每个邻居的成本度量；

开销/度量/代价：
自动发现设置或人工配置
度量：带宽、跳数、延迟、负载、可靠性等
常用度量：链路带宽（反比）
例如：1-Gbps以太网的代价为1，100-Mbps以太网的代价为10
可选度量：延迟
发送一个echo包，另一端立即回送一个应答
通过测量往返时间RTT，可以获得一个合理的延迟估计值
构造一个分组，分组中包含刚收到的所有信息；
构造链路状态分组（link state packet，LSP）

发送方标识
序列号
年龄
邻居列表


将此分组发送给其他的路由器；
每个LSP分组包含一个序列号，且递增
路由器记录所收到的所有（源路由器、序列号）对
当一个新分组到达时，路由器根据记录判断：
如果是新分组，洪泛广播
如果是重复分组，丢弃
如果是过时分组，拒绝
计算到其他路由器的最短路径。
Dijkstra算法示例
D(k)：从计算节点到目的节点k当前路径代价
p(k)：从计算节点到目的节点k的路径中k节点的前继节点



距离向量和链路状态算法比较
网络状态信息交换的范围

DV:邻居间交换
LS:全网扩散
网络状态信息的可靠性

DV:部分道听途说
LS:自己测量
4.3 层次路由
产生原因

过于庞大的路由表存储、查找困难，路由信息交互开销高
现实情况：

地址分配往往是随机的，难以进行高效的地址聚合
每个网络的网络管理员有自己的管理方法和思路，并不希望每个路由器都干涉本网络内部的地址分配等问题
层次路由可以解决：

网络扩展性问题：当网络扩大时，控制路由表条目和路由表存储空间的增长
管理的自治问题：网络管理员可以控制和管理自己网络的路由
基本思路

互联网由大量不同的网络互连，每个管理机构控制的网络是自治的

自治系统（AS，Autonomous System）

一个管理机构控制之下的网络
一个AS内部通常使用相同的路由算法/路由协议，使用统一的路由度量（跳数、带宽、时延 …）
不同的AS可以使用不同的路由算法/路由协议
每个AS有一个全球唯一的ID号：AS ID
自治系统内的还可以进一步划分层次：私有自治系统或区域

效果


4.4 广播路由
广播（Broadcasting）：源主机同时给全部目标地址发送同一个数据包

实现方法
①给每个主机单独发送一个数据包

效率低、浪费带宽
Server需要知道每个目的地址
②多目标路由（multi-destination routing）

在需要转发的路由器线路复制一次该数据报
网络利用率高
Server依然需要知道所有的目的地址
注：以上方法难以实现

③泛洪（flooding）

一种将数据包发送到所有网络节点的简单方法
将每个进入数据包发送到除了进入线路外的每条出去线路
用途

保证性：一种有效广播手段，可确保数据包被传送到网络中每个节点
鲁棒性：即使大量路由器被损坏，也能找到一条路径（如果存在）
简单性：仅需知道自己的邻居
无控制的泛洪

实现广播最显而易见的技术
环路可能导致广播风暴
路由器可能收到多个副本
节点需要跟踪已泛洪的数据包以阻止洪泛
即使利用跳数来限制，也会出现成倍爆炸
解决方法：受控制的泛洪（每个路由器进行有选择的泛洪）

序号控制泛洪
逆向路径转发
④生成树（spanning tree）

源节点向所有属于该生成树的特定链路发送分组
改进了逆向路径转发
没有环路
最佳使用带宽
最少副本，消除了冗余分组
一个路由器可以不必知道整颗树，只需要知道在一颗树中的邻居即可


5.Internet路由协议
5.1 路由选择协议RIP
概述

路由选择协议RIP（ Routing Information Protocol）是基于距离矢量算法的协议
使用跳数衡量到达目的网络的距离
RIP 认为一个好的路由就是它通过的路由器的数目少，即“距离短”
RIP 允许一条路径最多只能包含 15 个路由器
RIP协议的基本思想
仅和相邻路由器交换信息
路由器交换的内容是自己的路由表
周期性更新：30s
工作过程

初始化


周期性更新

小结

RIP协议的特点

算法简单，易于实现
收敛慢
需要交换的信息量较大
RIP协议的适用场合

中小型网络
RIP协议的防环路机制

触发更新
毒性反转
水平分割
其他
5.2 BGP-外部网关路由协议
路由协议

内部网关协议 IGP： 有 RIP 和、OSPF、ISIS 等多种具体的协议
外部网关协议 EGP：目前使用的协议就是 BGP
边界网关协议BGP (Border Gateway Protocol)

目前互联网中唯一实际运行的自治域间的路由协议
BGP功能

eBGP：从相邻的AS获得网络可达信息
iBGP： 将网络可达信息传播给AS内的路由器
基于网络可达信息和策略决定到其他网络的“最优”路由
BGP会话: 两个BGP路由器通过TCP连接交换BGP报文

通告到不同网络前缀的路径，即路径向量协议
BGP路径通告


AS2的路由器2c从AS3的路由器3a接收到路径AS3, X
根据AS2的策略，AS2的路由器2c接受路径AS3, X，通过iBGP传播给AS2的所有路由器
根据AS2策略，AS2的路由器2a通过eBGP向AS1的路由器1c通告从AS3的路由器3a接收到路径AS2, AS3, X


路由器可能会学到多条到达目的网络的路径:

AS1的路由器1c从2a学到路径AS2, AS3, X
AS1的路由器1c从3a学到路径AS3, X
由策略，AS1路由器1c可能选择路径AS3, X, 并在AS1中通过iBGP通告路径
6.路由器的工作原理
6.1 路由器概述
路由器是互联网最主要的网络设备，包含2个核心功能

控制层：运行各种路由协议：BGP、OSPF、RIP，学习去往不同目的的转发路径：路由表
数据层：根据上述路由表，将收到的IP分组转发到正确的下一跳链路


6.2 路由器控制层
路由器可同时运行多个路由协议
路由器也可不运行任何路由协议，只使用静态路由和直连路由
路由管理根据路由优先级，选择最佳路由，形成核心路由表
控制层将核心路由表下发到数据层，形成转发表（FIB）
若存在多个“去往同一目的IP前缀”的不同类型路由，路由器根据优先级选择最佳路由
优先级数值越小，优先级越高

6.3 路由器数据层
路由器中IP报文转发核心功能

链路层解封装，IP头部校验
获取报文目的IP地址
用目的IP地址，基于最长前缀匹配规则查询转发表
查询失败，丢弃报文
查询成功
获取转发出接口和下一跳IP地址
IP头部“TTL”字段值减1，重新计算IP头部“校验和”
重新进行链路层封装，发送报文
注：普通IP报文转发过程中，路由器不查看传输层及以上层协议的内容

IP报文在路由器转发前后的变化

链路层封装更新，IP头部“TTL”减1，IP头部“校验和”更新
数据报在不同硬件单元的处理

报文输入的接口卡
链路层解封装
转发表查询（该工作在输入接口卡处理）
通过交换结构将报文排队发往目的接口卡（发送过快将产生拥塞）
交换结构
从输入接口卡发往输出接口卡
报文输出的接口卡
从交换结构接收报文（排队进行后续处理，到达太快将产生拥塞）
链路层封装
从输出接口发送报文
3种典型的交换结构



7.拥塞控制算法
7.1 概述
拥塞
网络中存在太多的数据包导致数据包传输延迟或丢失，从而导致网络吞吐量下降

拥塞控制（congestion control）
需要确保通信子网能够承载用户提交的通信量，是一个全局性问题，涉及主机、路由器等多种因素

产生拥塞的原因

主机发送到网络的数据包数量过多，超过了网络的承载能力
突发的流量填满了路由器的缓冲区，造成某些数据包会被丢弃
拥塞控制的基本策略

开环控制----事先对通信流参数进行协商，协商后，不管网络是拥塞还是带宽充足，参数不能动态改变
开环控制属于预防性拥塞控制，它竭力使网络总是处于无拥塞状态运行。开环控制的方法包括决定什么时候接受新流量，什么时候丢弃数据包和丢弃哪些数据包。其缺点是没有考虑网络的当前状态
闭环控制—根据网络状态进行动态控制，包括两部分：反馈机制和控制机制。闭环控制方法分为两个子类：显式反馈与隐式反馈
7.2 流量调节
抑制包(Choke Packets)：用于通知发送方减小发送量，路由器选择一个被拥塞的数据包，给该数据包的源主机返回一个抑制包，抑制包中的目的地址取自该拥塞数据包。源主机收到抑制包后，减少发向特定目的地址的流量
逐跳的抑制包(Hop-by-Hop Choke Packets)：在高速或长距离网络中，由于源主机响应太慢，抑制包算法对拥塞控制的效果并不好，可采用逐跳抑制方法；其核心思想是抑制包对它经过的每个路由器都起作用，能够迅速缓解发生拥塞处的拥塞，但要求上游路由器有更大的缓冲区
显式拥塞通告（ECN，Explicit Congestion Notification），在IP包头中记录数据包是否经历了拥塞。在数据包转发过程中，路由器可以在包头中标记为经历拥塞，然后接收方在它的下一个应答数据包里显示该标记作为显式拥塞信号
RFC2474中重新定义TOS域为包含一个6位的区分服务码点(DSCP) 和2位未使用位；RFC3168重新定义RFC2474中TOS域未使用的两位为ECN域，包含如下值：
00：发送主机不支持ECN
01或者10：发送主机支持ECN
11：路由器正在经历拥塞
7.3 随机早期检测RED (Random Early Detection)
使路由器的队列维持两个参数，即队列长度最小门限 THmin 和最大门限 THmax
RED 对每一个到达的数据报都先计算平均队列长度 LAV
若平均队列长度小于最小门限 THmin ，则将新到达的数据报放入队列进行排队
若平均队列长度超过最大门限 THmax，则将新到达的数据报丢弃
若平均队列长度在最小门限 THmin 和最大门限THmax 之间，则按照某一概率 p 将新到达的数据报丢弃
RED 将路由器的到达队列划分成为三个区域

丢弃概率 p 与 THmin 和 Thmax 的关系

当 LAV <Thmin 时，丢弃概率 p = 0
当 LAV >Thmax 时，丢弃概率 p = 1
当 THmin < LAV < THmax时， 0  p  1
例如，按线性规律变化，从 0 变到 pmax
8.服务质量
8.1概述
问题的提出

互联网本身只能提供“尽力而为的服务”或称“尽最大努力交付的服务”
当互联网越来越多的用于传输多媒体信息时，由于这些实时业务对网络的传输延时、延时抖动等特性较为敏感，这样网络的传输质量就难以保障了
IP网络不能保证特定业务的QoS要求，已经成为IP网络发展的巨大障碍
网络的服务质量越来越多的引起人们的关注，甚至成为网络技术研究的热点问题
什么是网络服务质量？（QoS, Quality of Service）

QoS是网络在传输数据流时要满足一系列服务请求，具体可以量化为带宽、时延、抖动、丢包率等性能指标

8.2 流量整形
流量整形(traffic shaping)：其作用是限制流出某一网络的某一连接的流量与突发，使这类报文以比较均匀的速度向外发送

①漏桶算法
到达的数据包（网络层的PDU）被放置在底部具有漏孔的桶中（数据包缓存）
漏桶最多可以排队b个字节，漏桶的这个尺寸受限于内存。如果数据包到达的时候漏桶已经满了，那么数据包应被丢弃
数据包从漏桶中漏出，以常量速率（r字节/秒）注入网络，因此平滑了突发流量


②令牌桶算法
产生令牌：周期性的以速率r向令牌桶中增加令牌，桶中的令牌不断增多。如果桶中令牌数已到达上限，则丢弃多余令牌
消耗令牌：输入数据包会消耗桶中的令牌。在网络传输中，数据包的大小通常不一致。大的数据包相较于小的数据包消耗的令牌要多
判断是否通过：输入数据包经过令牌桶时存在两种可能：输出该数据包或者被丢弃。当桶中的令牌数量可以满足数据包对令牌的需求，则将数据包输出，否则将其丢弃
注：漏桶算法和令牌桶算法的区别在于漏桶算法输出的流量永远不可能超过一定限制，而令牌桶算法可以容忍短时间内的高流量输出，对于一些突发流量的需求比较友好

8.3 数据包调度
在同一个流的数据包之间以及在竞争流之间分配路由器资源的算法称为包调度算法，它负责分配带宽和其他路由器资源，负责确定把缓冲区中的哪些数据包发送到输出链路上

先来先服务FCFS（First-Come First-Serve）
公平队列算法（Fair Queueing/Round Robin）
加权公平队列算法（Weighted Fair Queueing）
优先级调度（Priority Scheduling）
9.三层交换
9.1 三层交换的技术背景
二层交换网络中的广播，限制了网络规模的扩展
交换机对目标地址无法匹配的数据帧进行广播转发
交换机对目标地址为广播地址的数据帧进行广播转发
交换机为维护生成树状态产生大量的桥协议数据单元(Bridge Protocol Data Unit，BPDU)
这些广播帧会大量消耗网络资源，并频繁影响用户的数据通信
VLAN虽然可以将广播的影响限定在一定范围内，但同时也隔离了正常的用户间数据通信
传统路由器致力于解决VLAN间互联互通，但是其转发效率和拓扑复杂性带来的网络通信瓶颈无法有效应对规模扩展
9.2 三层交换的动机
利用第三层协议中的信息来加强第二层交换功能，形成带有路由功能的交换
融合VLAN 间的二层隔离和三层互通，消除大规模网络中广播对性能的影响
简化网络配置，简化网络拓扑，优化网络管理，降低网络部署成本


9.3 三层交换机的工作原理


10.虚拟专用网VPN (Virtual Private Network)
10.1 VPN的技术背景
计算机网络按用途分类
专用、公用
专用网络的实现方式
使用专用链路：铺设、租用（费用高，不灵活）
使用公共链路：不安全
虚拟专用网VPN (Virtual Private Network)
专用网络的经济、可靠、灵活的解决方案
利用安全隧道技术将专用网络在公共网络上扩展
VPN的设计原则
安全性、隧道与加密、数据验证、用户验证、防火墙与攻击检测
10.2 VPN的原理
VPN指利用公用网络架设专用网络的远程访问技术
VPN通过隧道技术在公共网络上模拟出一条点到点的逻辑专线，从而达到安全数据传输的目的




VPN对数据机密性和完整性的保护

10.3 VPN的实现方式
用VPN连接合作伙伴


用VPN实现专用网络的远程访问


11.IPv6协议
初始动机：应付“32-bit地址空间耗尽”问题（CIDR和NAT都无法从根本上解决地址短缺问题），增加地址空间
IPv6 地址

地址长度为128bit，是IPv4地址长度的4倍
IPv6地址空间数量约为3*1038
IPv6地址表示法，冒分十六进制，x : x : x : x : x : x : x : x
简化方法：每个x前面的0可省略，可把连续的值为0的x表示为“::”, 且“::”只能出现1次
简化前地址，2001:0DA8:0000:0000:200C:0000:0000:00A5
简化后地址，2001:DA8:0000:0000:200C::A5
五、传输层
1.传输层概述
传输层位于应用层和网络层之间：
基于网络层提供的服务，向分布式应用程序提供通信服务
按照因特网的“端到端”设计原则：
应用程序只运行在终端上，即不需要为网络设备编写程序
站在应用程序的角度：
传输层应提供进程之间本地通信的抽象：即运行在不同终端上的应用进程仿佛是直接连在一起的
1.1 套接字
设想在应用程序和网络之间存在一扇“门”：
需要发送报文时：发送进程将报文推到门外
门外的运输设施（因特网）将报文送到接收进程的门口
需要接收报文时：接收进程打开门，即可收到报文
在TCP/IP网络中，这扇“门”称为套接字（socket），是应用层和传输层的接口，也是应用程序和网络之间的API
1.2 传输层提供的服务
因特网的网络层提供“尽力而为”的服务：
网络层尽最大努力在终端间交付分组，但不提供任何承诺
具体来说，不保证交付，不保证按序交付，不保证数据完整，不保证延迟，不保证带宽等
传输层的有所为、有所不为:
传输层可以通过差错恢复、重排序等手段提供可靠、按序的交付服务
但传输层无法提供延迟保证、带宽保证等服务
1.3 因特网传输层提供的服务
最低限度的传输服务：
将终端-终端的数据交付扩展到进程-进程的数据交付
报文检错
增强服务：
可靠数据传输
流量控制
拥塞控制
因特网传输层通过UDP协议和TCP协议，向应用层提供两种不同的传输服务：
UDP协议：仅提供最低限度的传输服务
TCP协议：提供基础服务和增强服务
2.传输层基本服务——复用和分用
2.1 复用和分用概述
传输层基本服务：将主机间交付扩展到进程间交付，通过复用和分用实现


复用：
发送方传输层将套接字标识置于报文段中，交给网络层
分用：
接收方传输层根据报文段中的套接字标识，将报文段交付到正确的套接字
2.2 套接字标识与端口号
端口号是套接字标识的一部分：
每个套接字在本地关联一个端口号
端口号是一个16比特的数
端口号的分类：
熟知端口：0～1023，由公共域协议使用
注册端口：1024～49151，需要向IANA注册才能使用
动态和/或私有端口：49152～65535，一般程序使用
报文段中有两个字段携带端口号
源端口号：与发送进程关联的本地端口号
目的端口号：与接收进程关联的本地端口号

2.3 TCP/UDP套接字（复用和分用）
UDP套接字

使用<IP地址，端口号>二元组标识UDP套接字
服务器使用一个套接字服务所有客户
TCP套接字
使用<源IP地址，目的IP地址，源端口号，目的端口号> 四元组标识连接套接字
服务器使用一个监听套接字和多个连接套接字服务多个客户，每个连接套接字服务一个客户
3.无连接传输：UDP
3.1 UDP报文段结构
UDP报文：
报头：携带协议处理需要的信息
载荷（payload）：携带上层数据
用于复用和分用的字段：
源端口号
目的端口号
用于检测报文错误的字段：
报文总长度
校验和（checksum）


3.2 UDP校验和（checksum）
校验和字段的作用: 对传输的报文段进行检错
以下是报文段的字段

key	human	hex
Source	192.168.1.106	c0a8 016a
Destination	11.111.111.111	0b6f 6f6f
Protocol	UDP(17)	11
Length	17	11
Source Port	63549	f83d
Destination Port	12345	3039
Length	17	11
Checksum	0xb12d	b12d
Data	hello UDP	6865 6c6c 6f20 5544 5000
将上表中所有的 16 进制数加起来，之后取反码。有一点需要注意的是，如果遇到最高位进位，那么需要对结果进行回卷，意思是



求出来的即是校验和。

3.3 为什么需要UDP？
为什么需要UDP？

应用可以尽可能快地发送报文：
无建立连接的延迟
不限制发送速率（不进行拥塞控制和流量控制）
报头开销小
协议处理简单
UDP适合哪些应用？

容忍丢包但对延迟敏感的应用：
如流媒体
以单次请求/响应为主的应用：
如DNS
若应用要求基于UDP进行可靠传输：
由应用层实现可靠性
4.面向连接的传输：TCP
4.1 可靠传输
数据包有序、无差错到达接收端

如何实现可靠传输，基本原则是什么？

利用ACK确认
重传机制
差错检测
可靠传输实现举例-Stop and Wait

注：该实现俗称tcp的三次握手和四次挥手。三次挥手我们也常称为“请求 -> 应答 -> 应答之应答”的三个回合，主要就是为了建立连接

建立一条TCP连接需要确定两件事：

双方都同意建立连接（知晓另一方想建立连接）
初始化连接参数（序号，MSS等）

四次挥手：目的就是确保断开连接时双方都是确认结束的状态



4.2 流水线技术
由于信道上一直有数据不间断地传送，这种传输方式可获得很高的信道利用率。


①GBN 协议（回退 N 步协议）
发送窗口
发送方维持的发送窗口，它的意义是：位于发送窗口内的分组都可连续发送出去，而不需要等待对方的确认。这样，信道利用率就提高了。
发送方每收到一个确认，就把发送窗口向前滑动一个分组的位置。


累积确认

接收方一般采用累积确认的方式。即不必对收到的分组逐个发送确认，而是对按序到达的最后一个分组发送确认，这样就表示：到这个分组为止的所有分组都已正确收到了。
优点：容易实现，即使确认丢失也不必重传。
缺点：不能向发送方反映出接收方已经正确收到的所有分组的信息。
如果发送方发送了前 5 个分组，而中间的第 3 个分组丢失了。这时接收方只能对前两个分组发出确认。发送方无法知道后面三个分组的下落，而只好把后面的三个分组都再重传一次。
这就叫做 Go-back-N（回退 N），表示需要再退回来重传已发送过的 N 个分组。
可见当通信线路质量不好时，连续 ARQ 协议会带来负面的影响。

②SR 协议（选择重传协议）
SR 协议在 GBN 协议的基础上进行了改进，它通过让发送方仅重传那些它怀疑在接收方出错（即丢失或受损）的分组而避免了不必要的重传。选择重传协议只重传真正丢失的分组。

选择重传的接收窗口与发送窗口一样大
选择重传协议允许与接收窗口一样多的分组失序到达,并保存这些失序到达的分组,直到连续的一组分组被交付给应用层。
标记发出分组,当ACK=Sf 时,将窗口滑过所有连续的已确认的分组
如果还有未确认的分组,则重发所有检测到的未被确认的分组并重启计时器
如果所有分组都被确认了则停止计时器
确认，确认号(ACK)只定义完好接收的那一个分组的序号,并不反馈任何其他分组的信息
注：SR协议ack确认和GBN的累计确认不同，是一个一个确认

计时器
理论上选择重传协议要为每个分组使用一个计时器。当某个计时器超时后,只有相应的分组被重传。换而言之，返回N协议将所有的分组当做一个整体对待，而选择重传协议则分别对待每一个分组。但是大多数SR的运输层仅使用了一个计时器.。注意只使用一个计时器而做到跟踪所有发出去的分组的情况的做法是：标记发出分组,当ACK=Sf 时,将窗口滑过所有连续的已确认的分组，如果还有未确认的分组，则重发所有检测到的未被确认的分组并重启计时器，如果所有分组都被确认了则停止计时器。

快速重传

仅靠超时重发丢失的报文段，恢复太慢！

发送方可利用重复ACK检测报文段丢失：

发送方通常连续发送许多报文段
若仅有个别报文段丢失，发送方将收到多个重复序号的ACK
多数情况下IP按序交付分组，重复ACK极有可能因丢包产生
TCP协议规定： 当发送方收到对同一序号的3次重复确认时，立即重发包含该序号的报文段

所谓快速重传，就是在定时器到期前重发丢失的报文段

③TCP 可靠通信的具体实现
TCP 连接的每一端都必须设有两个窗口——一个发送窗口和一个接收窗口。
TCP 的可靠传输机制用字节的序号进行控制。TCP 所有的确认都是基于序号而不是基于报文段。
TCP 两端的四个窗口经常处于动态变化之中。
TCP连接的往返时间 RTT 也不是固定不变的。需要使用特定的算法估算较为合理的重传时间
GBN、SR和TCP小结
Go-Back-N协议
接收方：

使用累积确认
不缓存失序的分组
对失序分组发送重复ACK
发送方：

超时后重传从基序号开始的所有分组
SR
接收方：

缓存失序的分组
单独确认每个正确收到的分组
发送方：

每个分组使用一个定时器
仅重传未被确认的分组
TCP协议

接收方：

使用累积确认
缓存失序的报文段
对失序报文段发送重复ACK
增加了推迟确认
发送方：

超时后仅重传最早未确认的报文段
增加了快速重传
4.3 TCP报文段结构


最大段长度（MSS）：
TCP段中可以携带的最大数据字节数
建立连接时，每个主机可声明自己能够接受的MSS，缺省为536字节
窗口比例因子（window scale）：
建立连接时，双方可以协商一个窗口比例因子
实际接收窗口大小 = window size * 2^window scale
选择确认（SACK）：
最初的TCP协议只使用累积确认
改进的TCP协议引入选择确认，允许接收端指出缺失的数据字节
发送序号和确认序号的含义

5.TCP流量控制
TCP接收端

使用显式的窗口通告，告知发送方可用的缓存空间大小
在接收窗口较小时，推迟发送确认
仅当接收窗口显著增加时，通告新的窗口大小
TCP发送端

使用Nagle算法确定发送时机
使用接收窗口限制发送的数据量，已发送未确认的字节数不超过接收窗口的大小
Nagle算法的解决方法：

在新建连接上，当应用数据到来时，组成一个TCP段发送（那怕只有一个字节）
在收到确认之前，后续到来的数据放在发送缓存中
当数据量达到一个MSS或上一次传输的确认到来（取两者的较小时间），用一个TCP段将缓存的字节全部发走
Nagle算法的优点：

适应网络延时、MSS长度及应用速度的各种组合 常规情况下不会降低网络的吞吐量
6.拥塞控制
发送方根据自己感知的网络拥塞程度，限制其发送速率

6.1 拥塞控制的类型
网络辅助的拥塞控制
路由器向端系统提供显式的反馈，例如：
设置拥塞指示比特
给出发送速率指示
ATM、X.25采用此类方法
端到端拥塞控制
网络层不向端系统提供反馈
端系统通过观察丢包和延迟，自行推断拥塞的发生
TCP采用此类方法
6.2 TCP拥塞控制要解决的问题
发送方如何感知网络拥塞？

发送方利用丢包事件感知拥塞：
拥塞造成丢包和分组延迟增大
-无论是丢包还是分组延迟过大，对于发送端来说都是丢包了
丢包事件包括：
-重传定时器超时
-发送端收到3个重复的ACK
发送方采用什么机制限制发送速率?

发送方使用拥塞窗口cwnd限制已发送未确认的数据量:
LastByteSent-LastByteAcked <= cwnd


cwnd随发送方感知的网络拥塞程度而变化

发送方感知到网络拥塞后，采取什么策略调节发送速率？

①AIMD

乘性减（Multiplicative Decrease）
发送方检测到丢包后，将cwnd的大小减半（但不能小于一个MSS）
目的：迅速减小发送速率，缓解拥塞
加性增（Additive Increase）
若无丢包，每经过一个RTT，将cwnd增大一个MSS，直到检测到丢包
目的：缓慢增大发送速率，避免振荡
注：MSS是发送速率TCP建立连接时双方确定的每一个报文段所能承载的最大数据长度



②TCP慢启动

慢启动的策略：
每经过一个RTT，将cwnd加倍
慢启动的具体实施：
每收到一个ACK段，cwnd增加一个MSS
只要发送窗口允许，发送端可以立即发送下一个报文段
特点：
以一个很低的速率开始，按指数增大发送速率
区分不同的丢包事件

超时：说明网络交付能力很差
收到3个重复的ACK：说明网络仍有一定的交付能力

收到3个重复的ACK：
将cwnd降至一半
使用AIMD调节cwnd
超时：
设置门限 =cwnd/2
cwnd=1MSS
使用慢启动增大cwnd至门限
使用AIMD调节cwnd
6.3 TCP拥塞控制的实现
发送方维护变量ssthresh
发生丢包时，ssthresh=cwnd/2
ssthresh是从慢启动转为拥塞避免的分水岭：
cwnd低于门限时，执行慢启动
cwnd高于门限：执行拥塞避免
拥塞避免阶段，拥塞窗口线性增长：
每当收到ACK， cwnd=cwnd + MSS*(MSS/cwnd)
检测到3个重复的ACK后：
TCP Reno实现： cwnd= ssthresh+3，线性增长
TCP Tahoe实现：cwnd=1 MSS，慢启动

TCP发送端的事件与动作


六、应用层
1.应用层概述
每个应用层协议都是为了解决某一应用问题，通过位于不同主机中的多个应用进程之间的通信和协同工作来完成
两台主机通信实际是其对应的两个应用进程(process)在通信
应用进程: 为解决具体应用问题而彼此通信的进程
应用层的具体内容就是规定应用进程在通信时所遵循的协议
客户/服务器（C/S, Client/Server）方式
对等（P2P，Peer to Peer）方式
1.1 应用进程通信方式
①客户/服务器（C/S, Client/Server）方式
应用层的许多协议是基于C/S方式，例如，在移动互联网环境下，每个应用APP都是一个客户端
客户(client)和服务器(server)是指通信中所涉及的2个应用进程
客户/服务器方式描述的是应用进程之间服务和被服务的关系
客户是服务请求方（主动请求服务，被服务）
服务器是服务提供方（被动接受服务请求，提供服务）
C/S方式可以是面向连接的，也可以是无连接的
面向连接时，C/S通信关系一旦建立，通信就是双向的，双方地位平等，都可发送和接收数据


客户进程的特点

在进行通信时临时成为客户，它也可在本地进行其它的计算
用户计算机上运行，在打算通信时主动向远地服务器发起通信
客户方必须知道服务器进程所在主机的IP地址才能发出服务请求
需要时可以与多个服务器进行通信
服务器进程的特点

专门用来提供某种服务的程序，可“同时”处理多个远地或本地客户的请求
必须始终处于运行状态才有可能提供服务
通信开始之前服务器进程不需要知道客户进程所在主机的IP地址，无论客户请求来自哪里，服务器进程被动等待服务请求的到来即可
通常是当系统启动时即自动调用并一直运行着。某些服务器程序也可以由用户或其它进程在通信前启动
被动等待并接受来自多个客户的通信请求
②对等（P2P，Peer to Peer）方式
对等方式是指两个进程在通信时并不区分服务的请求方和服务的提供方
只要两个主机都运行P2P软件，它们就可以进行平等、对等的通信
双方都可以下载对方存储在硬盘中的共享文档，如果权限允许的话
音频/视频应用推动了P2P对等通信方式的发展（BitTorrent）
音频/视频流量已占主要比
P2P方式从本质上看仍然是使用了C/S方式，但强调的是通信过程中的对等，这时每一个P2P进程既是客户同时也是服务器


1.2 服务器进程工作方式
循环方式(iterative mode)

一次只运行一个服务进程
当有多个客户进程请求服务时，服务进程就按请求的先后顺序依次做出响应 (阻塞方式)
并发方式(concurrent mode)

可以同时运行多个服务进程
每一个服务进程都对某个特定的客户进程做出响应 (非阻塞方式)
无连接循环方式服务

使用无连接的UDP服务进程通常都工作在循环方式，即一个服务进程在同一时间只能向一个客户进程提供服务。(顺序服务)
服务进程收到客户进程的请求后，就发送UDP用户数据报响应该客户
对其他客户进程发来的请求则暂时不予理睬，这些请求都在服务端的队列中排队等候服务进程的处理
当服务进程处理完毕一个请求时，就从队列中读取来自下一个客户进程的请求，然后继续处理


面向连接的并发方式服务

面向连接的TCP服务进程通常都工作在并发服务方式，服务进程在同一时间可同时向多个客户进程提供服务。(并发服务)
在TCP服务进程与多个客户进程之间必须建立多条TCP连接，每条TCP连接在其数据传送完毕后释放
一个TCP连接对应一个（熟知）服务端口
主服务进程在熟知端口等待客户进程发出的请求。一旦收到客户的请求，就创建一个从属服务进程，并指明从属服务进程使用临时套接字与该客户建立TCP连接，然后主服务进程继续在原来的熟知端口等待向其他客户提供服务




2.域名系统
2.1 概述
域名系统（DNS，Domain Name System）是互联网重要的基础设施之一，向所有需要域名解析的应用提供服务，主要负责将可读性好的域名映射成IP地址
Internet采用层次结构的命名树作为主机的名字，并使用分布式的域名系统 DNS。Internet的DNS是一个联机分布式数据库系统
名字到域名的解析是由若干个域名服务器程序完成的。域名服务器程序在专设的结点上运行，相应的结点也称为名字服务器(Name Server)或域名服务器(Domain Name Server)


2.2 域名系统名字空间和层次结构




2.3 域名解析过程
递归查询
当收到查询请求报文的域名服务器不知被查询域名的IP地址时，该域名服务器就以DNS客户的身份向下一步应查询的域名服务器发出查询请求，即替本地域名字服务器继续查询
较少使用

迭代查询
当收到查询请求报文的域名服务器不知道被查询域名的IP地址时，就把自己知道的下一步应查询的域名服务器IP地址告诉本地域名字服务器，由本地域名字服务器继续向该域名服务器查询，直到得到所要解析的域名的IP地址，或者查询不到所要解析的域名的IP地址
通常使用


3.电子邮件
3.1 邮件发送的常用协议
简单邮件传输协议SMTP（Simple Mail Transfer Protocol）——邮件服务器之间传递邮件使用的协议

最终交付（邮件访问）协议::从邮件服务器的邮箱中获取邮件
POP3：Post Office Protocol-Version 3，第三版邮局协议
IMAP：Internet Message Access Protocol，Internet邮件访问协议
Webmail（HTTP）：基于Web的电子邮件


3.2 Webmail
Webmail——基于Web的电子邮件

提供电子邮件服务的IMAP和SMTP替代方案
使用Web作为界面，用户代理就是普通的浏览器
用户及其远程邮箱之间的通信通过HTTP进行


4.WWW
4.1 WWW体系结构与协议
WWW=World Wide Web=万维网
HTTP服务器和客户端，以及它们之间执行的HTTP协议

服务器

Web页面（HTML文档）：包含多种对象或链接
Web对象（包括：静态对象和动态对象）：可以是 HTML文档、 图像文件、视频文件、声音文件、脚本文件等
对象用URL（统一资源定位符）编址：协议类型://主机名:端口//路径和文件名
客户端

发出请求、接收响应、解释HTML文档并显示
有些对象需要浏览器安装插件


统一资源定位器URLs


www协议


4.2 HTTP
概述
超文本传输协议HTTP（ HyperText Transfer Protocol）在传输层通常使用TCP协议，缺省使用TCP的80端口
HTTP为无状态协议，服务器端不保留之前请求的状态信息
无状态协议：效率低、但简单
有状态协议：维护状态相对复杂，需要维护历史信息，在客户端或服务器出现故障时，需要保持状态的一致性等
HTTP标准
HTTP/1.0: RFC 1945（1996年）
HTTP/1.1: RFC 2616（1999年）
HTTP/2: RFC 7540（2015年）、RFC 8740（2020年）
HTTP发展现状
HTTP/1.0（1996）
无状态，非持久连接
与HTTP/1.1（1999）
支持长连接和流水线机制
缓存策略优化、部分资源请求及断点续传
HTTPS：HTTP+TLS（2008）
增加SSL/TLS（TLS 1.2）层，在TCP之上提供安全机制
HTTP/2.0（2015、2020）
目标：提高带宽利用率、降低延迟
增加二进制格式、TCP多路复用、头压缩、服务端推送等功能


Web安全与隐私：Cookie
HTTP 无状态协议，服务器 用cookies保持用户状态

HTTP在响应的首部行里使用一个关键字头set-cookie：选择的cookie号具有唯一性
后继的HTTP请求中使用服务器响应分配的cookie：
Cookie文件保存在用户的主机中，内容是服务器返回的一些附加信息，由用户主机中的浏览器管理
Web服务器建立后端数据库，记录用户信息，cookie作为关键字
例如：
Set-Cookie: SID=31d4d96e407aad42; Path=/; Domain=example.com
Cookie: SID=31d4d96e407aad42



Cookies一般包含5个字段
域指明Cookie来自何方，每个域为每个客户分配Cookie有数量限制
路径标明服务器的文件树中哪些部分可以使用该Cookie
内容采用“名字=值”的形式，是Cookie存放内容的地方，可以达到4K容量，内容只是字符串，不是可执行程序
安全指示浏览器只向使用安全传输连接的服务器返回Cookie


Cookie技术是把双刃剑，能分析用户喜好，向用户进行个性化推荐
用Cookie在某网站标识用户信息，查找用户以前浏览网站记录
用Cookie记录用户购物清单
用Cookie可以保存4K内容，跟踪用户浏览网站的喜好
用Cookie跨站点跟踪用户点击广告
Cookie技术是把双刃剑，也能跟踪用户网络浏览痕迹，泄露用户隐私
Cookie跟踪用户以前浏览过哪些网站，跟踪用户频繁浏览哪类网站
Cookie收集用户信息，用户网络交互时关注的关键词
Cookie容易嵌入间谍程序，这是个误区，Cookie文件保存的只是文本串，没有可执行程序
用户可以设置浏览器限制使用Cookie
5.流媒体
5.1 概述
流媒体概念
连续媒体（音视频）经压缩编码、数据打包后，经过网络发送给接收方
接收方对数据进行重组、解码和播放
流媒体的特性
端到端时延约束
时序性约束：流媒体数据必须按照一定的顺序连续播放
具有一定程度的容错性：丢失部分数据包也可完成基本功能
流媒体面临的挑战
约束条件：网络特性（带宽有限、动态变化、延迟与抖动、丢失、异构性）
目标：流媒体服务质量要素（画质、启动延迟、平滑、交互性）
如何在“尽力服务”的网络传输条件下获得良好的视频质量？
5.2 流媒体动态自适应传输
DASH (Dynamic Adaptive Streaming over HTTP)
动态自适应流媒体传输协议DASH，由MPEG组织制定的标准
类似协议：苹果HTTP Live Streaming（HLS）； Adobe的HTTP Dynamic Streaming（HDS）；微软的Microsoft Smooth Streaming
DASH 基本思想
完整视频被拆分为固定时长 (2s-10s) 的视频片段(segment)， 每段提供不同码率
视频片段与其对应的元文件（URL）一同存放于DASH服务器
客户端基于网络条件、缓冲大小等，对每个视频片段，自适应选择合适的视频码率来下


DASH中普遍使用的自适应码率ABR（Adaptive bitrate）

6.内容分发网络CDN
6.1 概述
内容分发网络CDN
Content Delivery Network，or Content Distribution Network
基本思想源于MIT对Web服务瞬间拥塞问题的解决（1998）
一种Web缓存系统，靠近网络边缘（用户）提供内容服务
目前提供更丰富的服务，包括静态内容、流媒体、用户上传视频等
主要优点
降低响应时延，避免网络拥塞
避免原始服务器过载及防止DDoS攻击
分布式架构，具有良好的可扩展性
对用户透明，无需用户感知
6.2 关键问题
怎样将内容（如从百万的视频中选定的内容）分发给同时发起访问的数百万用户？

6.3 机理与解决方式
DNS重定向实现CDN

将请求调度到较近或负载较轻的CDN服务器
HTTP重定向请求内容，服务提供者返回清单CDN
原始服务器决策CDN服务器
HTTP响应：状态码30X，Location：指明新的位置
DNS辅助实现CDN

负载均衡DNS负责决策CDN服务器选择
负载均衡DNS需要收集CDN服务器的位置和负载情况
如果找不到被请求的对象，需要从原始服务器获取


7.P2P网络
P2P文件分发协议：BitTorrent

文件被划分为256Kb大小的块
具有种子(torrents)的节点发送或接收文件


8.远程登录Telnet
Telnet协议引入网络虚拟终端NVT（Network Virtual Terminal），使用一种专门的键盘定义来屏蔽不同计算机系统对键盘输入的差异性，同时定义客户进程与远程服务器进程之间的交互过程
NVT是Telnet协议定义的一组通用字符集，通过这种统一的数据表示方式，来保证不同硬件、软件与数据格式的终端与主机之间通信的兼容性
本地终端输入的字符首先由本地Telnet客户进程转换为NVT格式，通过网络将NVT格式的字符传输到远程主机，远程Telnet服务器进程再将NVT格式的字符转换为远程主机能够识别和处理的字符格式
使用Telnet协议在网络中传输的数据都是NVT格式，不同的用户终端与服务器进程均与本地终端格式无关
Telnet的工作过程

本地Telnet客户进程与远程主机上的Telnet服务器进程建立TCP连接
将本地终端上输入的用户名和口令及以后输入的任何命令或字符以网络虚拟终端NVT格式传输给远程主机
将远程主机输出的NVT格式的数据转化为本地所接受的格式送回本地终端，包括输入命令回显和命令执行结果
本地终端对远程主机撤销连接，从而结束 Telnet远程登录过程


9.FTP
9.1 概述
文件传输协议FTP(File Transfer Protocol) 是Internet上使用最广泛的应用层协议之一

FTP提供交互式的访问，允许用户指明文件的类型与格式，并允许文件具有存取权限
FTP屏蔽了各计算机系统的细节，适用于在异构网络中任意计算机之间传送文件
RFC 959早在1985年就已经成为Internet的正式标准
FTP使用C/S方式实现
9.2 工作过程
服务器主进程打开TCP21端口，等待客户进程发出的连接请求
客户可以用分配的任意一个本地端口号与服务器进程的TCP21端口进行连接
客户请求到来时，服务器主进程启动从属进程来处理客户进程发来的请求
服务器从属进程对客户进程的请求处理完毕后即终止，但从属进程在运行期间根据需要还可能创建其他一些子进程
服务器主进程返回，继续等待接收其他客户进程发来的连接请求，服务器主进程与从属进程并行工作
FTP的两个端口与两个连接

控制连接在整个会话期间一直保持，客户进程发出的文件传输请求通过控制连接发送给服务器控制进程（工作在TCP21端口），但控制连接不用来传输文件
服务器控制进程在接收到客户进程发送来的文件传输请求后就创建数据传输进程（工作在TCP20端口）和数据连接
数据连接用来连接客户进程和服务器数据传输进程，实际完成文件的传输。服务器数据传输进程在文件传输完毕后关闭数据连接并结束运行


写在最后
这篇知识汇总我写了好久，因为ppt的缘故，知识整理需要自己消化一遍然后挑选重要的部分整理摘录下来，同时对于某些知识点的组织结构做了相应调整，对于不太清楚的地方，我也去查阅了相关资料做了补充。但需要注意的是有些知识点并不完整，该知识点整理也只是根据我们当时考试的考点来整理的，所以不足之处请见谅。

愿我们以梦为马，不负人生韶华！
与君共勉
————————————————

                            版权声明：本文为博主原创文章，遵循 CC 4.0 BY-SA 版权协议，转载请附上原文出处链接和本声明。

原文链接：https://blog.csdn.net/qq_46101869/article/details/118108697



第一章 计算机网络概述
        国际标准化组织(ISO): International Organization for Standardization, 制定OSI参考模型

        OSI: 开放系统互连参考模型(Open Systems Interconnection Reference Model)
    
        国际电气电子工程师: 世界上最大的专业技术团体 
    
        网络: 由若干结点(计算机、集线器、交换机、路由器等)和连接这些结点的链路组成。
    
        互联网(internet): 网络的网络。通过路由器将网络互连起来,构成一个覆盖范围更大的网络。
    
        因特网(Internet): 世界上最大的互联网。网络把许多计算机连接在一起, 互联网把许多网络连接在一起
    
        客户机(Client) 与 服务器(Server)方式: 简称C/S方式, 是因特网应用最常使用方式。
    
        对等方式(peer to peer): 简称p2p方式。

计算机网络的功能:

数据通信 (最基本)
资源共享
分布式处理: 提高可靠性, 负载均衡
1.1 计算机网络的分类 
按分布范围分类

广域网(WAN): 也称远程网, 使用点对点网络 
城域网
局域网: 使用广播技术, 广域网使用交换技术, 两者协议不同
个人区域网 
按网络的拓扑结构

总线型网络: 增减结点方便, 重负载时通信效率不高, 总线任意一处故障敏感
星形网络: 便于集中控制管理, 中央设备对故障敏感
环形网络: 如令牌缓局域网
网状网络: 可靠性高, 成本高, 多用在广域网中
分类图:



计算机网络的组成:

        网络边缘: 用户直接使用的,由所有连接在因特网上的主机组成。
    
        网络核心: 为边缘部分提供服务的, 由大量网络和网络的路由器组成。

工作方式图:



        通信子网: 实现数据通信
    
        资源子网: 实现资源共享/数据处理

功能组成图:



1.2 三种交换方式
1.2.1 电路交换
        建立连接-->数据传输-->释放连接, 在通话的全部时间内,建立了一条专用的物理通路, 通话的两个用户始终占用端到端的通信资源。

电话交换图:



        特点: 通信时延小, 有序传输, 没有冲突, 但建立时间长, 独占线路线路利用率低。

1.2.2 报文交换
        整个报文先传送到相邻结点, 全部存储下来后查找转发表,转发到下一个结点。

        存储转发: 先暂时存储下来, 检查首部, 按首部中的目的地址查找转发表, 找到合适的接口转发出去,交给下一个分组交换机。 
    
        特点: 无需建立连接, 可以同时发给多个目的地址, 但转发时延高。

1.2.3 分组交换
        同报文交换一样, 采用了存储转发方式, 但解决了报文交换中大报文的传输问题, 可分为面向连接的虚电路方式和无连接的数据报方式, 这两者方式都由网络层提供。 

        分组交换: 将一个数据报文划分成一个个更小的等长数据段, 每个数据段前加上必要的控制信息,构成分组, 通过路由器以存储转发方式,发送到目标主机。

数据报分组交换图:



        数据报特点: 无建立时延, 线路利用率高, 动态分配线路, 相比报文交换, 减少了出错概率和重发数据量, 但存在存储转发时延, 需要传输额外信息量(控制信息), 可能出现失序(虚电路不会)、丢失、重复。 

三种交换比较图:



1.3 计算机网络主要性能指标
1.3.1 速率
        速率就是数据的传送率,它也称为数据率或比特率, 单位是bit/s (bps)

速率:

        千 1kb/s=b/s
    
        兆 1Mb/s=kb/s
    
        吉 1Gb/s=Mb/s
    
        太 1Tb/s=Gb/s

存储容量:

        1KB=B=1024B
    
        1MB=KB
    
        1GB=MB
    
        1TB=GB

1.3.2 带宽
        在计算机中,带宽用来表示网络的通信线路所能传送数据的能力, 即单位时间从网络中的某一点到另一点所能通过的"最高数据率",单位是bit/s。

1.3.3 吞吐量
         也称吞吐率, 表示在单位时间内通过某个网络(或信道,接口)的数据量。吞吐量受网络的带宽或网络的额定速率的限制。

1.3.4 时延
        时延是指数据从网络的一端传送到另一端所需的时间,也称延迟或迟延。

        传输时延: 主机或路由器将分组发送到通信线路上所需的时间, 从发送分组的第一个比特算起,到该分组的最后一个比特发送到线路上所需的时间。公式是:

发送时延=数据长度/发送速率 (信道带宽)

        传播时延: 电磁波在信道中需要传播一定的距离而花费的时间, 公式是:

传播时延=信道长度/电磁波在信道上的传播速率

        处理时延: 主机或路由器收到分组时要花费一定的时间进行处理(分析分组首部、提取数据、差错检验、查找路由等)
    
        排队时延: 在网络传输时, 经过许多路由器的缓存队列中排队的时间。
    
        时延带宽积: 某段链路现在有多少比特



        往返RTT: 从发送数据开始, 到收到接收方确认的时间
    
        备注: 所谓高速网络链路,提高的仅仅是数据的发送速率而不是比特在链路上的传播速率 。提高发送速率只是减少了数据的传输时延。

1.3.5 丢包率***
        即分组丢失率, 指在一定时间范围内, 分组在传输过程总丢失的分组数量与总的分组数量的比率。丢包率高,用户感觉往往是网络时延变大, 而不是信息丢失。

分组丢失的两种情况:

在传输过程中出现了比特级差错, 被结点丢弃
分组交换机队列已满,被抛弃
1.3.6 利用率***
        信道利用率: 信道利用率指出某信道有百分之几的时间是被利用的。根据排队理论, 信道利用率过高会产生非常大的时延。

        网络利用率: 全网络的信道利用率的加权平均值



1.4 计算机网络体系结构
        协议: 控制两个对等体(或多个实体)进行通信的规则。

协议三要素:

语法: 数据与控制信息的结构或格式
语义: 各个控制信息的具体含义, 完成何种动作及做出何种响应。
同步(时序): 数据应该在何时发送出去, 以什么速率发送。
        服务: 下层为紧邻的上层提供的功能调用。协议是"水平的", 服务是"垂直的"。

        接口:  访问服务点(SAP), 上层使用下层服务的入口。

服务、协议、接口：



        协议数据单元(PDU): OSI 对等层之间传送的数据单元, 包含协议控制单元(PCI), 服务数据单元(SDU)

PDU示例图:





1.4.1 五层协议模型
应用层

        任务: 通过进程间的交互来完成特定的网络应用
    
        协议: 如HTTP协议, SMTP协议, FTP协议等
    
        数据单元: 报文

传输层

        任务: 向两台主机中进程(端到端)之间的通信提供的数据传输服务,
    
        功能: 复用, 分用, 流量控制, 差错控制的功能。
    
        协议: TCP协议、UDP协议
    
        TCP: 提供面向连接的, 可靠的数据传输服务, 数据单元是报文段
    
        UDP: 提供无连接的, 尽最大努力的传输服务, 数据单元是用户数据报
    
        服务访问点(SAP): 端口号字段

网络层(网际层、IP层)

        任务: 选择合适的路由,存储转发,最后到达目标主机。
    
        功能: 路由选择, 流量控制, 差错控制, 拥塞控制
    
        主要协议：IP、IPX、ICMP、 IGMP、ARP、RARP、OSPF
    
        数据单元: IP数据报, 简称数据报
    
        服务访问点(SAP): 协议字段

数据链路层

        任务: 把网络层传下来的数据报组装成帧, 差错控制, 流量控制, 控制对信道的访问的功能。
    
        数据单元: 帧
    
        主要协议：SDLC、HDLC、PPP、 STP
    
        帧: 包括数据和控制信息(一个帧从哪里开始,到哪里结束、差错检测)
    
        服务访问点(SAP): 类型字段

物理层

        任务: 主要任务是在物理媒体上实现比特流的透明传输。
    
        主要功能: 定义接口特性, 定义传输模式(单工、半双工、双工), 定义传输速率, 比特同步, 比特编码
    
        数据单元: 比特
    
        主要协议：Rj45、802.3
    
        传输媒体: 双绞线、同轴电缆、光缆等。

 1.4.2 OSI参考模型
        表示层: 用于处理在两个通信系统中交换信息的表示方式, 如: 数据格式变换, 加密解密, 压缩和恢复。

        会话层: 建立同步（SYN）, 提供建立连接并在连接上有序地传输数据。

示意图：



与TCP/IP的区别:



三者区别图: 



1.5 两个重要的新兴网络技术***
云计算

        定义: 云计算是一种运行在计算机网络上的分布式应用,通过网络以按需、易扩展的方式向用户提供安全、快捷、便捷、廉价的数据存储和网络计算服务。
    
        Iaas: 基础设施即服务, 将硬件设备等基础资源(如处理能力、存储空间、网络组件)封装成服务通过网络提供给用户使用。
    
        Paas: 平台即服务,提供用户应用程序的开发和运行环境
    
        Saas: 软件即服务 ,将某些特定应用软件功能封装成服务

物联网

        定义: 物物相连的互联网。按约定的协议,把任何物体与互联网相连接, 进行信息交换和通信,以实现人与物,物与物的相互沟通和对话, 对物体进行智能化识别、定位、跟踪、管理和控制的一种信息网络。

第二章 物理层
2.1 基本概念
        物理层主要任务是确定与传输媒体接口有关的一些特性, 即定义标准

        信源：产生和发送数据的源头。
    
        信宿：接收数据的终点 。
    
        信道：信号的传输媒介。

三种通信方式:

        单工通信: 只有一个方向的通信
    
        半双工通信: 通信的双方都可以发送或接收信息，但任何一方都不能同时发送和接收
    
        全双工通信: 通信双方可以同时发送和接受信息

物理层接口特性:

        机械特征:  规定物理连接时所采用的规格、接口形状、引线数目、引脚数量和排列情况。
    
        电气特征:  线路上信号的电压范围、阻抗匹配、传输速率和距离限制等。
    
        功能特征: 某条线上出现的某一电平表示何种意义  
    
        规程特征: 定义各条物理线路的工作规程和时序关系

数据传输方式:

1) 串行传输: 速度慢，费用低，适合远距离



2) 并行传输: 速度快，费用高，适合近距离



模拟信号/连续信号图:



数字信号/离散信号图:



        同步传输: 需先送出1个或多个同步字符，再送出整批的数据。
    
        异步传输: 加一个字符起始位和一个字符终止位。发送方可以在任何时刻 发送这些比特组，而接收方不知道它们会在什么时候到达。
    
        码元: 用一个固定时长的数字脉冲, 代表不同离散数值的基本波形, 这个时长内的信号称为k进制码元，而该时长称为码元宽度。1码元可以携带多个比特的信息量
    
        码元传输速率：别名波特率, 或调制速率, 波形速率, 符号速率。 表示单位时间内数字通信系统所传输的码元个数（也可称为脉冲个数或信号变化的次数）, 单位是波特（Baud）, 码元速率与进制数无关，只与码元长度有关。
    
        信息传输速率：别名信息速率、比特率等表示单位时间内数字通信系统传输的二进制码元个数, 单位是比特/秒（b/s）。
    
        波特率与比特率的关系：若一个码元携带n bit的信息量，则M Baud的码元传输速率所对应的信息传输速率为M×n bit/s。 

2.1.1奈氏准则（奈奎斯特定理）
        在没有噪声、带宽有限的信道中, 为了避免码间串扰的极限码元传输速率。

        码间串扰：接收端收到的信号波形失去了码元之间清晰界限的现象。 
    
        采样定理(奈奎斯特定理): 采样率必须大于或等于最大频率的2倍。 

公式: 



说明: 

        1) 在任何信道中，码元传输的速率是有上限的
    
        2) 奈氏准则给出了码元传输速率的限制，但并没有对信息传输速率给出限制。
    
        3) 要提高数据的传输速率, 必须设法使每个码元能携带更多个比特的信息量

2.1.2 香农定理
        在带宽受限且有噪声的信道中，为了不产生误差，信息的数据传输速率有上限值。

公式:  



        信噪比: 信号的平均功率/噪声的平均功率, 用分贝（dB）作为度量单位为:

 


如:  , 则 

        说明:  信道的带宽或信道中的信噪比越大，则信息的极限传输速率就越高。

2.2 编码&调制 
        基带信号: 将数字信号1和0直接用两种不同的电压表示，再送到数字信道上去传输

        宽带信号: 将基带信号进行调制后形成的频分复用模拟信号，再传送到模拟信道上去传输
    
        备注: 传输距离较近时，计算机网络采用基带传输方式, 距离较远时，采用宽带传输方式
    
        编码: 数据转化为数字信号
    
        调制: 数据转化为模拟信号 

相关设备的作用:  

        调制器: 数字数据转化为模拟信号
    
        PCM编码器: 模拟数据转化为数字信号
    
        数字发送器: 数字数据转化为数字信号
    
        放大调制器: 模拟数据转化为模拟信号

2.2.1 数字数据编码为数字信号


        1) 非归零编码【NRZ】: 高1低0, 存在同步问题
    
        2) 曼彻斯特编码: 看前半个, 高1低0, 同差分曼彻斯特编码, 占的频带宽度是原始基带宽度的两倍 (波特率:比特率=2:1, 编码效率是50%), 以太网采用曼彻斯特编码 , 电平跳变用于同步
    
        3) 差分曼彻斯特编码: 看前半个与其前面的关系, 相同为1, 不同为0。常用于局域网。有更强抗干扰能力。
    
        4) 归零编码【RZ】:  高1低0  (return to zero)
    
        5) 反向不归零编码【NRZI】: 遇到0则变 (由高变低. 由低变高)
    
        6) 4B/5B编码: 比特流中插入额外的比特以打破 一连串的0或1，编码效率为80%

2.2.2 数字数据调制为模拟信号


        调幅+调相（QAM）: 数据传输速率为  b/s (B为波特, m个相位, n种振幅)
    
        备注: 调频抗干扰能力强, 调幅抗干扰能力差。

2.2.3 模拟数据编码为数字信号
        根据采样定理, 它主要包括三步：采样, 量化, 编码

示例图: 



2.3 传输介质及物理层设备
2.3.1 传输介质
        它就是数据传输系统中在发送设备和接收设备之间的物理通路。传输媒体/介质并不是物理层。

1) 双绞线 (twisted pair cable): 由两根采用一定规则并排绞合的、相互绝缘的铜导线组成 

示例图:



特点: 价格便宜, 最常用的传输介质之一。 

2) 同轴电缆: 分为两类, 一类用于传送基带数字信号, 又称基带同轴电缆, 一类用于传送宽带信号，又称为宽带同轴电缆



特点: 抗干扰特性比双绞线好，传输距离更远，但价格较双绞线贵。

3) 光纤: 光纤由纤芯(实心)和包层构成, 带宽远远大于其他传输媒体的带宽



光纤分类图:



特点: 传输损耗小, 抗雷电和电磁干扰性能好, 不易被窃听或截取数据。体积小，重量轻。

非导向性传输介质:

        1) 无限电波: 信号向所有方向传播, 有较强穿透能力
    
        2) 微波: 信号固定方向传播, 通信频率较高, 有地面微波接力通信和卫星通信两种方式 
    
        3) 红外线和激光: 信号固定方向传播。

2.3.2 物理层设备 
        中继器(转发器): 对信号进行再生和还原，对衰减的信号进行放大, 中继器两端的网段一定要是同一个协议, 可以是不同传输媒体。

        5-4-3规则：用4个中继器串联的5段通信介质只有3段可以挂计算机。
    
        集线器: 实质上是一个多端口的中继器, 只起信号放大和转发作用。星形网络拓扑结构。

第三章 数据链路层
备注: 

        1）OSI体系的数据链路层有流量控制功能, TCP/IP体系中流量控制在传输层 
    
        2）通信质量较差的无限传输中, 数据链路层使用确认和重传机制, 向上提供可靠传输服务
    
        3）通信质量较好的有线链路不再使用确认和重传机制, 由CRC检错保证上交的帧是正确的。

3.1 封装成帧
        数据链路层以帧为单位传输和处理数据, 将网络层的数据报前面和后面分别添加上首部和尾部, 封装成一个完整的帧。首部和尾部作用之一就是进行帧定界。组帧即定义数据格式。

 帧图:



        组帧的四种方法:  字符计数法, 字符填充法, 零比特填充法, 违规编码法。

3.1.1 字符计数法
        帧首部使用一个计数段来标明帧内字符数

示例图:



3.1.2 字符填充法
        使用某个特殊的控制字符作为帧定界符, 使用字节填充的方法将数据部分的特殊字符与帧定界符区分开来, 即在数据中出现的标记字符前插入一个转义字符。

字节填充原理图:



3.1.3 零比特填充法
        当物理链路传送连续的比特流, 可以使用某个特殊的比特组合, 如HDLC协议使用的"01111110"作为标识, 即数据部分只要发现有5个连续1, 则立即填入一个0。

原理图:



3.1.4 违规编码法
        在物理层进行比特编码时采用, 如曼彻斯特编码采用高-高电平或低-低电平，局域网IEEE802标准采用了此方法。

3.2 差错控制
        FCS: 帧检验序列,帧尾部设置的一个差错检验字段。Frame Check Sequence

        CRC: 循环冗余检验, Cyclic Redundancy Check, 也称多项式编码
    
        随机差错: 通过提高信噪比可以减弱影响
    
        突发差错: 引起传输差错的主要原因,由外界电磁干扰引起。

3.2.1 奇偶检验
        每个数据字节都会增加一个额外的位，称为校验位。校验位被设置为使得每个字节中“1”的位数为奇数（或偶数）。

3.2.2 循环冗余码
        具有纠错功能, 只是数据链路层仅使用了它的检错功能。

 CRC 运算原理:



3.2.3 汉明码
        1) 确定汉明距离: , k为冗余信息位数, n为校验位的位数

        2) 校验位的分布:  (i=0,1,2 ... ) 
    
        3) 求出校验码值
    
        4) 汉明码距: 纠错 (2d+1), 检错(d+1)

示例图:



纠错示例图:  



3.3 流量控制和可靠传输
        在数据链路层中, 流量控制和可靠传输是交织在一起的。

        流量控制: 停止等待协议 和 滑动窗口协议。

3.3.1 停止等待协议 Stop-and-Wait
        收到一个正常分组时, 回复一个ACK; 发现错误则回复NAK, 并使发送方重发, 发送方每发送一个分组必须停下来等待接受确认后才能发下一个分组。

        为防止确认分组丢失, 可以采用超时重传机制。
    
        为防止重复接受, 发送带序号的帧。

SW协议原理图:





停止等待协议的信道利用率:



        信道利用率: 发送方发送数据的时间占整个发送周期的比率。TD,TA为传输时延。

1.4.2 回退 N 帧协议 Go-back-N
        采用流水线传输方式, 利用发送窗口限制发送方连续发送分组的个数,  一个分组出错, 其后续连续发送的所有分组都要重传。

        接收方采用累计确认的方式, 有接受窗口的话, 则GBN协议的接受窗口为1。收到失序分组则丢弃, 并对最近按序接受的分组进行确认。

GBN协议原理图:



流水线传输的信道利用率:



        发送窗口大小: 

1.4.3 选择重传协议 Selective Repeat
        在GBN协议基础上, 接受窗口不再为1, 对正确接受的分组进行逐一确认。超时只重传一个超时的帧。

SR协议原理图:



        滑动窗口长度:    (发送窗口+接受窗口<=)
    
        窗口边界: (下边界, 上边界)

连续ARQ协议的信道利用率:





3.4 介质访问控制
        采取一定措施, 使得两个节点之间的通信不会发送相互干扰的情况。

介质访问控制分类图:



3.4.1 静态划分信道
频分多路复用与时分多路复用示例图:



统计时分多路复用(STDM):  



波分多路复用图: 



码分多路复用:  令S表示A站点的码片向量, 令T表示B站点的码片向量 (0用-1,1用+1 ) 则:

        1) S和T的规格化内积: 
    
        2) 在公共信道上进行线性相加
    
        3) 要去A的信息时, 使S与(S*T)进行规格化内积(相乘,除m), -1为0, +1为1(相同码片内积为1, 不同码片内积为0, 因此过滤掉非S的其他信号)

3.4.2 动态划分信道
        争用型协议。

        纯ALOHA协议: 不监听信道, 不按时间槽发送, 想发就发。一段时间内未收到确认就认为发生了冲突。超时后等一随机时间再重传。
    
        时隙ALOHA协议: 将时间划分为一段段等长的时隙, 只能在每个时隙开始才能发送一个帧。

时隙ALOHA协议示意图:



        CSMA协议: 载波监听多路访问协议, 发送前先监听一下共用信道, 发现空闲后再发送。

三种CSMA对比:



        CSMA/CD协议:   载波监听多址接入/碰撞检测。适用于总线型网络或半双工网络。
    
        碰撞检测: 边发送监听,也称冲突检测, 发送碰撞时, 适配器立即停止发送。

 原理图:



        最小帧长: 2*总线传播时延*数据传输速率

截断二进制指数退避算法:

         帧的发送时延不能小于2倍网络最大传播时延, 即一个争用期, 因此以太网规定最短有效帧长64字节。也称动态退避算法



        CSMA/CA协议: 载波监听多址接入/碰撞避免

 不使用CSMA/CD 协议的原因:

        1) 无限信道传输信号强度的动态范围非常大。
    
        2) 隐蔽站问题:



CSMA/CA 工作原理:



三种帧间间隔IFS: 所有站发送完后必须等待一段的时间, 即帧间间隔(IFS)

        1) SIFS: 最短的IFS, 分隔属于一次对话的各帧, 如ACK帧
    
        2) PIFS: 在PCF操作中使用
    
        3) DIFS: 最长的IFS, 用于异步竞争访问的时延。

退避算法:

        1) 当要发送帧的站点检测信道从忙态转为空闲时, 就要执行退避算法(除了非发生不成功的初有数据)。退避计时器设置一个随机退避时间, 当退避计时器减小到零时, 就开始发送数据。
    
        2) 当退避计时器的时间还未减小到零时,信道又转变为忙态, 便冻结退避计时器的数值,重新等待信道变为空闲, 并经过DIFS 后, 继续启动退避计时器。 
    
        3) 为避免一个站点独占信道, 一个站点成功发送完一个数据帧后, 连续发送下一个帧时要启动退避算法。
    
        4) 空闲时等待一个DIFS后发送数据帧。

信道预约:

        1)为减少碰撞的概率和降低碰撞的影响, 源站发送数据帧前要发送一个短的控制帧。即请求发送RTS (Request To Send), 其包括源地址, 目标地址, 通信所需时间(包括确认帧)。
    
        2) 若信道空闲, 目的站就发送一个响应, 即允许发送CTS (Clear To Send )。也包括通信持续时间。
    
        3) 除源站和目的站以外, 其他站收到CTS (或数据帧) 后推迟接入到无线局域网中。如果RST发送碰撞, 需执行退避算法重传RTS。

虚拟载波监听:

        RTS 帧和CTS 帧即数据帧都会携带通信持续时间, 这便叫虚拟载波监听, 但站点检测到正在信道中传送的MAC首部的 "持续时间" 字段时, 会调整自己网络分配向量 NAV (Network Allocation Vector)。

原理图:



        网络分配向量NAV: 指出信道忙的持续时间。源站是SIFS+CTS+SIFS+数据帧+SIFS+ACK, 目的站是SIFS+数据帧+SIFS+ACK。

轮询协议图:



令牌传递协议原理图:

3.5 局域网(Local Area Network)
决定局域网特性的三个要素: 

介质访问控制方式(最重要)
网络拓扑结构
传输介质
局域网分类:

以太网: 逻辑拓扑是总线型结构, 物理拓扑是星形或拓展星形, 符合IEEE802.3标准
令牌环(IEEE802.5): 逻辑拓扑是环形结构, 物理拓扑是星形结构
FDDI(光纤分布数字接口, IEEE802.8): 逻辑拓扑是环形结构, 物理拓扑是双环结构
无限局域网: 采用IEEE802.11标准
IEEE802.1Q: VLAN
        IEEE802标准定义的局域网: 对应OSI参考模型的数据链路层和物理层, 将数据链路层拆分为逻辑链路控制子层(LLC)和媒体接入控制子层(MAC)。

        LLC主要功能: 向网络层提供无确认无连接, 面向连接, 带确认无连接, 高速传送, 给帧加序号
    
        MAC主要功能: 与接入媒体有关的内容, 如组帧, 拆卸帧, 比特传输差错检测, 透明传输

示例图:



3.5.1 以太网
        采用无连接工作方式, 不可靠传输, 差错纠正由高层完成, 发送的数据使用曼彻斯特编码。采用 CSMA/CD 介质访问控制方式。以太网是局域网的一种实现方式, 工作在OSI参考模型的下两层。

        MAC地址: 全球唯一物理地址, 占6字节。

以太网的传输介质图(常识):



MAC帧图:



        填充: 0~46字节(最短MAC帧长度为18字节, 以太网帧数据字段最短帧长64B, 最大1500B) 。
    
        校验码(FCS): 不检验MAC帧数据部分和前导码。 采用32位循环冗余码(CRC)

高速以太网:



        快速以太网: 使用CSMA/CD协议, 保持最短帧长不变, 将最大电缆长度减少到100M。

3.5.2 无线局域网 
IEEE802.11 帧最常见的两种情况:



808.11数据帧:



3.5.3 虚拟局域网VLAN
        将局域网内的设备划分成与物理位置无关的逻辑组的技术, 每个VLAN是一个较小的广播域

IEEE802.1Q帧:





备注:

VLAN标记的后12位是VLAN标识符VID， 唯一表示了该以太网帧属于哪个VLAN。
VLAN的有效VID取值范围为1～4094。 
IEEE 802.1Q帧是由交换机来处理的，而不是由用户主机来处理的。
 以太网交换机构成虚拟局域网:



        备注: 交换机与交换机之间是802.1Q帧, 交换机与主机之间是标准以太网帧。 

划分VLAN的方式:

        1) 基于交换机接口: 
    
        2) 基于MAC地址: 主机与从一个交换机移动到另一个交换机, 也仍属于一个子网
    
        3) 基于IP地址: 跨路由器扩展子网

3.6 广域网
        将分布在不同地区的局域网或计算机系统互连起来, 达到资源共享的目的。如因特网(Internet)是最大的广域网。点对点通信。工作在OSI参考模型的下三层

广域网与局域网的区别与联系:



3.6.1 ppp协议
        只支持全双工链路。标志字节7E, 转义字节7D

ppp协议的三个组成部分:

一个将IP数据报封装到串行链路的方法
链路控制协议(LCP): 用于建立、配置、测试和管理数据链路。身份验证
网络控制协议(NCP): ppp可支持多种网络层协议, 每个不同的网络层协议要用一个相应的NCP来配置
ppp协议状态图:



ppp协议帧格式图:



ppp协议特点:

提供差错检测但不提供纠错功能, 不可靠传输, 即不使用序号和确认机制
仅支出点对点的链路通信, 无需CSMA/CD协议, 也就无最短帧长限制。
只支持全双工链路
ppp的两端可以运行不同的网络层协议
面向字节, PPP帧的长度是整数个字节
异步传输使用字节填充法, 同步传输采用硬件来零比特填充法。
3.6.2 HDLC协议***
        面向比特, 可靠传输, 差错检测不纠错, 采用全双工通信。

HDLC帧格式图:



3.7 数据链路层设备
物理层扩展以太网:



链路层扩展以太网:



         网段: 一般指一个计算机网络中使用同一物理层设备(传输介质, 中继器, 集线器)能够直接通讯的那一部分。

以太网交换机的两种交换方式:

        1) 直通式交换机: 查完目的地址(6B) 就立刻转发, 延迟小, 可靠性低, 不支持不同速率的端口交换。
    
        2) 存储转发式交换机: 检查帧是否正确, 可靠性高, 支持不同速率的端口交换。

冲突域和广播域: 



        VLAN: 可隔离冲突域, 也可隔离广播域
    
        网卡: 主要功能在物理层和数据链路层。

第四章 网络层
4.1 网络层概述
        异构网络互连, 向上只提供简单灵活的, 无连接的, 尽最大努力交付的数据报服务。

        网络拥塞: 当网络中有大量分组需要从某条链路转发时, 出现分组丢失的情况。(队满情况)

拥塞控制的两种方法:

开环控制: 静态预防方法, 设计网络时事先将有关发生拥塞的因素考虑周到。
闭环控制: 动态方法, 采用监测网络系统去监视, 并解决拥塞。
        无连接服务：不事先为分组的传输确定传输路径，每个分组独立确定传输路径，不同分组传输路径可能不同。

4.1.1 网络层提供的两种服务
         1) 虚电路：一条源主机到目的主机类似于电路的路径（逻辑连接, 电路不是专用）, 分组包含虚电路号, 区别其他虚电路上的分组。

虚电路网络图:



        虚电路特点: 提供了可靠通信功能, 不会乱序、重复或丢失。两个端系统之间也可有多条虚电路为不同的进程服务。缺点是某个结点出现故障时, 经过该结点的所有虚电路将遭到破坏。 

2) 数据报网络图:



 数据报与虚电路区别图:



4.1.2 路由器
         历史原因, 有称为网关, 网络层最核心的功能:  分组转发和路由选择。用路由器互连的多个局域网的网络层协议可以不同 (如IPV4与IPV6)

        转发: 仅涉及一个路由器, 转发表根据路由表得出。
    
        路由选择: 涉及很多路由器, 

路由器的结构:



 三种交换结构图***: 



4.1.3 软件定义网络SDN
        采用集中式的控制平面和分布式的数据平面, 两个平面互相分离, 通过Openflow协议将转发表下发给路由器。路由器查找转发分组即可。

        SDN的可编程性通过北向接口提供编程接口, 和转发设备建立双向会议的称为南向接口, SDN控制器之间的通信接口称为东西向接口

SDN特点:

全局集中式控制和分布式高速转发, 灵活可编程与性能平衡
集中管理易受攻击, 随着网络规模扩大, 控制器可能成为网络性能瓶颈 
4.2 IPV4与IPV6及其相关协议
        IP地址实际上标记的是一个主机(或路由器)和一条链路的接口。

4.2.1 IPV4       
        首部的固定长度占20个字节, 后面是可选字段, 首部长度可变。

IP数据报图:



各字段:

1) 版本 : 占4位, IP协议版本, 如4 (IPv4)

2) 首部长度: 占4位, 单位是32位即4个字节。不足4字节由填充字段补齐。

3) 总长度: 占 16位, 首部和数据之和的长度, 单位为字节。一般大于576字节,小于1500字节

4) 标识 :占16位, 每产生一个数据报, 计数器+1, 用于分片时使用。标识同一个数据报

5) 标志: 占3位,第一位为MF, MF=1表示后面还有分片; 第二位为DF, DF=0表示可以分片。

6) 片偏移: 占13位, 单位是8个字节, 表示某片在原分组中的相对位置, 分片的长度一定是8字节的整数倍。

7) 生存时间(TTL): 占8位, 每一跳减少1;

8) 首部检验和: 占16位, 仅校验首部

9) 协议: 6表示TCP, 17表示UDP

检验和计算图: 



数据报分片图:



4.2.2 IP地址及编址方式
        点分十进制记法: IP地址由32位二进制构成, 每8位用等效十进制数字表示。

        多归属主机: 一个主机同时连接到两个网络上时, 该主机必须同时具有两个相应的IP地址, 如: 路由器
    
        分类编址: 每一类地址由两个固定长度字段组成, 一个是网络号, 一个是主机号

分类编址图:



私有地址: 



特殊IP地址:



        网络地址转换(Network Address Translation): NAT能使内部专用地址的专用网络用户共享少量外部全球地址, 以此来访问因特网上的主机和资源。NAT工作在传输层

 NAT原理图:



子网掩码示例图:



        无分类编址CIDR: 无分类域路由选择, 把32位IP地址分成两个部分, 前面连续的全1表示网络号, 后面全0部分指明主机。 

举例:



        斜线记法:即在IP地址后面加上斜线 "/" , 然后写上网络前缀所占的位数。如上图: 192.168.10.215/24
    
        CIDR地址块: 把网络前缀都相同的连续IP地址组成一个CIDR地址块。即路由聚合, 又称构成超网。

构成超网:



        最长前缀匹配: 路由表中可能存在多个包含关系的地址块前缀, 查找可能不止一个匹配结果, 应当从匹配结果中选择具有最长网络前缀的路由。 
    
        默认路由: 用特殊0.0.0.0/0 表示默认路由。
    
        子网划分: 分为等长子网划分 (如: 00,01,10,11 (子网号能否全0全1看情况) ) 和不等长子网划分(如: 0,10,110,1110), 子网划分不增加网络数量。

4.2.3 地址解析协议 ARP (Addresss Resolution Protocol) 
        IP地址放在IP数据报首部, 物理地址则放在MAC帧首部; 物理地址是数据链路层及以下使用的地址, IP地址是网络层及以上各层使用的地址, 是一种逻辑地址。

        ARP: 地址解析协议, 由IP地址找出相应的物理地址
    
        RARP: 逆地址解析协议, 由物理地址, 得出IP地址

IP地址与物理地址图: 



原理:

        1) 每一个主机都有一个ARP高速缓存, 其中存有本局域网上个主机和路由器的IP地址到物理地址的映射表。
    
        2) 主机A向本局域网主机B发送IP数据报时, 先查看ARP高速缓存有无B主机的IP地址, 若有, 则通过局域网把MAC帧发往此物理地址, 若无, APR进程在本局域网广播一个ARP请求分组 (目的MAC为地址为FFFF-FFFF-FFFF)。
    
        3) ARP请求分组是数据链路层的广播, 但ARP响应分组是数据链路层单播
    
        4) 主机A在发送ARP请求分组时, 就把自己的IP地址核物理地址映射写入ARP请求分组, 所有接收到ARP广播的主机都会更新自己的ARP高速缓存。
    
        5) ARP用于解决同一个局域网上的主机或路由器的IP地址和物理地址映射问题。
    
        6) ARP高速缓存中的每一个映射地址项目都设置有生存时间(10~20min)。

原理图:


4.2.4 网际控制报文协议 ICMP (Internet Control Message Protocol)
        ICMP差错报告中的数据字段由IP数据报的首部和数据字段的前8个字节组成。是网络层协议。

ICMP差错报文图:



ICMP差错报告报文:

        1) 终点不可达: 路由器或主机不能交付数据报时, 就向源点发送终点不可达报文
    
        2) 源点抑制: 因拥塞而丢弃数据报时。
    
        3) 时间超时: 当目的地址不是自己时, 会将TTL-1再转发出去, TTL减为0时。
    
        4) 参数问题: 收到的数据报的首部中有的字段的值不正确时
    
        5) 改变路由: 即重定向, 让主机知道下次应将数据报发送给另外的路由器。

以下情况不发送ICMP差错报告:

        1) 对ICMP差错报文不再发送ICMP差错报文
    
        2) 对第一个分片的数据报片的所有后续数据报片
    
        3) 具有多播地址的数据报
    
        4) 对特殊地址, 如:127.0.0.1

ICMP询问报文类型:

回送请求和回答报文
时间戳请求和回答报文
地址掩码请求和回答报文
路由器询问和通告报文 
应用举例:

        1) ping指令: 使用了ICMP的回送请求和回答报文
    
        2) tracert指令(Windows操作系统)

4.2.5 IPV6
        从更本上解决地址耗尽问题, 支持QoS。没有IPV4的校验和字段。

IPV6数据报格式:



特点:

地址位扩大到128位
支持即插即用, 不需要DHCP协议
首部长度必须是8B整数倍
只能在主机处分片
取消了检验和字段
地址表示形式:

        1) 一般形式: 冒号十六进制记法
    
        2) 压缩形式: 省略开头连续的0, 但在域中至少要一个数字; 或双冒号表示法, 进一步省略连续的0, 仅能出现一次。

示例图:



基本地址类型:

单播
多播
任播
IPV6过渡策略:

        1) 双栈协议:一台设备同时启用IPV4和IPV6协议栈。
    
        2) 隧道技术: IPV6要进入IPV4时, 把整个IPV6数据报封装到IPV4数据报的数据部分。

4.3 路由算法及其相关协议
        因特网将整个互联网划分为许多较小的自治系统, 称AS。一个大的ISP就是一个自治系统。AS之间再做路由。

        静态路由算法: 又称非自适应路由算法, 需由网络管理员手工配置路由信息。
    
        动态路由算法: 即自适应路由算法, 通过相互连接的路由器之间彼此交换信息, 按照一定算法优化出路由表, 一定时间时隙里不断更新路由信息。 
    
        内部网关协议 IGP:  自治系统内部使用的路由选择协议, 也称域内路由选择, 如RIP、OSPF协议。
    
        外部网关协议 EGP:  自治系统间的路由选择协议, 也称域间路由选择, 如BGP协议。

关系图:



 4.3.1 RIP (Routing Information Protocol)
        RIP协议即路由信息协议, 是一种分布式的基于距离向量(DV)的路由选择算法。应用层协议, 使用UDP传送数据。

 RIP协议报文格式:



工作原理:

        1) 每一个路由器都要维护从它自己到其他每一个目的网络的距离记录
    
        2) 距离即跳数, 每经过一个路由器, 跳数就+1, 距离=16相当于不可达。
    
        3) 仅和相邻路由器交换路由表, 交换的信息是自己的路由表, 按固定时间(如30s)周期性更新, 或网络拓扑变化时更新, 即触发更新。 
    
        4) 收到相邻路由器的路由表,找出到达每个目的网络的最短距离和下一跳路由器, 并更新自己的路由表。

特点:

实现简单, 但只适用于小型互联网
坏消息传播得慢, 导致回路的更本原因
坏消息传递慢示例图:



4.3.2 OSPF (Open Shortest Path First)
        OSPF 协议即开放最短路径优先。使用分布式的链路转态(LS)路由选择算法, 是网络层协议(IP首部协议字段为89)。

OSPF分组: 



工作原理:

        1) 向本自治系统中所有路由器发送与本路由相邻的所有路由器的链路状态, 最终所有路由器都建立一个链路状态数据库, 即全网的拓扑结构图, 再根据 dijkstra算法求得最优路径的路由表 (路由表不会存储完整路径, 仅有下一跳)。
    
        2) 当链路转态发生变化时, 路由器向所有路由器泛洪法发送此信息, 同时也会周期性洪泛更新信息。
    
        3) 为了使OSPF能用于规模很大的网络, 可以把一个自治系统划分为若干更小的范围, 叫作区域, 一个区域内的路由器最好不超过200个。
    
        4) 刚刚开始工作时, 路由器只知道直接连接的网络的距离, 经过若干次更新后, 所有路由器都会知道到达本自治系统中任意一个网络的最短距离和下一跳路由器地址。
    
        划分区域: OSPF将一个自治系统划分为若干更小的范围, 称为区域, 好处是泛洪法交换链路状态信息范围便局部在每个区域。 

划分区域示例图:



特点:

        1)  可以有多条相同代价路径, 可以将流量分配给这几条路径, 实现负载平衡。
    
        2) 每10s交换一次问候分组, 每30min更新一次, 更新过程收敛的快, 适用于互联网规模很大时
    
        3) 对于不同类型业务可以计算不同的路由
    
        4) 每个链路状态都带上一个32位序号, 序号越大, 状态越新。

4.3.3 外部网关协议 BGP (Broder Gateway Protocol)
        只是力求寻找一条能够到达目的网络且比较好的路由,需要根据策略进行路由选择(策略包括政治、经济、安全方面)。

        只需要在发生变化时更新有变化的部分。是应用层协议, 基于TCP。

BGP协议报文格式: 



工作原理:

        建立TCP连接, 相邻结点互相通告自己到所有目的地的路径信息。
    
        每一个AS的管理员选择至少一个路由器作为AS的BGP代言人, 负责在AS间交换路由信息。
    
        各BGP根据所采用的策略从收到的路由信息中构建出树形结构的AS连通图。

示例图: 





BGP-4的四种报文:

OPEN(打开)报文: 用来与相邻的另一个BGP发言人建立关系
UPDATE(更新)报文: 通知新路径或撤销原路径
KEEPALIVE(保活)报文: 周期性证实邻站的连通性
NOTIFICATION(通知)报文: 报告先前报文的差错, 或用于关闭连接。
三种协议的比较图:  



4.4 IP组播与移动IP
4.4.1 IP组播
        组播一定仅应用与UDP, 把一个分组发送给多个目的主机, 使用D类地址, 组播地址标识一组地址。

1) 单播:



2) 多播(组播): 



硬件组播:



        备注: 组播IP地址与以太网硬件地址的映射关系不是唯一的, 还需要在IP层利用软件进行过滤。 
    
        因特网组管理协议IGMP: 让路由器知道本局域网是否有主机参加或退出了某个组播组。实际上就是要找出以源主机为根节点的组播转发树。使用IP数据报传递报文。

IGMP工作的两个阶段：

        1) 主机要加入组播组, 向组播组的组播地址发送一个IGMP报文, 本地组播路由器收到后, 利用组播路由选择协议把这组成员关系发给因特网上其他组播路由器。
    
        2) 本地组播路由器周期性探询本地局域网上的主机, 只要一个主机对某个组响应, 就认为这个组是活跃的, 几次探询没有回应, 则不再把这组成员关系发给其他的组播路由器。

4.4.2 移动IP
        指移动站以固定的网络IP地址实现跨越不同网段的漫游功能。代理功能在应用层完成。

相关术语: 

移动结点: 具有永久IP地址的移动设备(区别于DHCP分配的私有地址)
归属代理: 本地代理, 一个移动结点拥有的就"居所"。
外部代理: 外地代理, 在外部网络中帮助移动节点完成移动管理功能的实体
移动通信过程: 



第五章 传输层
网络层与传输层区别:

       网络层提供主机到主机之间的逻辑通信, 而传输层为应用进程之间提供端到端的逻辑通信

区别图:



​        

        复用: 多个应用进程可同时使用传输层的服务
    
        分用: 传输层把收到的信息分别交付给上面应用层的相应进程
    
        端口: 端口是应用层与传输层之间接口的抽象, 端口号是应用进程的传输层地址。端口用16位端口号进行标记, 允许有65535个端口号,分为熟知端口、登记端口、动态端口。
    
        熟知端口: 其数值为0~1023。由因特网赋号管理局分配给常用的应用层程序固定使用。

如: 

DNS - 53



        登记端口: 数值为1024-49151。不分配也不控制, 可以先IANA注册登记, 防止重复使用。
    
        动态端口: 其数值为49152-65535。留给客户进程选择的临时端口。

常见应用:



5.1 UDP
        DUP传送的数据单元是用户数据报，首部字段由四个部分组成, 每个部分都是2个字节,共8个字节。

特点:

        1) 无连接, 减少开销和发送数据前的时延
    
        2) 尽最大努力交付, 即不可靠交付, 但不需要维持许多参数、复杂连接状态表。
    
        3) 没有拥塞控制, 不因拥塞降低发送速率, 适合实时应用。
    
        4) 面向报文, 不对应用层交下来的报文行划进分分组, 因此应用层要交合适大小的报文, 太大,IP传送时需要进行分片, 太小, IP首部相对较大, 都会降低IP层的效率。
    
        5) 支持一对一, 一对多, 多对一, 多对多交互通信。
    
        6) 首部只有8个字节开销, 比TCP至少20个字节是首部要短。

 UDP首部字段图:



首部字段: 

        1) 源端口: 源端口号
    
        2) 目标端口: 目标端口号
    
        3) 长度: 首部和数据之和的长度, 单位为字节。
    
        4) 检验和: 差错检验码, 防止UDP用户数据报在传输中出错, 可选字段(全0表示不检验)

 UDP计算检验和方法:

        1) 与IP只检验首部不同, UDP的检验会把首部和数据部分一起检验。
    
        2) 首先将全0放入检验和字段中, 将伪首部及用户数据看成16位的字串,不是偶数个字节, 则加入一个全0字节。而后按二进制反码计算出这些16位字的和, 将此二进制反码写入检验和中。
    
        3) 接收方收到的UDP用户数据报连同伪首部一起, 按二进制反码求这些16位字的和, 无差错时结果为全1, 否则就丢弃这个错误的UDP数据报。
    
        4) 伪首部既不下传, 也不上交, 仅仅是计算检验和。
    
        5) 伪首部的第三个字段为全0, 第四个字段是UDP协议字段, 固定17。

示例图:



5.2 TCP
        MMS: 最大报文段长度 (数据段部分)

5.2.1 TCP报文段首部格式
        TCP的数据单元是报文段, 首部的前20个字节是固定的, 后面有4N个字节是根据需要而增加的选项。面向字节流

首部字段:

        源端口与目标端口: 各占两个字节,与UDP一样, 用于传输层的复用和分用
    
        序号: 占4个字节, 从0开始到2^32 - 1为止, 可对4GB的数据进行编号。每一个字节都要按顺序编号。整个数据的起始序号在连接建立时约定; 首部中的序号字段值表示本报文段所发送数据的第一个字节序号。
    
        确认号: 占4个字节, 是期望收到对方的下一个报文段的第一个数据字节的序号。如:收到序号为501, 数据长度为200, 则期待收到的下一个数据序号是701。
    
        数据偏移: 占4位, 指出TCP报文段的数据起始处距离TCP报文段的起始处有多远。即TCP报文段首都的长度。数据偏移的单位是32位字,(即4字节) 最大表示范围是60字节, 即TCP首部最大长度。
    
        确认位ACK: 置为1时, 确认号字段才有意义
    
        紧急位URG: URG=1时, 表明报文中有紧急数据。配合紧急指针使用
    
        同步位SYN: SYN=1时, 表明是一个连接请求/接受报文
    
        终止位FIN: FIN=1时, 要求释放链接
    
        保留: 占6位, 暂不使用。
    
        窗口: 占2个字节, 指示发送方的接受窗口大小。窗口用来控制对方发送的数据量。   
    
        检验和: 占2字节, TCP伪首部的第四个字段为TCP的协议号16，其计算与UDP检验和一样。

TCP首部字段图:



TCP的主要特点:

        1) 面向连接: 传输数据前, 必须先建立TCP连接
    
        2) 每一条TCP连接只能是点对点的
    
        3) 可靠交付的服务, 通过TCP连接传送的数据无差错、不丢失、不重复、按序到达。
    
        4) 全双工通信, 允许通信双方的应用进程在任何时候都能发送数据, 两端都设有发送缓存和接收缓存。
    
        5) 面向字节流, TCP把应用进程交下来的数据块看成是一连串无结构的字节流进行封装发送。

5.2.2 TCP连接管理
       TCP是面向连接的议协。TCP连接分三个阶段. 即连接建立, 数据传送, 连接释放。

三次握手:

        1) 客户端进程发出请求报文段, 首部SYN置为1, 同时选择一个序号seq=x。TCP客户端进入SYN-SENT (同步已发送)状态。
    
        2) 服务器进程发回连接确认请求, 在确认报文段中把SYN和ACK都置为1, 确认号是ack=x+1, 同时为自己定义一个序号seq=y。TCP服务进入 SYN-RCVD ( received 同步收到)状态。
    
        3) 客户端进程收到连接确认后, 还要向服务器进程给出确认, 同时可携带数据。ESTABLISHED (已建立连接)状态。第三次握手不携带数据则不消耗序号!
    
        备注: SYN=1的报文段不能携带数据, 但要消耗一个序号。

TCP连接图:



        SYN洪泛攻击: 服务器的资源在完成第二次挥手时分配的, 客户端的资源在完成第三次握手时分配, 因此服务器易受到SYN洪泛攻击。

四次挥手: 

        1) 客户端把发往服务器的报文段首部 FIN=1, seq=u (之前已传送的最后一个字节的序号+1)。TCP客户端进入FIN-WIT-1(终止等待1)状态。
    
        2) 服务器收到释放连接通知后, 发出确认号ack=u+1。服务器进入CLOSE-WAIT(关闭等待)状态。这样, 客户端到服务器的连接就释放了, 连接处于半关闭状态。但客户端仍能接受服务器发送的数据, 并给出确认。客户端进入FIN-WIT-2。
    
        3) 当服务器不再向客户端发送数据时, 发出FIN=1, seq=w, ack=u+1(基于上次), 这时服务器进入 LAST-ACK (最后确认)状态。客户端进入TIME-WAIT。
    
        4) 客户端收到连接释放报文段后, 回复ack=w+1, seq=u+1 但客户端的TCP不能马上释放, 还要等待最长报文段寿命时间(2MSL)才能释放整个连接。因为服务器可能重发(3)。最后, 客户端进入CLOSED(连接关闭)状态。

TCP连接释放图:



5.2.3 TCP可靠传输
        TCP在IP的不可靠的尽最大努力服务的基础上实现了可靠的数据传输服务, 即数据无差错、不丢失、按序不重复。

数据编号与确认:

        1) TCP协议是面向字节的, 一个字节对应一个序号。连接建立时, 双方TCP要各自确定初始序号。报文段中的序号字段值表示该报文中第一个数据字节的序号。
    
        2) TCP使用的是累积确认, 即确认是对所有按序接收到的数据的确认(已按序收到的数据的最高序号+1)。确认号表示接收方期望下次收到的数据中的第一个数据字节序号。如:已经收到了1~700, 801~1000, 那么发送的确认序号应填入701。
    
        4) TCP采用了一种延迟确认机制, 即接收方有数据发送给对方, 则可以捎带确认, 也可能这段时间内又有数据到达, 则可以对这两次到达的数据进行累积确认, 提高效率。
    
        5) 收到重复的报文段, 丢弃的同时要立即发回确认信息。

 累计确认示意图:



        超时重传机制:  TCP发送方每发送一个报文段, 就会为这个报文段设置一个计时器。时间到了但还没有收到确认,就要重传这一报文段。即超时重传。超时重传时间应当比当前往返时间(RRT)要长一些。

超时重传图:



        快速重传机制: 一个报文段的丢失会引起发送方连续收到多个重复确认, 快速重传即当发送方一连收到三个重复确认后, 立即重传丢失的报文段。

快速重传示意图:



5.2.4 TCP流量控制
        TCP采用接收方控制发送方发送窗口大小的方法来实现, 即在TCP报文段首部窗口字段是当前接收方的接受窗口大小。TCP发送方的发送窗口大小必须小于该值。

可变窗口进行流量控制图:



        窗口探测:为防止当发送方窗口为0, 而接收方发送的窗口更新报文段丢失而导致的死锁状态, 当发送方还有数据发送时, 会周期性地(如: 60s)发送只包含1个字节数据的窗口探测报文段, 以便强制接收方发回确认并通告接收窗口大小。

5.2.5 TCP拥塞控制
        慢开始: cwnd<ssthresh时, 每经过一个RRT(往返时间), 发送方的平均发送速率增加一倍。

        2) 慢启动门限(ssthresh): 发生拥塞状态下窗口大小值的一半, 当cwnd>=ssthresh时, 启动拥塞避免算法。
    
        3) 拥塞避免:当cwnd>=慢启动门限时, 就增加一个MSS大小, 按线性规律缓慢增长,直到发生拥塞。同时修改ssthresh。

 慢启动与拥塞避免算法图:



 快重传快恢复图:



        发送窗口上限值: Min( rwnd, cwnd ) 

第六章 应用层
6.1 网络应用体系结构
6.1.1 客户端/服务器结构
        客服端: 服务请求方, 不总是处于开机状态, 主动请求服务,客户端进程间不能直接通信。

        服务器: 服务提供方, 总是处于运行状态, 等待客户端请求, 服务器进程有固定端口号, 运行服务器的主机有固定的IP地址。

C/S模式图:



6.1.2 对等体结构
        没有固定的服务请求者和服务提供者, 分布在网络中的应用进程是对等的, 称为对等方, 每个对等方即是服务请求者, 又是服务提供者。最突出特性是它的可扩展性, 每增加一个对等方, 不仅增加服务请求者, 也增加了服务提供者。

P2P图:

6.2 域名系统 DNS (Domain Name System)
       域名到 IP 地址的转换过程, 以UDP数据报方式发给本地域名服务器。

备注:

多个IP地址可以映射到同一个域名上
负载分配: 允许同一个主机名对应一个IP 地址集合; 热门网站可以多个服务器, 共享同一个域名
一台主机可以映射到多个域名上
每一级域名由数字和英文字母(不区分大小写)组成,不超过63个字符, 完整的的域名不超过255字符。
三类顶级域(TLD):

国家顶级域名: 如 cn 中国 、us 美国 、 uk 英国。
通用顶级域名：如 com 公司企业、 net 网络服务机构、org 非营利性组织、int 国际组织。
反向域: 用于反向域名解析, 将IP 反向解析为域名
域名空间树状图:



四种域名服务器:

根域名服务器: 不直接把待查询的域名转成IP地址, 知道所有顶级域名服务器的域名及其IP 地址
顶级域名服务器: 收到DNS请求可能返回结果, 也可能是下一级权威服务器名服务器的IP地址
权威服务器: 负责管理某个区的域名服务器, 每一个主机的域名都必须在某个权威域名服务器处上登记 (总能将其管辖的主机名转化为IP地址)。也知道其下级权威域名服务器地址。
本地域名服务器: 起DNS代理作用, 将查询报文转发到域名服务器登记结构中。
DNS划分区图:



域名解析过程:

        递归查询:  主机向本地域名服务器的查询一般是递归查询, 即本地域名服务器不知道被查询域名的IP地址时, 本地域名服务器以DNS客户的身份向某个根域名服务器发出查询请求报文(替该主机查询)。
    
        迭代查询:   本地向根域名服务器发出请求后, 根域名服务器将顶级域名服务器的IP 地址告诉本地服务器,由本地服务器再向顶级服务器发出查询, 以此类推,直到向权威服务器查询到结果。

示例图: 



高速缓存域名服务器:

        1) 缓存最近查询过的域名。重复查询相同域名时, 不必在向根域名服务器发起请求。
    
        2) 由于IP 地址的绑定可能会发生变化, 缓存的域名会内置计时器(一般是48小时), 到时后将删除缓存。
    
        3) 增加时间值可以减少网络开销, 减少此时间值可提高域名解析的准确性。

6.3 文件传送协议 FTP (File Transfer Protocol)
        FTP基于客户/服务器体系结构, 主进程, 负责接受请求; 若干个从属进程, 负责处理单个请求, 由此两大部分组成。

两个从属进程:

        1) 控制进程: 控制连接在整个会话期间一直保持,接受客户端发出的各种命令。
    
        2) 数据传输进程: 数据连接是非持续的, 即上传完一个文件后就关闭连接。分以下两种模式: 主动模式PORT服务器的20端口连接到客户端; 被动模式PASV, 客户端连接到服务器随机端口。

原理图:



6.4 电子邮件 (SMTP&POP3)
        电子邮件采用客户端/服务器体系结构, 采用 SMTP(Simple Mail Transfer Protocol) 简单邮件传送协议、POP3(Post Office protocol) 邮局协议。

        用户代理(User Agent): 用户与电子邮件系统的接口, 又称电子邮件客户机软件。  

原理图:



两种不同通信方式:

推: 发件人通过 STMP 协议将邮件 "推" 给用户代理, 用户代理将邮件 "推" 接受方服务器。 
拉: 收件人通过 POP3 把邮件从服务器中 "拉" 过来。
TCP/IP体现的电子邮件地址格式:

收件人@邮箱所在邮件服务器的域名

IMAP（Internet Message Access Protocol）与POP3:

        1) POP3: 邮件协议第三版, 提供下载并删除和下载并保留的两种工作方式。110端口
    
        2) IMAP: 因特网邮件访问协议, 在POP3的工作方式基础上, 可以管理服务器上的邮件。允许用户代理只获取报文的某些部分。

MIME (Multipurpose Internet Mail Extensions) 多用途网际邮件扩充:



        基于HTTP的电子邮件: 客户端到服务器之间使用 HTTP, 而不同服务器间使用 SMTP 协议。 

示意图:



6.5 万维网 WWW (World Wide Web)
        万维网以客户端/服务器方式工作。

        超文本: 带有链接的文本,也叫超链接。
    
        超媒体: 包含文本信息及其他多媒体对象, 如图形、声音、视频等。
    
        超文本传送协议: HTTP
    
        超文本标记语言: HTML
    
        URL的格式: <协议>://<主机>:<端口>/<路径>, Uniform Resource Locator即统一资源定位符。
    
        超文本传送协议 HTTP: 默认端口80, 使用TCP传输层协议, 是无状态协议, 即同一个客户上一次对服务器的访问不影响下一次的访问结果。

HTTP请求过程图:



非持续与持续连接:

        1) HTTP/1.0 协议: 采用非持续连接方式, 即一次请求/响应对应一次TCP连接(三次握手)。
    
        2) HTTP/1.1 协议: 使用持续连接方式, 即响应后仍然保持这条连接。此协议还可以使用流水方式工作, 即收到HTTP的响应报文前,就可以连续发送多个请求报文。

区别图:



HTTP的报文格式:



HTTP请求报文的方法:



状态码:



        Cookie: 对无状态的HTTP进行状态话的技术

Cookie原理图:



万维网缓存与代理服务器***:

        1) web缓存: 即万维网缓存, 可位于客户机或中间系统, 在中间系统称为代理服务器。当请求到达时,若主机有请求的缓存, 则返回缓存的响应报文。
    
        2) web缓存命中率较高时,可减少访问因特网的时延, 代理服务器另一个作用是可以用来隔离内外网络。
    
        3) 实际上web 对象可能被缓存在从浏览器到原始服务器路径的多个地方, 服务器为每个响应的对象设定一个修改时间和有效时间, 对象到期前, 可以直接返回缓存对象, 到期之后,缓存会使用条件GET请求向原始服务器验证对象是否存在最新版, 若修改则返回新版本对象。

6.6 动态主机配置协议 DHCP (Dynamic Host Configuration Protocol)
        允许一台计算机加入新的网络和获取IP地址而不用手工参与,称为即插即用连网。

原理:

        DHCP 使用客户端/服务器方式。
    
        需要自动获取IP地址的主机启动时在本网用UDP广播发送一个DHCP发现报文,其目的IP地址为255.255.255.255，自己的IP 地址默认为全0。
    
        通过DHCP 中继代理转发DHCP发现报文。
    
        DHCP 服务器通过UDP回应DHCP中继代理一个DHCP提供报文, 包含IP地址等配置信息。
    
        DHCP 中继代理在将此DHCP提供报文发回给主机。

————————————————

                            版权声明：本文为博主原创文章，遵循 CC 4.0 BY-SA 版权协议，转载请附上原文出处链接和本声明。

原文链接：https://blog.csdn.net/s6664/article/details/131762041

前言
为了准备期末考试，同时也是为了之后复习方便，特对计算机网络的知识进行了整理。本篇内容大部分是来源于我们老师上课的ppt。而我根据自己的理解，将老师的PPT整理成博文的形式以便大家复习查阅，同时对于一些不是很清楚的地方，我去查阅了相关资料进行补充，当然也会有少部分个人看法夹带其中来帮助大家理解。

应评论要求这里放上本文的思维导图以供大家更好的查看


一、计算机网络概述
1 互联网的构成
网络边缘:位于互联网边缘与互联网相连的计算机和其他设备,如桌面计算机、移动计算机、服务器、其他智能终端设备
网络核心:由互联端系统的分组交换设备和通信链路构成的网状网络
如：分组交换路由器、链路层交换机、通信链路(光纤、铜缆、无线电、激光链路)

2.网络分类
个域网PAN（ Personal Area Network ）

能在便携式消费电器与通信设备之间进行短距离通信的网络
覆盖范围一般在10米半径以内，如蓝牙耳机等
局域网LAN（Local Area Network）

局部地区形成的区域网络，如企业网络
分布地区范围有限，可大可小，大到一栋建筑、小到办公室内的组网
电脑WLAN接入，打印机共享等等
城域网MAN（Metropolitan Area Network ）

范围覆盖一个城市的网络
广域网WAN（Wide Area Network）

覆盖很大地理区域，乃至覆盖地区和国家
3.接入网
接入网的用途

接入网的用途是将主机连接到边缘路由器上
边缘路由器是端系统Host去往任何其他远程端系统的路径上的第一台路由器
各种异构网络通过边缘路由器接入

接入网分类：

光纤到户FTTH
数字用户线DSL
同轴电缆
无线接入
企业和家庭网络
4.网络核心的两大功能
①路由
确定数据分组从源到目标所使用的路径（全局操作）

②转发
路由器或交换机将接收到的数据分组转发出去（即移动到该设备的某个输出接口）（本地操作）

5.网络分层
①OSI 7层模型


数据链路层 (Data Link Layer)

实现相邻（Neighboring）网络实体间的数据传输
成帧（Framing）：从物理层的比特流中提取出完整的帧
错误检测与纠正：为提供可靠数据通信提供可能
物理地址（MAC address）：48位，理论上唯一网络标识，烧录在网卡，不便更改
流量控制，避免“淹没”（overwhelming）:当快速的发送端遇上慢速的接收端，接收端缓存溢出
共享信道上的访问控制（MAC）：同一个信道，同时传输信号。如同：同一个Wifi热点（AP）连接着多个无线用户（手机），则多个用户同时需要发送数据，如何控制发送顺序？
网络层 (Network Layer)

将数据包跨越网络从源设备发送到目的设备（host to host）
路由（Routing）：在网络中选取从源端到目的端转发路径，常常会根据网络可达性动态选取最佳路径，也可以使用静态路由
路由协议：路由器之间交互路由信息所遵循的协议规范，使得单个路由器能够获取网络的可达性等信息
服务质量（QoS）控制：处理网络拥塞、负载均衡、准入控制、保障延迟
异构网络互联：在异构编址和异构网络中路由寻址和转发
传输层 (Transport Layer)

将数据从源端口发送到目的端口（进程到进程）
网络层定位到一台主机（host），传输层的作用域具体到主机上的某一个进程
网络层的控制主要面向运营商，传输层为终端用户提供端到端的数据传输控制
两类模式：可靠的传输模式，或不可靠传输模式
可靠传输：可靠的端到端数据传输，适合于对通信质量有要求的应用场景，如文件传输等
不可靠传输：更快捷、更轻量的端到端数据传输，适合于对通信质量要求不高，对通信响应速度要求高的应用场景，如语音对话、视频会议等
会话层 (Session Layer)

利用传输层提供的服务，在应用程序之间建立和维持会话，并能使会话获得同步
表示层（Presentation Layer）

关注所传递信息的语法和语义，管理数据的表示方法，传输的数据结构
应用层（Application Layer）

通过应用层协议，提供应用程序便捷的网络服务调用
②TCP/IP 4层模型


③两种模型比较


注：我们教材的是以下分层来讲述的


二、物理层
物理层考虑的是怎样才能在连接各种计算机的传输媒体上传输数据比特流，而不是指具体的传输媒体。
物理层的作用是要尽可能地屏蔽掉不同传输媒体和通信手段的差异。
用于物理层的协议也常称为物理层规程 (procedure)。
1.物理介质
①引导型介质
信号在固体介质中传播，例如铜、光纤、同轴电缆

光纤

高速运行
高速点对点传输（10-100 Gbps）
低错误率
中继器相距很远，对电磁噪声免疫

双绞线

两根绝缘铜线互相缠绕为一对
电话线为1对双绞线，网线为4对双绞线，广泛用于计算机网络（以太网）双向传输
第5类：100 Mbps~1 Gbps；第6类：10Gbps
传输距离一般为为100米


同轴电缆

两根同心铜导线，双向传输
电缆上的多个频率通道
带宽可达100Mbps
传输距离一般为200米


②非引导型介质
信号自由传播，例如无线电（陆地无线电、卫星无线电信道)

无线电

电磁频谱中各种“波段”携带的信号
没有物理“电线”
不依赖介质的广播
半双工（发送方到接收方）
无线链路类型

无线局域网（WiFi）
10-100 Mbps；10米
广域（如3/4/5G蜂窝）
在~10公里范围内
蓝牙：短距离，有限速率
地面微波：点对点；45 Mbps
同步卫星：36000km高空， 280毫秒的往返时延
低轨卫星：近地，但围绕地球高速运动，需要大量卫星才能覆盖地球
2.数据交换方式
①分组交换
分组交换采用把一个个小的数据包存储转发传输来实现数据交换。

主要的一些缺点：
1、不具有实时性。
2、存在延时。
3、会造成通信阻塞。
4、存在无用的重复数据。
5、会出现丢包的情况。

优点：
1、设计简单。
2、资源利用率很高。

②电路交换
电路连接的三个阶段：

1、建立连接。
2、数据传输。
3、释放连接。

优点：
1、传输速度快、高效。
2、实时。

缺点：
1、资源利用率低。
2、新建连接需要占据一定的时间，甚至比通话的时间还长。

电路交换的多路复用
频分多路复用FDM
时分多路复用TDM



3.信道复用
复用 (multiplexing) 是通信技术中的基本概念。
它允许用户使用一个共享信道进行通信，降低成本，提高利用率。

①频分复用
将整个带宽分为多份，用户在分配到一定的频带后，在通信过程中自始至终都占用这个频带。
频分复用的所有用户在同样的时间占用不同的带宽资源（请注意，这里的“带宽”是频率带宽而不是数据的发送速率）。


②时分复用
时分复用则是将时间划分为一段段等长的时分复用帧（TDM 帧）。每一个时分复用的用户在每一个 TDM 帧中占用固定序号的时隙。


③波分复用
波分复用就是光的频分复用。使用一根光纤来同时传输多个光载波信号。


④码分复用
各用户使用经过特殊挑选的不同码型，因此彼此不会造成干扰。

三、数据链路层
1.功能（要解决的问题）
成帧 （Framing）
将比特流划分成“帧”的主要目的是为了检测和纠正物理层在比特传输中可能出现的错误，数据链路层功能需借助“帧”的各个域来实现
差错控制 （Error Control）
处理传输中出现的差错，如位错误、丢失等
流量控制 （Flow Control）
确保发送方的发送速率，不大于接收方的处理速率，避免接收缓冲区溢出

2.数据链路层提供的服务
1.无确认 无连接 服务（ Unacknowledged connectionless ）

接收方不对收到的帧进行确认
适用场景：误码率低的可靠信道；实时通信；
网络实例：以太网
2.有确认 无连接 服务（ Acknowledged connectionless ）

每一帧都得到单独的确认
适用场景：不可靠的信道（无线信道）
网络实例：802.11
3.有确认 有连接 服务（ Acknowledged connection-oriented ）

适用场景：长延迟的不可靠信道
3.成帧（Framing）
3.1 要解决的关键问题：如何标识一个帧的开始？
接收方必须能从物理层接收的比特流中明确区分出一帧的开始和结束，这个问题被称为帧同步或帧定界
关键：选择何种定界符？定界符出现在数据部分如何处理？
3.2 成帧（framing）的方式
①带比特填充的定界符法
定界符：两个0比特之间，连续6个1比特，即01111110，0x7E

发送方检查有效载荷：若在有效载荷中出现连续5个1比特，则直接插入1个0比特


接收方的处理：
若出现连续5个1比特，
若下一比特为0，则为有效载荷，直接丢弃0比特；
若下一比特为1，则连同后一比特的0，构成定界符，一帧结束

②物理层编码违例
核心思想：选择的定界符不会在数据部分出现
4B/5B编码方案
4比特数据映射成5比特编码，剩余的一半码字（16个码字）未使用，可以用做帧定界符
例如： 00110组合不包含在4B/5B编码中，可做帧定界符
前导码
存在很长的 前导码（preamble），可以用作定界符
例如：传统以太网、802.11
曼切斯特编码 / 差分曼切斯特编码
正常的信号在周期中间有跳变，持续的高电平（或低电平）为违例码，可以用作定界符
例如：802.5令牌环网
4.差错控制
4.1 背景
链路层存在的一个问题：信道的噪声导致数据传输问题

差错（ incorrect ）：数据发生错误
丢失（ lost ）：接收方未收到
乱序（out of order）：先发后到，后发先到
重复（repeatedly delivery）：一次发送，多次接收
解决方案：差错检测与纠正、确认重传

确认：接收方校验数据（差错校验），并给发送方应答，防止差错
定时器：发送方启动定时器，防止丢失
顺序号：接收方检查序号，防止乱序递交、重复递交
4.2 差错检验与纠正
目标

保证一定差错检测和纠错能力的前提下，如何减少冗余信息量？

考虑的问题

信道的特征和传输需求
冗余信息的计算方法、携带的冗余信息量
计算的复杂度等
两种主要策略

检错码（error-detecting code）
在被发送的数据块中，包含一些冗余信息，但这些信息只能使接收方推断是否发生错误但不能推断哪位发生错误，接收方可以请求发送方重传数据主要用在高可靠、误码率较低的信道上，例如光纤链路偶尔发生的差错，可以通过重传解决差错问题

纠错码（error-correcting code)
发送方在每个数据块中加入足够的冗余信息，使得接收方能够判断接收到的数据是否有错，并能纠正错误（定位出错的位置）主要用于错误发生比较频繁的信道上，如无线链路也经常用于物理层，以及更高层（例如，实时流媒体应用和内容分发）使用纠错码的技术通常称为前向纠错（FEC，Forward Error Correction)

常用的检错码包括：

①奇偶检验 (Parity Check)
1位奇偶校验是最简单、最基础的检错码。

1位奇偶校验：增加1位校验位，可以检查奇数位错误。


②校验和 (Checksum)
主要用于TCP/IP体系中的网络层和传输层


③循环冗余校验 (Cyclic Redundancy Check，CRC)
数据链路层广泛使用的校验方法

CRC校验码计算方法

设原始数据D为k位二进制位模式
如果要产生n位CRC校验码，事先选定一个n+1位二进制位模式G (称为生成多项式，收发双方提前商定)，G的最高位为1
将原始数据D乘以2^n （相当于在D后面添加 n 个 0），产生k+n位二进制位模式，用G对该位模式做模2除，得到余数R（n位，不足n位前面用0补齐）即为CRC校验码


CRC校验码计算示例

D = 1010001101
n = 5
G = 110101 或 G = x5 + x4 + x2 + 1
R = 01110
实际传输数据：101000110101110

④汉明码
目标：以奇偶校验为基础，找到出错位置，提供1位纠错能力

给定n位待发送的数据，首先确定校验位的个数k（根据2^k≥k+n+1）
确定校验位在码流中的位置，2^i,i=0,1,2,……，得到校验位P_1,P_2,P_4,P_8,……
确定分组，即每个校验位分别负责哪些数据位
P_1负责位置号的二进制符合XXXX1形式的数据位，即1,3,5,7,9,……
P_2负责位置号的二进制符合XXX1X形式的数据位，即2,3,6,7,10,……
P_3负责位置号的二进制符合XX1XX形式的数据位，即4,5,6,7,12,13,14,15,……
基于偶校验确定每组的校验位（0或1）
注： 汉明码是采用奇偶校验的码。它采用了一种非常巧妙的方式，把这串数字分了组，通过分组校验来确定哪一位出现了错误。

实际的海明码编码的过程也并不复杂，我们通过用不同过的校验位，去匹配多个不同的数据组，确保任何一个数据位出错，都会产生一个多个校验码位出错的唯一组合。这样，在出错的时候，我们就可以反过来找到出错的数据位，并纠正过来。当只有一个校验码位出错的时候，我们就知道实际出错的是校验码位了。

5.流量控制
链路层存在的另一个问题：接收方的处理速率

接收方的接收缓冲区溢出
解决方案

基于反馈 (feedback-based) 的流量控制
接收方反馈，发送方调整发送速率
基于速率 (rate-based) 的流量控制
发送方根据内建机制，自行限速
6.媒体接入控制 MAC (Medium Access Control)子层
数据链路层分为两个子层：
MAC子层：介质访问
LLC子层：承上启下（弱层）


6.1 信道分配问题
① 时分多址接入-TDMA
TDMA: time division multiple access

按顺序依次接入并使用信道
每个用户使用固定且相同长度的时隙
某时隙轮到某用户使用时，该用户没有数据要发送，则该时隙被闲置
例子: 6-user LAN, 1,3,4时隙有数据发送, 2,5,6时隙被闲置


② 频分多址接入-FDMA
FDMA: frequency division multiple access

信道总频带被划分为多个相同宽度的子频带
每个用户占用一个子频带，不管用户是否有数据发送
例子: 6-user LAN, 1,3,4频带有数据发送, 2,5,6频带被闲置


6.2 多路访问协议


6.2.1 随机访问协议
特点：冲突不可避免

①ALOHA
纯ALOHA协议

原理：想发就发！

特点：

冲突：两个或以上的帧
随时可能冲突
冲突的帧完全破坏
破坏了的帧要重传
分隙ALOHA

分隙ALOHA是把时间分成时隙（时槽）
时隙的长度对应一帧的传输时间。
帧的发送必须在时隙的起点。
冲突只发生在时隙的起点

②载波侦听多路访问协议CSMA
特点：“先听后发”
改进ALOHA的侦听/发送策略分类


非持续式CSMA

1.特点
①经侦听，如果介质空闲，开始发送
②如果介质忙，则等待一个随机分布的时间，然后重复步骤①

2.好处
等待一个随机时间可以减少再次碰撞冲突的可能性

3.缺点
等待时间内介质上如果没有数据传送，这段时间是浪费的

持续式CSMA

p-持续式CSMA

1.特点

①经侦听，如介质空闲，那么以 p的概率 发送，以(1–p)的概率延迟一个时间单元发送
②如介质忙，持续侦听，一旦空闲重复①
③如果发送已推迟一个时间单元，再重复步骤①

1-持续式CSMA

1.特点
①经侦听，如介质空闲，则发送
②如介质忙，持续侦听，一旦空闲立即发送
③如果发生冲突，等待一个随机分布的时间再重复步骤①

2.好处：持续式的延迟时间要少于非持续式

3.主要问题：如果两个以上的站等待发送，一旦介质空闲就一定会发生冲突

4.注意
1-持续式是p-持续式的特例

6.2.2 受控访问协议


特点：克服了冲突

①位图协议（预留协议）




竞争期：在自己的时槽内发送竞争比特

举手示意
资源预留
传输期：按序发送

明确的使用权，避免了冲突
②令牌传递
令牌：发送权限

令牌的运行：发送工作站去抓取，获得发送权

除了环，令牌也可以运行在其它拓扑上，如令牌总线
发送的帧需要目的站或发送站将其从共享信道上去除；防止无限循环
缺点：令牌的维护代价



③二进制倒计数协议


站点：编序号，序号长度相同
竞争期：有数据发送的站点从高序号到低序号排队，高者得到发送权
特点：高序号站点优先

6.2.3 有限竞争协议
利用上述二者的优势

①自适应树搜索协议（Adaptive Tree Walk Protocol）
在一次成功传输后的第一个竞争时隙，所有站点同时竞争。
如果只有一个站点申请，则获得信道。
否则在下一竞争时隙，有一半站点参与竞争（递归），下一时隙由另一半站点参与竞争
即所有站点构成一棵完全二叉树。

6.3虚拟局域网VLAN
广播域（Broadcasting Domain）

广播域是广播帧能够到达的范围；
缺省情况下，交换机所有端口同属于一个广播域，无法隔离广播域；
广播帧在广播域中传播，占用资源，降低性能，且具有安全隐患。


VLAN是一个在物理网络上根据用途，工作组、应用等来逻辑划分的局域网络，与用户的物理位置没有关系。



通过路由器或三层交换机进行VLAN间路由，实现VLAN间通信。

VLAN类型

基于端口的VLAN


基于MAC地址的VLAN


基于协议的VLAN


基于子网的VLAN


6.4无线局域网WLAN
无线局域网（Wireless Local Area Network，WLAN)：指以无线信道作为传输介质的计算机局域网

基础架构模式（Infrastructure）


分布式系统（DS）
访问点（AP）
站点（STA）
基本服务集（BSS）
扩展服务集（ESS）
站点之间通信通过AP转发
自组织模式（Ad hoc）


站点（STA）
独立基本服务集（IBSS）
站点之间直接通信
共享同一无线信道
无线局域网需要解决的问题

1.有限的无线频谱带宽资源

通道划分、空间重用
提高传输速率，解决传输问题
提高抗干扰能力和保密性
2.共享的无线信道

介质访问控制方法（CSMA/CA）
可靠性传输、安全性
3.组网模式管理

BSS构建、认证、关联
移动性支持（漫游）
睡眠管理（节能模式）
四、网络层
1.网络层概述
网络层在数据链路层提供的两个相邻端点之间的数据帧的传送功能上，进一步管理网络中的数据通信，将数据设法从源端经过若干个中间节点传送到目的端，从而向运输层提供最基本的端到端的数据传送服务。


2.网络层关键功能
路由（控制面）
选择数据报从源端到目的端的路径
核心：路由算法与协议
转发（数据面）
将数据报从路由器的输入接口传送到正确的输出接口
3.Internet网际协议
3.1 IPv4协议及其相关技术
3.1.1 基本概念
IPv4协议，网际协议版本4，一种无连接的协议，是互联网的核心，也是使用最广泛的网际协议版本，其后继版本为IPv6

internet协议执行两个基本功能

寻址(addressing)
分片(fragmentation)
3.1.2 IPv4数据报格式


版本： 4bit ，表示采用的IP协议版本
首部长度： 4bit，表示整个IP数据报首部的长度
区分服务： 8bit ，该字段一般情况下不使用
总长度： 16bit ，表示整个IP报文的长度,能表示的最大字节为2^16-1=65535字节
标识： 16bit ， IP软件通过计数器自动产生，每产生1个数据报计数器加1；在ip分片以后，用来标识同一片分片
标志： 3bit，目前只有两位有意义。
MF，置1表示后面还有分片，置0表示这是数据报片的最后1个；
DF，不能分片标志，置0时表示允许分片
片偏移： 13bit，表示IP分片后，相应的IP片在总的IP片的相对位置
生存时间TTL(Time To Live) ：8bit,表示数据报在网络中的生命周期，用通过路由器的数量来计量，即跳数（每经过一个路由器会减1）
协议：8bit，标识上层协议（TCP/UDP/ICMP…）
首部校验和：16bit ，对数据报首部进行校验，不包括数据部分
源地址：32bit，标识IP片的发送源IP地址
目的地址：32bit，标识IP片的目的地IP地址
选项：可扩充部分，具有可变长度，定义了安全性、严格源路由、松散源路由、记录路由、时间戳等选项
填充：用全0的填充字段补齐为4字节的整数倍
3.1.3 数据报分片
分片原因

数据报长度大于传输链路的MTU

MTU（Maximum Transmission Unit）, 最大传输单元

链路MTU
路径MTU (Path MTU)
分片策略

允许途中分片：根据下一跳链路的MTU实施分片
不允许途中分片：发出的数据报长度小于路径MTU（路径MTU发现机制）
重组策略

途中重组，实施难度太大
目的端重组（互联网采用的策略）
重组所需信息：原始数据报编号、分片偏移量、是否收集所有分片



IPv4分片策略

IPv4分组在传输途中可以多次分片
源端系统，中间路由器（可通过标志位设定是否允许路由器分片，DF标志位）
IPv4分片只在目的IP对应的目的端系统进行重组
IPv4分片、重组字段在基本IP头部
标识、标志、片偏移
IPv6分片机制有较大变化（见IPv6部分的介绍）
注：分组 (packet) 与 帧(frame)的关系



3.1.4 IP协议功能及报头字段总结
网络层基本功能

支持多跳寻路将IP数据报送达目的端：目的IP地址
表明发送端身份：源IP地址
根据IP头部协议类型，提交给不同上层协议处理：协议
其它相关问题

数据报长度大于传输链路的MTU的问题，通过分片机制解决：标识、标志、片偏移
防止循环转发浪费网络资源（路由错误、设备故障…），通过跳数限制解决：生存时间TTL
IP报头错误导致无效传输，通过头部机校验解决：首部校验和
3.2 IP地址
3.2.1 概述
IP地址，网络上的每一台主机（或路由器）的每一个接口都会分配一个全球唯一的32位的标识符

将IP地址划分为固定的类，每一类都由两个字段组成

网络号相同的这块连续IP地址空间称为地址的前缀，或网络前缀

IP地址共分为A、B、C、D、E五类，A类、B类、C类为单播地址

IP地址的书写采用点分十进制记法，其中每一段取值范围为0到255



IP特殊地址


3.2.1 子网划分
子网划分(subnetting)，在网络内部将一个网络块进行划分以供多个内部网络使用，对外仍是一个网络
子网(subnet )，一个网络进行子网划分后得到的一系列结果网络称为子网
子网掩码(subnet mask )，与 IP 地址一一对应，是32 bit 的二进制数，置1表示网络位，置0表示主机位
子网划分减少了 IP 地址的浪费、网络的组织更加灵活、便于维护和管理



3.2.3 无类域间路由
将32位的IP地址划分为前后两个部分，并采用斜线记法，即在IP地址后加上“/”，然后再写上网络前缀所占位数


一个 CIDR 地址块可以表示很多地址，这种地址的聚合常称为路由聚合（route aggregation），也称为构成超网 (supernet)
聚合技术在Internet中大量使用，它允许前缀重叠，数据包按具体路由的方向发送，即具有最少IP地址的最长匹配前缀
注：当路由器收到一个IP数据包时，它会将数据包的目的IP地址与自己本地路由表中的所有路由表进行逐位（Bit-By-Bit）对比，直到找到匹配度最长的条目，这就是最长前缀匹配机制。（路由比对之前会用相应路由的目的网络掩码进行逻辑与运算，再拿结果与路由路径比对）

3.3 DHCP动态主机配置协议
DHCP ：动态主机配置协议

当主机加入IP网络，允许主机从DHCP服务器动态获取IP地址
可以有效利用IP地址，方便移动主机的地址获取
工作模式：客户/服务器模式（ C/S ）
基于 UDP 工作，服务器运行在 67 号端口， 客户端运行在 68 号端口



DHCP 客户从UDP端口68以广播形式向服务器发送发现报文（DHCPDISCOVER）
DHCP 服务器广播发出提供报文（DHCPOFFER）
DHCP 客户从多个DHCP服务器中选择一个，并向其以广播形式发送DHCP请求报文（DHCPREQUEST）
被选择的DHCP服务器广播发送确认报文（DHCPACK）
3.4 ARP地址解析协议
背景
网络设备有数据要发送给另一台网络设备时，必须要知道对方的网络层地址（即IP地址）。IP地址由网络层来提供，但是仅有IP地址是不够的，IP数据报文必须封装成帧才能通过数据链路进行发送。数据帧必须要包含目的MAC地址，因此发送端还必须获取到目的MAC地址。通过目的IP地址二获取的MAC地址的过程是由ARP（Address Resolution Protocol）协议来实现的。

注：因为下层协议是通过MAC地址来确定各自身份的，所以下层发送必须要MAC地址

IP 与 MAC地址


ARP协议工作过程


A已知B的IP地址，需要获得B的MAC地址（物理地址）
如果A的ARP表中缓存有B的IP地址与MAC地址的映射关系，则直接从ARP表获取
如果A的ARP表中未缓存有B的IP地址与MAC地址的映射关系，则A广播包含B的IP地址的ARP query分组
在局域网上的所有节点都可以接收到ARP query
B接收到ARP query分组后，将自己的MAC地址发送给A
A在ARP表中缓存B的IP地址和MAC地址的映射关系
超时时删除
路由到另一个局域网


A创建IP数据包（源为A、目的为E）
在源主机A的路由表中找到路由器R的IP地址223.1.1.4
A根据R的IP地址223.1.1.4，使用ARP协议获得R的MAC地址
A创建数据帧（目的地址为R的MAC地址）
数据帧中封装A到E的IP数据包
A发送数据帧，R接收数据帧
3.5 网络地址转换(NAT)
定义
网络地址转换(NAT)用于解决IPv4地址不足的问题，是一种将私有（保留）地址转化为公有IP地址的转换技术

私有IP地址：
A类地址：10.0.0.0–10.255.255.255
B类地址：172.16.0.0–172.31.255.555
C类地址：192.168.0.0–192.168.255.255

NAT工作机制


出数据报：外出数据报用 NAT IP地址(全局), 新port # 替代 源IP地址(私有), port #

NAT转换表：每个 (源IP地址, port #)到(NAT IP地址, 新port #) 映射项

入数据报：对每个入数据报的地址字段用存储在NAT表中的(源IP地址, port #)替代对应的 (NAT IP地址, 新port #)

NAT根据不同的IP上层协议进行NAT表项管理
TCP，UDP，ICMP

传输层TCP/UDP拥有16-bit 端口号字段
所以一个WAN侧地址可支持60,000个并行连接

NAT的优势

节省合法地址，减少地址冲突
灵活连接Internet
保护局域网的私密性
3.6 ICMP: 互联网控制报文协议
ICMP: 互联网控制报文协议

ICMP 允许主机或路由器报告差错情况和提供有关异常情况的报告
由主机和路由器用于网络层信息的通信
ICMP 报文携带在IP 数据报中： IP上层协议号为1
ICMP报文类型

ICMP 差错报告报文
终点不可达：不可达主机、不可达网络，无效端口、协议
ICMP 询问报文
回送请求/回答 (ping使用)
ICMP 报文格式


ICMP报文的前 4 个字节包含格式统一的三个字段：类型、代码、检验和
相邻的后四个字节内容与ICMP的报文类型有关
ICMP报文类型及功能


4.路由算法
路由算法须满足的特性：

正确性
简单性
鲁棒性
稳定性
公平性
有效性
根据路由算法是否随网络的通信量或拓扑自适应划分

静态路由选择策略（非自适应路由选择）
动态路由选择策略（自适应路由选择）
4.1 距离向量路由
算法基本思想

每个节点周期性地向邻居发送它自己到某些节点的距离向量；

当节点x接收到来自邻居的新DV估计，它使用B-F方程更新其自己的DV :
Dx(y) ← minv{c(x,v) + Dv(y)} for each node y ∊ N

上述过程迭代执行，Dx(y)收敛为实际最小费用 dx(y)

距离向量算法特点：迭代的、分布式的

每次本地迭代由下列引起: 本地链路费用改变、邻居更新报文
分布式:各节点依次计算，相互依赖
注：路由器只掌握物理相连的邻居以及链路费用

算法过程
路由器启动时初始化自己的路由表

初始路由表包含所有直接相连的网络路径，距离均为0

路由器周期性地向其相邻路由器广播自己知道的路由信息

相邻路由器可以根据收到的路由信息修改和刷新自己的路由表


路由器经过若干次更新后，最终都会知道到达所有网络的最短距离

所有的路由器都得到正确的路由选择信息时网络进入“收敛”（convergence）状态



特殊情况考虑
计数到无穷问题（The Count-to-Infinity Problem）







好消息传播快，坏消息传播慢，是距离向量路由的一个主要缺点

4.2 链路状态路由
注：所有路由器掌握完整的网络拓扑和链路费用信息

算法过程
链路状态（Link State）路由可分为五个部分：

发现邻居，了解他们的网络地址；


设置到每个邻居的成本度量；

开销/度量/代价：
自动发现设置或人工配置
度量：带宽、跳数、延迟、负载、可靠性等
常用度量：链路带宽（反比）
例如：1-Gbps以太网的代价为1，100-Mbps以太网的代价为10
可选度量：延迟
发送一个echo包，另一端立即回送一个应答
通过测量往返时间RTT，可以获得一个合理的延迟估计值
构造一个分组，分组中包含刚收到的所有信息；
构造链路状态分组（link state packet，LSP）

发送方标识
序列号
年龄
邻居列表


将此分组发送给其他的路由器；
每个LSP分组包含一个序列号，且递增
路由器记录所收到的所有（源路由器、序列号）对
当一个新分组到达时，路由器根据记录判断：
如果是新分组，洪泛广播
如果是重复分组，丢弃
如果是过时分组，拒绝
计算到其他路由器的最短路径。
Dijkstra算法示例
D(k)：从计算节点到目的节点k当前路径代价
p(k)：从计算节点到目的节点k的路径中k节点的前继节点



距离向量和链路状态算法比较
网络状态信息交换的范围

DV:邻居间交换
LS:全网扩散
网络状态信息的可靠性

DV:部分道听途说
LS:自己测量
4.3 层次路由
产生原因

过于庞大的路由表存储、查找困难，路由信息交互开销高
现实情况：

地址分配往往是随机的，难以进行高效的地址聚合
每个网络的网络管理员有自己的管理方法和思路，并不希望每个路由器都干涉本网络内部的地址分配等问题
层次路由可以解决：

网络扩展性问题：当网络扩大时，控制路由表条目和路由表存储空间的增长
管理的自治问题：网络管理员可以控制和管理自己网络的路由
基本思路

互联网由大量不同的网络互连，每个管理机构控制的网络是自治的

自治系统（AS，Autonomous System）

一个管理机构控制之下的网络
一个AS内部通常使用相同的路由算法/路由协议，使用统一的路由度量（跳数、带宽、时延 …）
不同的AS可以使用不同的路由算法/路由协议
每个AS有一个全球唯一的ID号：AS ID
自治系统内的还可以进一步划分层次：私有自治系统或区域

效果


4.4 广播路由
广播（Broadcasting）：源主机同时给全部目标地址发送同一个数据包

实现方法
①给每个主机单独发送一个数据包

效率低、浪费带宽
Server需要知道每个目的地址
②多目标路由（multi-destination routing）

在需要转发的路由器线路复制一次该数据报
网络利用率高
Server依然需要知道所有的目的地址
注：以上方法难以实现

③泛洪（flooding）

一种将数据包发送到所有网络节点的简单方法
将每个进入数据包发送到除了进入线路外的每条出去线路
用途

保证性：一种有效广播手段，可确保数据包被传送到网络中每个节点
鲁棒性：即使大量路由器被损坏，也能找到一条路径（如果存在）
简单性：仅需知道自己的邻居
无控制的泛洪

实现广播最显而易见的技术
环路可能导致广播风暴
路由器可能收到多个副本
节点需要跟踪已泛洪的数据包以阻止洪泛
即使利用跳数来限制，也会出现成倍爆炸
解决方法：受控制的泛洪（每个路由器进行有选择的泛洪）

序号控制泛洪
逆向路径转发
④生成树（spanning tree）

源节点向所有属于该生成树的特定链路发送分组
改进了逆向路径转发
没有环路
最佳使用带宽
最少副本，消除了冗余分组
一个路由器可以不必知道整颗树，只需要知道在一颗树中的邻居即可


5.Internet路由协议
5.1 路由选择协议RIP
概述

路由选择协议RIP（ Routing Information Protocol）是基于距离矢量算法的协议
使用跳数衡量到达目的网络的距离
RIP 认为一个好的路由就是它通过的路由器的数目少，即“距离短”
RIP 允许一条路径最多只能包含 15 个路由器
RIP协议的基本思想
仅和相邻路由器交换信息
路由器交换的内容是自己的路由表
周期性更新：30s
工作过程

初始化


周期性更新

小结

RIP协议的特点

算法简单，易于实现
收敛慢
需要交换的信息量较大
RIP协议的适用场合

中小型网络
RIP协议的防环路机制

触发更新
毒性反转
水平分割
其他
5.2 BGP-外部网关路由协议
路由协议

内部网关协议 IGP： 有 RIP 和、OSPF、ISIS 等多种具体的协议
外部网关协议 EGP：目前使用的协议就是 BGP
边界网关协议BGP (Border Gateway Protocol)

目前互联网中唯一实际运行的自治域间的路由协议
BGP功能

eBGP：从相邻的AS获得网络可达信息
iBGP： 将网络可达信息传播给AS内的路由器
基于网络可达信息和策略决定到其他网络的“最优”路由
BGP会话: 两个BGP路由器通过TCP连接交换BGP报文

通告到不同网络前缀的路径，即路径向量协议
BGP路径通告


AS2的路由器2c从AS3的路由器3a接收到路径AS3, X
根据AS2的策略，AS2的路由器2c接受路径AS3, X，通过iBGP传播给AS2的所有路由器
根据AS2策略，AS2的路由器2a通过eBGP向AS1的路由器1c通告从AS3的路由器3a接收到路径AS2, AS3, X


路由器可能会学到多条到达目的网络的路径:

AS1的路由器1c从2a学到路径AS2, AS3, X
AS1的路由器1c从3a学到路径AS3, X
由策略，AS1路由器1c可能选择路径AS3, X, 并在AS1中通过iBGP通告路径
6.路由器的工作原理
6.1 路由器概述
路由器是互联网最主要的网络设备，包含2个核心功能

控制层：运行各种路由协议：BGP、OSPF、RIP，学习去往不同目的的转发路径：路由表
数据层：根据上述路由表，将收到的IP分组转发到正确的下一跳链路


6.2 路由器控制层
路由器可同时运行多个路由协议
路由器也可不运行任何路由协议，只使用静态路由和直连路由
路由管理根据路由优先级，选择最佳路由，形成核心路由表
控制层将核心路由表下发到数据层，形成转发表（FIB）
若存在多个“去往同一目的IP前缀”的不同类型路由，路由器根据优先级选择最佳路由
优先级数值越小，优先级越高

6.3 路由器数据层
路由器中IP报文转发核心功能

链路层解封装，IP头部校验
获取报文目的IP地址
用目的IP地址，基于最长前缀匹配规则查询转发表
查询失败，丢弃报文
查询成功
获取转发出接口和下一跳IP地址
IP头部“TTL”字段值减1，重新计算IP头部“校验和”
重新进行链路层封装，发送报文
注：普通IP报文转发过程中，路由器不查看传输层及以上层协议的内容

IP报文在路由器转发前后的变化

链路层封装更新，IP头部“TTL”减1，IP头部“校验和”更新
数据报在不同硬件单元的处理

报文输入的接口卡
链路层解封装
转发表查询（该工作在输入接口卡处理）
通过交换结构将报文排队发往目的接口卡（发送过快将产生拥塞）
交换结构
从输入接口卡发往输出接口卡
报文输出的接口卡
从交换结构接收报文（排队进行后续处理，到达太快将产生拥塞）
链路层封装
从输出接口发送报文
3种典型的交换结构



7.拥塞控制算法
7.1 概述
拥塞
网络中存在太多的数据包导致数据包传输延迟或丢失，从而导致网络吞吐量下降

拥塞控制（congestion control）
需要确保通信子网能够承载用户提交的通信量，是一个全局性问题，涉及主机、路由器等多种因素

产生拥塞的原因

主机发送到网络的数据包数量过多，超过了网络的承载能力
突发的流量填满了路由器的缓冲区，造成某些数据包会被丢弃
拥塞控制的基本策略

开环控制----事先对通信流参数进行协商，协商后，不管网络是拥塞还是带宽充足，参数不能动态改变
开环控制属于预防性拥塞控制，它竭力使网络总是处于无拥塞状态运行。开环控制的方法包括决定什么时候接受新流量，什么时候丢弃数据包和丢弃哪些数据包。其缺点是没有考虑网络的当前状态
闭环控制—根据网络状态进行动态控制，包括两部分：反馈机制和控制机制。闭环控制方法分为两个子类：显式反馈与隐式反馈
7.2 流量调节
抑制包(Choke Packets)：用于通知发送方减小发送量，路由器选择一个被拥塞的数据包，给该数据包的源主机返回一个抑制包，抑制包中的目的地址取自该拥塞数据包。源主机收到抑制包后，减少发向特定目的地址的流量
逐跳的抑制包(Hop-by-Hop Choke Packets)：在高速或长距离网络中，由于源主机响应太慢，抑制包算法对拥塞控制的效果并不好，可采用逐跳抑制方法；其核心思想是抑制包对它经过的每个路由器都起作用，能够迅速缓解发生拥塞处的拥塞，但要求上游路由器有更大的缓冲区
显式拥塞通告（ECN，Explicit Congestion Notification），在IP包头中记录数据包是否经历了拥塞。在数据包转发过程中，路由器可以在包头中标记为经历拥塞，然后接收方在它的下一个应答数据包里显示该标记作为显式拥塞信号
RFC2474中重新定义TOS域为包含一个6位的区分服务码点(DSCP) 和2位未使用位；RFC3168重新定义RFC2474中TOS域未使用的两位为ECN域，包含如下值：
00：发送主机不支持ECN
01或者10：发送主机支持ECN
11：路由器正在经历拥塞
7.3 随机早期检测RED (Random Early Detection)
使路由器的队列维持两个参数，即队列长度最小门限 THmin 和最大门限 THmax
RED 对每一个到达的数据报都先计算平均队列长度 LAV
若平均队列长度小于最小门限 THmin ，则将新到达的数据报放入队列进行排队
若平均队列长度超过最大门限 THmax，则将新到达的数据报丢弃
若平均队列长度在最小门限 THmin 和最大门限THmax 之间，则按照某一概率 p 将新到达的数据报丢弃
RED 将路由器的到达队列划分成为三个区域

丢弃概率 p 与 THmin 和 Thmax 的关系

当 LAV <Thmin 时，丢弃概率 p = 0
当 LAV >Thmax 时，丢弃概率 p = 1
当 THmin < LAV < THmax时， 0  p  1
例如，按线性规律变化，从 0 变到 pmax
8.服务质量
8.1概述
问题的提出

互联网本身只能提供“尽力而为的服务”或称“尽最大努力交付的服务”
当互联网越来越多的用于传输多媒体信息时，由于这些实时业务对网络的传输延时、延时抖动等特性较为敏感，这样网络的传输质量就难以保障了
IP网络不能保证特定业务的QoS要求，已经成为IP网络发展的巨大障碍
网络的服务质量越来越多的引起人们的关注，甚至成为网络技术研究的热点问题
什么是网络服务质量？（QoS, Quality of Service）

QoS是网络在传输数据流时要满足一系列服务请求，具体可以量化为带宽、时延、抖动、丢包率等性能指标

8.2 流量整形
流量整形(traffic shaping)：其作用是限制流出某一网络的某一连接的流量与突发，使这类报文以比较均匀的速度向外发送

①漏桶算法
到达的数据包（网络层的PDU）被放置在底部具有漏孔的桶中（数据包缓存）
漏桶最多可以排队b个字节，漏桶的这个尺寸受限于内存。如果数据包到达的时候漏桶已经满了，那么数据包应被丢弃
数据包从漏桶中漏出，以常量速率（r字节/秒）注入网络，因此平滑了突发流量


②令牌桶算法
产生令牌：周期性的以速率r向令牌桶中增加令牌，桶中的令牌不断增多。如果桶中令牌数已到达上限，则丢弃多余令牌
消耗令牌：输入数据包会消耗桶中的令牌。在网络传输中，数据包的大小通常不一致。大的数据包相较于小的数据包消耗的令牌要多
判断是否通过：输入数据包经过令牌桶时存在两种可能：输出该数据包或者被丢弃。当桶中的令牌数量可以满足数据包对令牌的需求，则将数据包输出，否则将其丢弃
注：漏桶算法和令牌桶算法的区别在于漏桶算法输出的流量永远不可能超过一定限制，而令牌桶算法可以容忍短时间内的高流量输出，对于一些突发流量的需求比较友好

8.3 数据包调度
在同一个流的数据包之间以及在竞争流之间分配路由器资源的算法称为包调度算法，它负责分配带宽和其他路由器资源，负责确定把缓冲区中的哪些数据包发送到输出链路上

先来先服务FCFS（First-Come First-Serve）
公平队列算法（Fair Queueing/Round Robin）
加权公平队列算法（Weighted Fair Queueing）
优先级调度（Priority Scheduling）
9.三层交换
9.1 三层交换的技术背景
二层交换网络中的广播，限制了网络规模的扩展
交换机对目标地址无法匹配的数据帧进行广播转发
交换机对目标地址为广播地址的数据帧进行广播转发
交换机为维护生成树状态产生大量的桥协议数据单元(Bridge Protocol Data Unit，BPDU)
这些广播帧会大量消耗网络资源，并频繁影响用户的数据通信
VLAN虽然可以将广播的影响限定在一定范围内，但同时也隔离了正常的用户间数据通信
传统路由器致力于解决VLAN间互联互通，但是其转发效率和拓扑复杂性带来的网络通信瓶颈无法有效应对规模扩展
9.2 三层交换的动机
利用第三层协议中的信息来加强第二层交换功能，形成带有路由功能的交换
融合VLAN 间的二层隔离和三层互通，消除大规模网络中广播对性能的影响
简化网络配置，简化网络拓扑，优化网络管理，降低网络部署成本


9.3 三层交换机的工作原理


10.虚拟专用网VPN (Virtual Private Network)
10.1 VPN的技术背景
计算机网络按用途分类
专用、公用
专用网络的实现方式
使用专用链路：铺设、租用（费用高，不灵活）
使用公共链路：不安全
虚拟专用网VPN (Virtual Private Network)
专用网络的经济、可靠、灵活的解决方案
利用安全隧道技术将专用网络在公共网络上扩展
VPN的设计原则
安全性、隧道与加密、数据验证、用户验证、防火墙与攻击检测
10.2 VPN的原理
VPN指利用公用网络架设专用网络的远程访问技术
VPN通过隧道技术在公共网络上模拟出一条点到点的逻辑专线，从而达到安全数据传输的目的




VPN对数据机密性和完整性的保护

10.3 VPN的实现方式
用VPN连接合作伙伴


用VPN实现专用网络的远程访问


11.IPv6协议
初始动机：应付“32-bit地址空间耗尽”问题（CIDR和NAT都无法从根本上解决地址短缺问题），增加地址空间
IPv6 地址

地址长度为128bit，是IPv4地址长度的4倍
IPv6地址空间数量约为3*1038
IPv6地址表示法，冒分十六进制，x : x : x : x : x : x : x : x
简化方法：每个x前面的0可省略，可把连续的值为0的x表示为“::”, 且“::”只能出现1次
简化前地址，2001:0DA8:0000:0000:200C:0000:0000:00A5
简化后地址，2001:DA8:0000:0000:200C::A5
五、传输层
1.传输层概述
传输层位于应用层和网络层之间：
基于网络层提供的服务，向分布式应用程序提供通信服务
按照因特网的“端到端”设计原则：
应用程序只运行在终端上，即不需要为网络设备编写程序
站在应用程序的角度：
传输层应提供进程之间本地通信的抽象：即运行在不同终端上的应用进程仿佛是直接连在一起的
1.1 套接字
设想在应用程序和网络之间存在一扇“门”：
需要发送报文时：发送进程将报文推到门外
门外的运输设施（因特网）将报文送到接收进程的门口
需要接收报文时：接收进程打开门，即可收到报文
在TCP/IP网络中，这扇“门”称为套接字（socket），是应用层和传输层的接口，也是应用程序和网络之间的API
1.2 传输层提供的服务
因特网的网络层提供“尽力而为”的服务：
网络层尽最大努力在终端间交付分组，但不提供任何承诺
具体来说，不保证交付，不保证按序交付，不保证数据完整，不保证延迟，不保证带宽等
传输层的有所为、有所不为:
传输层可以通过差错恢复、重排序等手段提供可靠、按序的交付服务
但传输层无法提供延迟保证、带宽保证等服务
1.3 因特网传输层提供的服务
最低限度的传输服务：
将终端-终端的数据交付扩展到进程-进程的数据交付
报文检错
增强服务：
可靠数据传输
流量控制
拥塞控制
因特网传输层通过UDP协议和TCP协议，向应用层提供两种不同的传输服务：
UDP协议：仅提供最低限度的传输服务
TCP协议：提供基础服务和增强服务
2.传输层基本服务——复用和分用
2.1 复用和分用概述
传输层基本服务：将主机间交付扩展到进程间交付，通过复用和分用实现


复用：
发送方传输层将套接字标识置于报文段中，交给网络层
分用：
接收方传输层根据报文段中的套接字标识，将报文段交付到正确的套接字
2.2 套接字标识与端口号
端口号是套接字标识的一部分：
每个套接字在本地关联一个端口号
端口号是一个16比特的数
端口号的分类：
熟知端口：0～1023，由公共域协议使用
注册端口：1024～49151，需要向IANA注册才能使用
动态和/或私有端口：49152～65535，一般程序使用
报文段中有两个字段携带端口号
源端口号：与发送进程关联的本地端口号
目的端口号：与接收进程关联的本地端口号

2.3 TCP/UDP套接字（复用和分用）
UDP套接字

使用<IP地址，端口号>二元组标识UDP套接字
服务器使用一个套接字服务所有客户
TCP套接字
使用<源IP地址，目的IP地址，源端口号，目的端口号> 四元组标识连接套接字
服务器使用一个监听套接字和多个连接套接字服务多个客户，每个连接套接字服务一个客户
3.无连接传输：UDP
3.1 UDP报文段结构
UDP报文：
报头：携带协议处理需要的信息
载荷（payload）：携带上层数据
用于复用和分用的字段：
源端口号
目的端口号
用于检测报文错误的字段：
报文总长度
校验和（checksum）


3.2 UDP校验和（checksum）
校验和字段的作用: 对传输的报文段进行检错
以下是报文段的字段

key	human	hex
Source	192.168.1.106	c0a8 016a
Destination	11.111.111.111	0b6f 6f6f
Protocol	UDP(17)	11
Length	17	11
Source Port	63549	f83d
Destination Port	12345	3039
Length	17	11
Checksum	0xb12d	b12d
Data	hello UDP	6865 6c6c 6f20 5544 5000
将上表中所有的 16 进制数加起来，之后取反码。有一点需要注意的是，如果遇到最高位进位，那么需要对结果进行回卷，意思是



求出来的即是校验和。

3.3 为什么需要UDP？
为什么需要UDP？

应用可以尽可能快地发送报文：
无建立连接的延迟
不限制发送速率（不进行拥塞控制和流量控制）
报头开销小
协议处理简单
UDP适合哪些应用？

容忍丢包但对延迟敏感的应用：
如流媒体
以单次请求/响应为主的应用：
如DNS
若应用要求基于UDP进行可靠传输：
由应用层实现可靠性
4.面向连接的传输：TCP
4.1 可靠传输
数据包有序、无差错到达接收端

如何实现可靠传输，基本原则是什么？

利用ACK确认
重传机制
差错检测
可靠传输实现举例-Stop and Wait

注：该实现俗称tcp的三次握手和四次挥手。三次挥手我们也常称为“请求 -> 应答 -> 应答之应答”的三个回合，主要就是为了建立连接

建立一条TCP连接需要确定两件事：

双方都同意建立连接（知晓另一方想建立连接）
初始化连接参数（序号，MSS等）

四次挥手：目的就是确保断开连接时双方都是确认结束的状态



4.2 流水线技术
由于信道上一直有数据不间断地传送，这种传输方式可获得很高的信道利用率。


①GBN 协议（回退 N 步协议）
发送窗口
发送方维持的发送窗口，它的意义是：位于发送窗口内的分组都可连续发送出去，而不需要等待对方的确认。这样，信道利用率就提高了。
发送方每收到一个确认，就把发送窗口向前滑动一个分组的位置。


累积确认

接收方一般采用累积确认的方式。即不必对收到的分组逐个发送确认，而是对按序到达的最后一个分组发送确认，这样就表示：到这个分组为止的所有分组都已正确收到了。
优点：容易实现，即使确认丢失也不必重传。
缺点：不能向发送方反映出接收方已经正确收到的所有分组的信息。
如果发送方发送了前 5 个分组，而中间的第 3 个分组丢失了。这时接收方只能对前两个分组发出确认。发送方无法知道后面三个分组的下落，而只好把后面的三个分组都再重传一次。
这就叫做 Go-back-N（回退 N），表示需要再退回来重传已发送过的 N 个分组。
可见当通信线路质量不好时，连续 ARQ 协议会带来负面的影响。

②SR 协议（选择重传协议）
SR 协议在 GBN 协议的基础上进行了改进，它通过让发送方仅重传那些它怀疑在接收方出错（即丢失或受损）的分组而避免了不必要的重传。选择重传协议只重传真正丢失的分组。

选择重传的接收窗口与发送窗口一样大
选择重传协议允许与接收窗口一样多的分组失序到达,并保存这些失序到达的分组,直到连续的一组分组被交付给应用层。
标记发出分组,当ACK=Sf 时,将窗口滑过所有连续的已确认的分组
如果还有未确认的分组,则重发所有检测到的未被确认的分组并重启计时器
如果所有分组都被确认了则停止计时器
确认，确认号(ACK)只定义完好接收的那一个分组的序号,并不反馈任何其他分组的信息
注：SR协议ack确认和GBN的累计确认不同，是一个一个确认

计时器
理论上选择重传协议要为每个分组使用一个计时器。当某个计时器超时后,只有相应的分组被重传。换而言之，返回N协议将所有的分组当做一个整体对待，而选择重传协议则分别对待每一个分组。但是大多数SR的运输层仅使用了一个计时器.。注意只使用一个计时器而做到跟踪所有发出去的分组的情况的做法是：标记发出分组,当ACK=Sf 时,将窗口滑过所有连续的已确认的分组，如果还有未确认的分组，则重发所有检测到的未被确认的分组并重启计时器，如果所有分组都被确认了则停止计时器。

快速重传

仅靠超时重发丢失的报文段，恢复太慢！

发送方可利用重复ACK检测报文段丢失：

发送方通常连续发送许多报文段
若仅有个别报文段丢失，发送方将收到多个重复序号的ACK
多数情况下IP按序交付分组，重复ACK极有可能因丢包产生
TCP协议规定： 当发送方收到对同一序号的3次重复确认时，立即重发包含该序号的报文段

所谓快速重传，就是在定时器到期前重发丢失的报文段

③TCP 可靠通信的具体实现
TCP 连接的每一端都必须设有两个窗口——一个发送窗口和一个接收窗口。
TCP 的可靠传输机制用字节的序号进行控制。TCP 所有的确认都是基于序号而不是基于报文段。
TCP 两端的四个窗口经常处于动态变化之中。
TCP连接的往返时间 RTT 也不是固定不变的。需要使用特定的算法估算较为合理的重传时间
GBN、SR和TCP小结
Go-Back-N协议
接收方：

使用累积确认
不缓存失序的分组
对失序分组发送重复ACK
发送方：

超时后重传从基序号开始的所有分组
SR
接收方：

缓存失序的分组
单独确认每个正确收到的分组
发送方：

每个分组使用一个定时器
仅重传未被确认的分组
TCP协议

接收方：

使用累积确认
缓存失序的报文段
对失序报文段发送重复ACK
增加了推迟确认
发送方：

超时后仅重传最早未确认的报文段
增加了快速重传
4.3 TCP报文段结构


最大段长度（MSS）：
TCP段中可以携带的最大数据字节数
建立连接时，每个主机可声明自己能够接受的MSS，缺省为536字节
窗口比例因子（window scale）：
建立连接时，双方可以协商一个窗口比例因子
实际接收窗口大小 = window size * 2^window scale
选择确认（SACK）：
最初的TCP协议只使用累积确认
改进的TCP协议引入选择确认，允许接收端指出缺失的数据字节
发送序号和确认序号的含义

5.TCP流量控制
TCP接收端

使用显式的窗口通告，告知发送方可用的缓存空间大小
在接收窗口较小时，推迟发送确认
仅当接收窗口显著增加时，通告新的窗口大小
TCP发送端

使用Nagle算法确定发送时机
使用接收窗口限制发送的数据量，已发送未确认的字节数不超过接收窗口的大小
Nagle算法的解决方法：

在新建连接上，当应用数据到来时，组成一个TCP段发送（那怕只有一个字节）
在收到确认之前，后续到来的数据放在发送缓存中
当数据量达到一个MSS或上一次传输的确认到来（取两者的较小时间），用一个TCP段将缓存的字节全部发走
Nagle算法的优点：

适应网络延时、MSS长度及应用速度的各种组合 常规情况下不会降低网络的吞吐量
6.拥塞控制
发送方根据自己感知的网络拥塞程度，限制其发送速率

6.1 拥塞控制的类型
网络辅助的拥塞控制
路由器向端系统提供显式的反馈，例如：
设置拥塞指示比特
给出发送速率指示
ATM、X.25采用此类方法
端到端拥塞控制
网络层不向端系统提供反馈
端系统通过观察丢包和延迟，自行推断拥塞的发生
TCP采用此类方法
6.2 TCP拥塞控制要解决的问题
发送方如何感知网络拥塞？

发送方利用丢包事件感知拥塞：
拥塞造成丢包和分组延迟增大
-无论是丢包还是分组延迟过大，对于发送端来说都是丢包了
丢包事件包括：
-重传定时器超时
-发送端收到3个重复的ACK
发送方采用什么机制限制发送速率?

发送方使用拥塞窗口cwnd限制已发送未确认的数据量:
LastByteSent-LastByteAcked <= cwnd


cwnd随发送方感知的网络拥塞程度而变化

发送方感知到网络拥塞后，采取什么策略调节发送速率？

①AIMD

乘性减（Multiplicative Decrease）
发送方检测到丢包后，将cwnd的大小减半（但不能小于一个MSS）
目的：迅速减小发送速率，缓解拥塞
加性增（Additive Increase）
若无丢包，每经过一个RTT，将cwnd增大一个MSS，直到检测到丢包
目的：缓慢增大发送速率，避免振荡
注：MSS是发送速率TCP建立连接时双方确定的每一个报文段所能承载的最大数据长度



②TCP慢启动

慢启动的策略：
每经过一个RTT，将cwnd加倍
慢启动的具体实施：
每收到一个ACK段，cwnd增加一个MSS
只要发送窗口允许，发送端可以立即发送下一个报文段
特点：
以一个很低的速率开始，按指数增大发送速率
区分不同的丢包事件

超时：说明网络交付能力很差
收到3个重复的ACK：说明网络仍有一定的交付能力

收到3个重复的ACK：
将cwnd降至一半
使用AIMD调节cwnd
超时：
设置门限 =cwnd/2
cwnd=1MSS
使用慢启动增大cwnd至门限
使用AIMD调节cwnd
6.3 TCP拥塞控制的实现
发送方维护变量ssthresh
发生丢包时，ssthresh=cwnd/2
ssthresh是从慢启动转为拥塞避免的分水岭：
cwnd低于门限时，执行慢启动
cwnd高于门限：执行拥塞避免
拥塞避免阶段，拥塞窗口线性增长：
每当收到ACK， cwnd=cwnd + MSS*(MSS/cwnd)
检测到3个重复的ACK后：
TCP Reno实现： cwnd= ssthresh+3，线性增长
TCP Tahoe实现：cwnd=1 MSS，慢启动

TCP发送端的事件与动作


六、应用层
1.应用层概述
每个应用层协议都是为了解决某一应用问题，通过位于不同主机中的多个应用进程之间的通信和协同工作来完成
两台主机通信实际是其对应的两个应用进程(process)在通信
应用进程: 为解决具体应用问题而彼此通信的进程
应用层的具体内容就是规定应用进程在通信时所遵循的协议
客户/服务器（C/S, Client/Server）方式
对等（P2P，Peer to Peer）方式
1.1 应用进程通信方式
①客户/服务器（C/S, Client/Server）方式
应用层的许多协议是基于C/S方式，例如，在移动互联网环境下，每个应用APP都是一个客户端
客户(client)和服务器(server)是指通信中所涉及的2个应用进程
客户/服务器方式描述的是应用进程之间服务和被服务的关系
客户是服务请求方（主动请求服务，被服务）
服务器是服务提供方（被动接受服务请求，提供服务）
C/S方式可以是面向连接的，也可以是无连接的
面向连接时，C/S通信关系一旦建立，通信就是双向的，双方地位平等，都可发送和接收数据


客户进程的特点

在进行通信时临时成为客户，它也可在本地进行其它的计算
用户计算机上运行，在打算通信时主动向远地服务器发起通信
客户方必须知道服务器进程所在主机的IP地址才能发出服务请求
需要时可以与多个服务器进行通信
服务器进程的特点

专门用来提供某种服务的程序，可“同时”处理多个远地或本地客户的请求
必须始终处于运行状态才有可能提供服务
通信开始之前服务器进程不需要知道客户进程所在主机的IP地址，无论客户请求来自哪里，服务器进程被动等待服务请求的到来即可
通常是当系统启动时即自动调用并一直运行着。某些服务器程序也可以由用户或其它进程在通信前启动
被动等待并接受来自多个客户的通信请求
②对等（P2P，Peer to Peer）方式
对等方式是指两个进程在通信时并不区分服务的请求方和服务的提供方
只要两个主机都运行P2P软件，它们就可以进行平等、对等的通信
双方都可以下载对方存储在硬盘中的共享文档，如果权限允许的话
音频/视频应用推动了P2P对等通信方式的发展（BitTorrent）
音频/视频流量已占主要比
P2P方式从本质上看仍然是使用了C/S方式，但强调的是通信过程中的对等，这时每一个P2P进程既是客户同时也是服务器


1.2 服务器进程工作方式
循环方式(iterative mode)

一次只运行一个服务进程
当有多个客户进程请求服务时，服务进程就按请求的先后顺序依次做出响应 (阻塞方式)
并发方式(concurrent mode)

可以同时运行多个服务进程
每一个服务进程都对某个特定的客户进程做出响应 (非阻塞方式)
无连接循环方式服务

使用无连接的UDP服务进程通常都工作在循环方式，即一个服务进程在同一时间只能向一个客户进程提供服务。(顺序服务)
服务进程收到客户进程的请求后，就发送UDP用户数据报响应该客户
对其他客户进程发来的请求则暂时不予理睬，这些请求都在服务端的队列中排队等候服务进程的处理
当服务进程处理完毕一个请求时，就从队列中读取来自下一个客户进程的请求，然后继续处理


面向连接的并发方式服务

面向连接的TCP服务进程通常都工作在并发服务方式，服务进程在同一时间可同时向多个客户进程提供服务。(并发服务)
在TCP服务进程与多个客户进程之间必须建立多条TCP连接，每条TCP连接在其数据传送完毕后释放
一个TCP连接对应一个（熟知）服务端口
主服务进程在熟知端口等待客户进程发出的请求。一旦收到客户的请求，就创建一个从属服务进程，并指明从属服务进程使用临时套接字与该客户建立TCP连接，然后主服务进程继续在原来的熟知端口等待向其他客户提供服务




2.域名系统
2.1 概述
域名系统（DNS，Domain Name System）是互联网重要的基础设施之一，向所有需要域名解析的应用提供服务，主要负责将可读性好的域名映射成IP地址
Internet采用层次结构的命名树作为主机的名字，并使用分布式的域名系统 DNS。Internet的DNS是一个联机分布式数据库系统
名字到域名的解析是由若干个域名服务器程序完成的。域名服务器程序在专设的结点上运行，相应的结点也称为名字服务器(Name Server)或域名服务器(Domain Name Server)


2.2 域名系统名字空间和层次结构




2.3 域名解析过程
递归查询
当收到查询请求报文的域名服务器不知被查询域名的IP地址时，该域名服务器就以DNS客户的身份向下一步应查询的域名服务器发出查询请求，即替本地域名字服务器继续查询
较少使用

迭代查询
当收到查询请求报文的域名服务器不知道被查询域名的IP地址时，就把自己知道的下一步应查询的域名服务器IP地址告诉本地域名字服务器，由本地域名字服务器继续向该域名服务器查询，直到得到所要解析的域名的IP地址，或者查询不到所要解析的域名的IP地址
通常使用


3.电子邮件
3.1 邮件发送的常用协议
简单邮件传输协议SMTP（Simple Mail Transfer Protocol）——邮件服务器之间传递邮件使用的协议

最终交付（邮件访问）协议::从邮件服务器的邮箱中获取邮件
POP3：Post Office Protocol-Version 3，第三版邮局协议
IMAP：Internet Message Access Protocol，Internet邮件访问协议
Webmail（HTTP）：基于Web的电子邮件


3.2 Webmail
Webmail——基于Web的电子邮件

提供电子邮件服务的IMAP和SMTP替代方案
使用Web作为界面，用户代理就是普通的浏览器
用户及其远程邮箱之间的通信通过HTTP进行


4.WWW
4.1 WWW体系结构与协议
WWW=World Wide Web=万维网
HTTP服务器和客户端，以及它们之间执行的HTTP协议

服务器

Web页面（HTML文档）：包含多种对象或链接
Web对象（包括：静态对象和动态对象）：可以是 HTML文档、 图像文件、视频文件、声音文件、脚本文件等
对象用URL（统一资源定位符）编址：协议类型://主机名:端口//路径和文件名
客户端

发出请求、接收响应、解释HTML文档并显示
有些对象需要浏览器安装插件


统一资源定位器URLs


www协议


4.2 HTTP
概述
超文本传输协议HTTP（ HyperText Transfer Protocol）在传输层通常使用TCP协议，缺省使用TCP的80端口
HTTP为无状态协议，服务器端不保留之前请求的状态信息
无状态协议：效率低、但简单
有状态协议：维护状态相对复杂，需要维护历史信息，在客户端或服务器出现故障时，需要保持状态的一致性等
HTTP标准
HTTP/1.0: RFC 1945（1996年）
HTTP/1.1: RFC 2616（1999年）
HTTP/2: RFC 7540（2015年）、RFC 8740（2020年）
HTTP发展现状
HTTP/1.0（1996）
无状态，非持久连接
与HTTP/1.1（1999）
支持长连接和流水线机制
缓存策略优化、部分资源请求及断点续传
HTTPS：HTTP+TLS（2008）
增加SSL/TLS（TLS 1.2）层，在TCP之上提供安全机制
HTTP/2.0（2015、2020）
目标：提高带宽利用率、降低延迟
增加二进制格式、TCP多路复用、头压缩、服务端推送等功能


Web安全与隐私：Cookie
HTTP 无状态协议，服务器 用cookies保持用户状态

HTTP在响应的首部行里使用一个关键字头set-cookie：选择的cookie号具有唯一性
后继的HTTP请求中使用服务器响应分配的cookie：
Cookie文件保存在用户的主机中，内容是服务器返回的一些附加信息，由用户主机中的浏览器管理
Web服务器建立后端数据库，记录用户信息，cookie作为关键字
例如：
Set-Cookie: SID=31d4d96e407aad42; Path=/; Domain=example.com
Cookie: SID=31d4d96e407aad42



Cookies一般包含5个字段
域指明Cookie来自何方，每个域为每个客户分配Cookie有数量限制
路径标明服务器的文件树中哪些部分可以使用该Cookie
内容采用“名字=值”的形式，是Cookie存放内容的地方，可以达到4K容量，内容只是字符串，不是可执行程序
安全指示浏览器只向使用安全传输连接的服务器返回Cookie


Cookie技术是把双刃剑，能分析用户喜好，向用户进行个性化推荐
用Cookie在某网站标识用户信息，查找用户以前浏览网站记录
用Cookie记录用户购物清单
用Cookie可以保存4K内容，跟踪用户浏览网站的喜好
用Cookie跨站点跟踪用户点击广告
Cookie技术是把双刃剑，也能跟踪用户网络浏览痕迹，泄露用户隐私
Cookie跟踪用户以前浏览过哪些网站，跟踪用户频繁浏览哪类网站
Cookie收集用户信息，用户网络交互时关注的关键词
Cookie容易嵌入间谍程序，这是个误区，Cookie文件保存的只是文本串，没有可执行程序
用户可以设置浏览器限制使用Cookie
5.流媒体
5.1 概述
流媒体概念
连续媒体（音视频）经压缩编码、数据打包后，经过网络发送给接收方
接收方对数据进行重组、解码和播放
流媒体的特性
端到端时延约束
时序性约束：流媒体数据必须按照一定的顺序连续播放
具有一定程度的容错性：丢失部分数据包也可完成基本功能
流媒体面临的挑战
约束条件：网络特性（带宽有限、动态变化、延迟与抖动、丢失、异构性）
目标：流媒体服务质量要素（画质、启动延迟、平滑、交互性）
如何在“尽力服务”的网络传输条件下获得良好的视频质量？
5.2 流媒体动态自适应传输
DASH (Dynamic Adaptive Streaming over HTTP)
动态自适应流媒体传输协议DASH，由MPEG组织制定的标准
类似协议：苹果HTTP Live Streaming（HLS）； Adobe的HTTP Dynamic Streaming（HDS）；微软的Microsoft Smooth Streaming
DASH 基本思想
完整视频被拆分为固定时长 (2s-10s) 的视频片段(segment)， 每段提供不同码率
视频片段与其对应的元文件（URL）一同存放于DASH服务器
客户端基于网络条件、缓冲大小等，对每个视频片段，自适应选择合适的视频码率来下


DASH中普遍使用的自适应码率ABR（Adaptive bitrate）

6.内容分发网络CDN
6.1 概述
内容分发网络CDN
Content Delivery Network，or Content Distribution Network
基本思想源于MIT对Web服务瞬间拥塞问题的解决（1998）
一种Web缓存系统，靠近网络边缘（用户）提供内容服务
目前提供更丰富的服务，包括静态内容、流媒体、用户上传视频等
主要优点
降低响应时延，避免网络拥塞
避免原始服务器过载及防止DDoS攻击
分布式架构，具有良好的可扩展性
对用户透明，无需用户感知
6.2 关键问题
怎样将内容（如从百万的视频中选定的内容）分发给同时发起访问的数百万用户？

6.3 机理与解决方式
DNS重定向实现CDN

将请求调度到较近或负载较轻的CDN服务器
HTTP重定向请求内容，服务提供者返回清单CDN
原始服务器决策CDN服务器
HTTP响应：状态码30X，Location：指明新的位置
DNS辅助实现CDN

负载均衡DNS负责决策CDN服务器选择
负载均衡DNS需要收集CDN服务器的位置和负载情况
如果找不到被请求的对象，需要从原始服务器获取


7.P2P网络
P2P文件分发协议：BitTorrent

文件被划分为256Kb大小的块
具有种子(torrents)的节点发送或接收文件


8.远程登录Telnet
Telnet协议引入网络虚拟终端NVT（Network Virtual Terminal），使用一种专门的键盘定义来屏蔽不同计算机系统对键盘输入的差异性，同时定义客户进程与远程服务器进程之间的交互过程
NVT是Telnet协议定义的一组通用字符集，通过这种统一的数据表示方式，来保证不同硬件、软件与数据格式的终端与主机之间通信的兼容性
本地终端输入的字符首先由本地Telnet客户进程转换为NVT格式，通过网络将NVT格式的字符传输到远程主机，远程Telnet服务器进程再将NVT格式的字符转换为远程主机能够识别和处理的字符格式
使用Telnet协议在网络中传输的数据都是NVT格式，不同的用户终端与服务器进程均与本地终端格式无关
Telnet的工作过程

本地Telnet客户进程与远程主机上的Telnet服务器进程建立TCP连接
将本地终端上输入的用户名和口令及以后输入的任何命令或字符以网络虚拟终端NVT格式传输给远程主机
将远程主机输出的NVT格式的数据转化为本地所接受的格式送回本地终端，包括输入命令回显和命令执行结果
本地终端对远程主机撤销连接，从而结束 Telnet远程登录过程


9.FTP
9.1 概述
文件传输协议FTP(File Transfer Protocol) 是Internet上使用最广泛的应用层协议之一

FTP提供交互式的访问，允许用户指明文件的类型与格式，并允许文件具有存取权限
FTP屏蔽了各计算机系统的细节，适用于在异构网络中任意计算机之间传送文件
RFC 959早在1985年就已经成为Internet的正式标准
FTP使用C/S方式实现
9.2 工作过程
服务器主进程打开TCP21端口，等待客户进程发出的连接请求
客户可以用分配的任意一个本地端口号与服务器进程的TCP21端口进行连接
客户请求到来时，服务器主进程启动从属进程来处理客户进程发来的请求
服务器从属进程对客户进程的请求处理完毕后即终止，但从属进程在运行期间根据需要还可能创建其他一些子进程
服务器主进程返回，继续等待接收其他客户进程发来的连接请求，服务器主进程与从属进程并行工作
FTP的两个端口与两个连接

控制连接在整个会话期间一直保持，客户进程发出的文件传输请求通过控制连接发送给服务器控制进程（工作在TCP21端口），但控制连接不用来传输文件
服务器控制进程在接收到客户进程发送来的文件传输请求后就创建数据传输进程（工作在TCP20端口）和数据连接
数据连接用来连接客户进程和服务器数据传输进程，实际完成文件的传输。服务器数据传输进程在文件传输完毕后关闭数据连接并结束运行


写在最后
这篇知识汇总我写了好久，因为ppt的缘故，知识整理需要自己消化一遍然后挑选重要的部分整理摘录下来，同时对于某些知识点的组织结构做了相应调整，对于不太清楚的地方，我也去查阅了相关资料做了补充。但需要注意的是有些知识点并不完整，该知识点整理也只是根据我们当时考试的考点来整理的，所以不足之处请见谅。

愿我们以梦为马，不负人生韶华！
与君共勉
————————————————

                            版权声明：本文为博主原创文章，遵循 CC 4.0 BY-SA 版权协议，转载请附上原文出处链接和本声明。

原文链接：https://blog.csdn.net/qq_46101869/article/details/118108697



第一章 计算机网络概述
        国际标准化组织(ISO): International Organization for Standardization, 制定OSI参考模型

        OSI: 开放系统互连参考模型(Open Systems Interconnection Reference Model)
    
        国际电气电子工程师: 世界上最大的专业技术团体 
    
        网络: 由若干结点(计算机、集线器、交换机、路由器等)和连接这些结点的链路组成。
    
        互联网(internet): 网络的网络。通过路由器将网络互连起来,构成一个覆盖范围更大的网络。
    
        因特网(Internet): 世界上最大的互联网。网络把许多计算机连接在一起, 互联网把许多网络连接在一起
    
        客户机(Client) 与 服务器(Server)方式: 简称C/S方式, 是因特网应用最常使用方式。
    
        对等方式(peer to peer): 简称p2p方式。

计算机网络的功能:

数据通信 (最基本)
资源共享
分布式处理: 提高可靠性, 负载均衡
1.1 计算机网络的分类 
按分布范围分类

广域网(WAN): 也称远程网, 使用点对点网络 
城域网
局域网: 使用广播技术, 广域网使用交换技术, 两者协议不同
个人区域网 
按网络的拓扑结构

总线型网络: 增减结点方便, 重负载时通信效率不高, 总线任意一处故障敏感
星形网络: 便于集中控制管理, 中央设备对故障敏感
环形网络: 如令牌缓局域网
网状网络: 可靠性高, 成本高, 多用在广域网中
分类图:



计算机网络的组成:

        网络边缘: 用户直接使用的,由所有连接在因特网上的主机组成。
    
        网络核心: 为边缘部分提供服务的, 由大量网络和网络的路由器组成。

工作方式图:



        通信子网: 实现数据通信
    
        资源子网: 实现资源共享/数据处理

功能组成图:



1.2 三种交换方式
1.2.1 电路交换
        建立连接-->数据传输-->释放连接, 在通话的全部时间内,建立了一条专用的物理通路, 通话的两个用户始终占用端到端的通信资源。

电话交换图:



        特点: 通信时延小, 有序传输, 没有冲突, 但建立时间长, 独占线路线路利用率低。

1.2.2 报文交换
        整个报文先传送到相邻结点, 全部存储下来后查找转发表,转发到下一个结点。

        存储转发: 先暂时存储下来, 检查首部, 按首部中的目的地址查找转发表, 找到合适的接口转发出去,交给下一个分组交换机。 
    
        特点: 无需建立连接, 可以同时发给多个目的地址, 但转发时延高。

1.2.3 分组交换
        同报文交换一样, 采用了存储转发方式, 但解决了报文交换中大报文的传输问题, 可分为面向连接的虚电路方式和无连接的数据报方式, 这两者方式都由网络层提供。 

        分组交换: 将一个数据报文划分成一个个更小的等长数据段, 每个数据段前加上必要的控制信息,构成分组, 通过路由器以存储转发方式,发送到目标主机。

数据报分组交换图:



        数据报特点: 无建立时延, 线路利用率高, 动态分配线路, 相比报文交换, 减少了出错概率和重发数据量, 但存在存储转发时延, 需要传输额外信息量(控制信息), 可能出现失序(虚电路不会)、丢失、重复。 

三种交换比较图:



1.3 计算机网络主要性能指标
1.3.1 速率
        速率就是数据的传送率,它也称为数据率或比特率, 单位是bit/s (bps)

速率:

        千 1kb/s=b/s
    
        兆 1Mb/s=kb/s
    
        吉 1Gb/s=Mb/s
    
        太 1Tb/s=Gb/s

存储容量:

        1KB=B=1024B
    
        1MB=KB
    
        1GB=MB
    
        1TB=GB

1.3.2 带宽
        在计算机中,带宽用来表示网络的通信线路所能传送数据的能力, 即单位时间从网络中的某一点到另一点所能通过的"最高数据率",单位是bit/s。

1.3.3 吞吐量
         也称吞吐率, 表示在单位时间内通过某个网络(或信道,接口)的数据量。吞吐量受网络的带宽或网络的额定速率的限制。

1.3.4 时延
        时延是指数据从网络的一端传送到另一端所需的时间,也称延迟或迟延。

        传输时延: 主机或路由器将分组发送到通信线路上所需的时间, 从发送分组的第一个比特算起,到该分组的最后一个比特发送到线路上所需的时间。公式是:

发送时延=数据长度/发送速率 (信道带宽)

        传播时延: 电磁波在信道中需要传播一定的距离而花费的时间, 公式是:

传播时延=信道长度/电磁波在信道上的传播速率

        处理时延: 主机或路由器收到分组时要花费一定的时间进行处理(分析分组首部、提取数据、差错检验、查找路由等)
    
        排队时延: 在网络传输时, 经过许多路由器的缓存队列中排队的时间。
    
        时延带宽积: 某段链路现在有多少比特



        往返RTT: 从发送数据开始, 到收到接收方确认的时间
    
        备注: 所谓高速网络链路,提高的仅仅是数据的发送速率而不是比特在链路上的传播速率 。提高发送速率只是减少了数据的传输时延。

1.3.5 丢包率***
        即分组丢失率, 指在一定时间范围内, 分组在传输过程总丢失的分组数量与总的分组数量的比率。丢包率高,用户感觉往往是网络时延变大, 而不是信息丢失。

分组丢失的两种情况:

在传输过程中出现了比特级差错, 被结点丢弃
分组交换机队列已满,被抛弃
1.3.6 利用率***
        信道利用率: 信道利用率指出某信道有百分之几的时间是被利用的。根据排队理论, 信道利用率过高会产生非常大的时延。

        网络利用率: 全网络的信道利用率的加权平均值



1.4 计算机网络体系结构
        协议: 控制两个对等体(或多个实体)进行通信的规则。

协议三要素:

语法: 数据与控制信息的结构或格式
语义: 各个控制信息的具体含义, 完成何种动作及做出何种响应。
同步(时序): 数据应该在何时发送出去, 以什么速率发送。
        服务: 下层为紧邻的上层提供的功能调用。协议是"水平的", 服务是"垂直的"。

        接口:  访问服务点(SAP), 上层使用下层服务的入口。

服务、协议、接口：



        协议数据单元(PDU): OSI 对等层之间传送的数据单元, 包含协议控制单元(PCI), 服务数据单元(SDU)

PDU示例图:





1.4.1 五层协议模型
应用层

        任务: 通过进程间的交互来完成特定的网络应用
    
        协议: 如HTTP协议, SMTP协议, FTP协议等
    
        数据单元: 报文

传输层

        任务: 向两台主机中进程(端到端)之间的通信提供的数据传输服务,
    
        功能: 复用, 分用, 流量控制, 差错控制的功能。
    
        协议: TCP协议、UDP协议
    
        TCP: 提供面向连接的, 可靠的数据传输服务, 数据单元是报文段
    
        UDP: 提供无连接的, 尽最大努力的传输服务, 数据单元是用户数据报
    
        服务访问点(SAP): 端口号字段

网络层(网际层、IP层)

        任务: 选择合适的路由,存储转发,最后到达目标主机。
    
        功能: 路由选择, 流量控制, 差错控制, 拥塞控制
    
        主要协议：IP、IPX、ICMP、 IGMP、ARP、RARP、OSPF
    
        数据单元: IP数据报, 简称数据报
    
        服务访问点(SAP): 协议字段

数据链路层

        任务: 把网络层传下来的数据报组装成帧, 差错控制, 流量控制, 控制对信道的访问的功能。
    
        数据单元: 帧
    
        主要协议：SDLC、HDLC、PPP、 STP
    
        帧: 包括数据和控制信息(一个帧从哪里开始,到哪里结束、差错检测)
    
        服务访问点(SAP): 类型字段

物理层

        任务: 主要任务是在物理媒体上实现比特流的透明传输。
    
        主要功能: 定义接口特性, 定义传输模式(单工、半双工、双工), 定义传输速率, 比特同步, 比特编码
    
        数据单元: 比特
    
        主要协议：Rj45、802.3
    
        传输媒体: 双绞线、同轴电缆、光缆等。

 1.4.2 OSI参考模型
        表示层: 用于处理在两个通信系统中交换信息的表示方式, 如: 数据格式变换, 加密解密, 压缩和恢复。

        会话层: 建立同步（SYN）, 提供建立连接并在连接上有序地传输数据。

示意图：



与TCP/IP的区别:



三者区别图: 



1.5 两个重要的新兴网络技术***
云计算

        定义: 云计算是一种运行在计算机网络上的分布式应用,通过网络以按需、易扩展的方式向用户提供安全、快捷、便捷、廉价的数据存储和网络计算服务。
    
        Iaas: 基础设施即服务, 将硬件设备等基础资源(如处理能力、存储空间、网络组件)封装成服务通过网络提供给用户使用。
    
        Paas: 平台即服务,提供用户应用程序的开发和运行环境
    
        Saas: 软件即服务 ,将某些特定应用软件功能封装成服务

物联网

        定义: 物物相连的互联网。按约定的协议,把任何物体与互联网相连接, 进行信息交换和通信,以实现人与物,物与物的相互沟通和对话, 对物体进行智能化识别、定位、跟踪、管理和控制的一种信息网络。

第二章 物理层
2.1 基本概念
        物理层主要任务是确定与传输媒体接口有关的一些特性, 即定义标准

        信源：产生和发送数据的源头。
    
        信宿：接收数据的终点 。
    
        信道：信号的传输媒介。

三种通信方式:

        单工通信: 只有一个方向的通信
    
        半双工通信: 通信的双方都可以发送或接收信息，但任何一方都不能同时发送和接收
    
        全双工通信: 通信双方可以同时发送和接受信息

物理层接口特性:

        机械特征:  规定物理连接时所采用的规格、接口形状、引线数目、引脚数量和排列情况。
    
        电气特征:  线路上信号的电压范围、阻抗匹配、传输速率和距离限制等。
    
        功能特征: 某条线上出现的某一电平表示何种意义  
    
        规程特征: 定义各条物理线路的工作规程和时序关系

数据传输方式:

1) 串行传输: 速度慢，费用低，适合远距离



2) 并行传输: 速度快，费用高，适合近距离



模拟信号/连续信号图:



数字信号/离散信号图:



        同步传输: 需先送出1个或多个同步字符，再送出整批的数据。
    
        异步传输: 加一个字符起始位和一个字符终止位。发送方可以在任何时刻 发送这些比特组，而接收方不知道它们会在什么时候到达。
    
        码元: 用一个固定时长的数字脉冲, 代表不同离散数值的基本波形, 这个时长内的信号称为k进制码元，而该时长称为码元宽度。1码元可以携带多个比特的信息量
    
        码元传输速率：别名波特率, 或调制速率, 波形速率, 符号速率。 表示单位时间内数字通信系统所传输的码元个数（也可称为脉冲个数或信号变化的次数）, 单位是波特（Baud）, 码元速率与进制数无关，只与码元长度有关。
    
        信息传输速率：别名信息速率、比特率等表示单位时间内数字通信系统传输的二进制码元个数, 单位是比特/秒（b/s）。
    
        波特率与比特率的关系：若一个码元携带n bit的信息量，则M Baud的码元传输速率所对应的信息传输速率为M×n bit/s。 

2.1.1奈氏准则（奈奎斯特定理）
        在没有噪声、带宽有限的信道中, 为了避免码间串扰的极限码元传输速率。

        码间串扰：接收端收到的信号波形失去了码元之间清晰界限的现象。 
    
        采样定理(奈奎斯特定理): 采样率必须大于或等于最大频率的2倍。 

公式: 



说明: 

        1) 在任何信道中，码元传输的速率是有上限的
    
        2) 奈氏准则给出了码元传输速率的限制，但并没有对信息传输速率给出限制。
    
        3) 要提高数据的传输速率, 必须设法使每个码元能携带更多个比特的信息量

2.1.2 香农定理
        在带宽受限且有噪声的信道中，为了不产生误差，信息的数据传输速率有上限值。

公式:  



        信噪比: 信号的平均功率/噪声的平均功率, 用分贝（dB）作为度量单位为:

 


如:  , 则 

        说明:  信道的带宽或信道中的信噪比越大，则信息的极限传输速率就越高。

2.2 编码&调制 
        基带信号: 将数字信号1和0直接用两种不同的电压表示，再送到数字信道上去传输

        宽带信号: 将基带信号进行调制后形成的频分复用模拟信号，再传送到模拟信道上去传输
    
        备注: 传输距离较近时，计算机网络采用基带传输方式, 距离较远时，采用宽带传输方式
    
        编码: 数据转化为数字信号
    
        调制: 数据转化为模拟信号 

相关设备的作用:  

        调制器: 数字数据转化为模拟信号
    
        PCM编码器: 模拟数据转化为数字信号
    
        数字发送器: 数字数据转化为数字信号
    
        放大调制器: 模拟数据转化为模拟信号

2.2.1 数字数据编码为数字信号


        1) 非归零编码【NRZ】: 高1低0, 存在同步问题
    
        2) 曼彻斯特编码: 看前半个, 高1低0, 同差分曼彻斯特编码, 占的频带宽度是原始基带宽度的两倍 (波特率:比特率=2:1, 编码效率是50%), 以太网采用曼彻斯特编码 , 电平跳变用于同步
    
        3) 差分曼彻斯特编码: 看前半个与其前面的关系, 相同为1, 不同为0。常用于局域网。有更强抗干扰能力。
    
        4) 归零编码【RZ】:  高1低0  (return to zero)
    
        5) 反向不归零编码【NRZI】: 遇到0则变 (由高变低. 由低变高)
    
        6) 4B/5B编码: 比特流中插入额外的比特以打破 一连串的0或1，编码效率为80%

2.2.2 数字数据调制为模拟信号


        调幅+调相（QAM）: 数据传输速率为  b/s (B为波特, m个相位, n种振幅)
    
        备注: 调频抗干扰能力强, 调幅抗干扰能力差。

2.2.3 模拟数据编码为数字信号
        根据采样定理, 它主要包括三步：采样, 量化, 编码

示例图: 



2.3 传输介质及物理层设备
2.3.1 传输介质
        它就是数据传输系统中在发送设备和接收设备之间的物理通路。传输媒体/介质并不是物理层。

1) 双绞线 (twisted pair cable): 由两根采用一定规则并排绞合的、相互绝缘的铜导线组成 

示例图:



特点: 价格便宜, 最常用的传输介质之一。 

2) 同轴电缆: 分为两类, 一类用于传送基带数字信号, 又称基带同轴电缆, 一类用于传送宽带信号，又称为宽带同轴电缆



特点: 抗干扰特性比双绞线好，传输距离更远，但价格较双绞线贵。

3) 光纤: 光纤由纤芯(实心)和包层构成, 带宽远远大于其他传输媒体的带宽



光纤分类图:



特点: 传输损耗小, 抗雷电和电磁干扰性能好, 不易被窃听或截取数据。体积小，重量轻。

非导向性传输介质:

        1) 无限电波: 信号向所有方向传播, 有较强穿透能力
    
        2) 微波: 信号固定方向传播, 通信频率较高, 有地面微波接力通信和卫星通信两种方式 
    
        3) 红外线和激光: 信号固定方向传播。

2.3.2 物理层设备 
        中继器(转发器): 对信号进行再生和还原，对衰减的信号进行放大, 中继器两端的网段一定要是同一个协议, 可以是不同传输媒体。

        5-4-3规则：用4个中继器串联的5段通信介质只有3段可以挂计算机。
    
        集线器: 实质上是一个多端口的中继器, 只起信号放大和转发作用。星形网络拓扑结构。

第三章 数据链路层
备注: 

        1）OSI体系的数据链路层有流量控制功能, TCP/IP体系中流量控制在传输层 
    
        2）通信质量较差的无限传输中, 数据链路层使用确认和重传机制, 向上提供可靠传输服务
    
        3）通信质量较好的有线链路不再使用确认和重传机制, 由CRC检错保证上交的帧是正确的。

3.1 封装成帧
        数据链路层以帧为单位传输和处理数据, 将网络层的数据报前面和后面分别添加上首部和尾部, 封装成一个完整的帧。首部和尾部作用之一就是进行帧定界。组帧即定义数据格式。

 帧图:



        组帧的四种方法:  字符计数法, 字符填充法, 零比特填充法, 违规编码法。

3.1.1 字符计数法
        帧首部使用一个计数段来标明帧内字符数

示例图:



3.1.2 字符填充法
        使用某个特殊的控制字符作为帧定界符, 使用字节填充的方法将数据部分的特殊字符与帧定界符区分开来, 即在数据中出现的标记字符前插入一个转义字符。

字节填充原理图:



3.1.3 零比特填充法
        当物理链路传送连续的比特流, 可以使用某个特殊的比特组合, 如HDLC协议使用的"01111110"作为标识, 即数据部分只要发现有5个连续1, 则立即填入一个0。

原理图:



3.1.4 违规编码法
        在物理层进行比特编码时采用, 如曼彻斯特编码采用高-高电平或低-低电平，局域网IEEE802标准采用了此方法。

3.2 差错控制
        FCS: 帧检验序列,帧尾部设置的一个差错检验字段。Frame Check Sequence

        CRC: 循环冗余检验, Cyclic Redundancy Check, 也称多项式编码
    
        随机差错: 通过提高信噪比可以减弱影响
    
        突发差错: 引起传输差错的主要原因,由外界电磁干扰引起。

3.2.1 奇偶检验
        每个数据字节都会增加一个额外的位，称为校验位。校验位被设置为使得每个字节中“1”的位数为奇数（或偶数）。

3.2.2 循环冗余码
        具有纠错功能, 只是数据链路层仅使用了它的检错功能。

 CRC 运算原理:



3.2.3 汉明码
        1) 确定汉明距离: , k为冗余信息位数, n为校验位的位数

        2) 校验位的分布:  (i=0,1,2 ... ) 
    
        3) 求出校验码值
    
        4) 汉明码距: 纠错 (2d+1), 检错(d+1)

示例图:



纠错示例图:  



3.3 流量控制和可靠传输
        在数据链路层中, 流量控制和可靠传输是交织在一起的。

        流量控制: 停止等待协议 和 滑动窗口协议。

3.3.1 停止等待协议 Stop-and-Wait
        收到一个正常分组时, 回复一个ACK; 发现错误则回复NAK, 并使发送方重发, 发送方每发送一个分组必须停下来等待接受确认后才能发下一个分组。

        为防止确认分组丢失, 可以采用超时重传机制。
    
        为防止重复接受, 发送带序号的帧。

SW协议原理图:





停止等待协议的信道利用率:



        信道利用率: 发送方发送数据的时间占整个发送周期的比率。TD,TA为传输时延。

1.4.2 回退 N 帧协议 Go-back-N
        采用流水线传输方式, 利用发送窗口限制发送方连续发送分组的个数,  一个分组出错, 其后续连续发送的所有分组都要重传。

        接收方采用累计确认的方式, 有接受窗口的话, 则GBN协议的接受窗口为1。收到失序分组则丢弃, 并对最近按序接受的分组进行确认。

GBN协议原理图:



流水线传输的信道利用率:



        发送窗口大小: 

1.4.3 选择重传协议 Selective Repeat
        在GBN协议基础上, 接受窗口不再为1, 对正确接受的分组进行逐一确认。超时只重传一个超时的帧。

SR协议原理图:



        滑动窗口长度:    (发送窗口+接受窗口<=)
    
        窗口边界: (下边界, 上边界)

连续ARQ协议的信道利用率:





3.4 介质访问控制
        采取一定措施, 使得两个节点之间的通信不会发送相互干扰的情况。

介质访问控制分类图:



3.4.1 静态划分信道
频分多路复用与时分多路复用示例图:



统计时分多路复用(STDM):  



波分多路复用图: 



码分多路复用:  令S表示A站点的码片向量, 令T表示B站点的码片向量 (0用-1,1用+1 ) 则:

        1) S和T的规格化内积: 
    
        2) 在公共信道上进行线性相加
    
        3) 要去A的信息时, 使S与(S*T)进行规格化内积(相乘,除m), -1为0, +1为1(相同码片内积为1, 不同码片内积为0, 因此过滤掉非S的其他信号)

3.4.2 动态划分信道
        争用型协议。

        纯ALOHA协议: 不监听信道, 不按时间槽发送, 想发就发。一段时间内未收到确认就认为发生了冲突。超时后等一随机时间再重传。
    
        时隙ALOHA协议: 将时间划分为一段段等长的时隙, 只能在每个时隙开始才能发送一个帧。

时隙ALOHA协议示意图:



        CSMA协议: 载波监听多路访问协议, 发送前先监听一下共用信道, 发现空闲后再发送。

三种CSMA对比:



        CSMA/CD协议:   载波监听多址接入/碰撞检测。适用于总线型网络或半双工网络。
    
        碰撞检测: 边发送监听,也称冲突检测, 发送碰撞时, 适配器立即停止发送。

 原理图:



        最小帧长: 2*总线传播时延*数据传输速率

截断二进制指数退避算法:

         帧的发送时延不能小于2倍网络最大传播时延, 即一个争用期, 因此以太网规定最短有效帧长64字节。也称动态退避算法



        CSMA/CA协议: 载波监听多址接入/碰撞避免

 不使用CSMA/CD 协议的原因:

        1) 无限信道传输信号强度的动态范围非常大。
    
        2) 隐蔽站问题:



CSMA/CA 工作原理:



三种帧间间隔IFS: 所有站发送完后必须等待一段的时间, 即帧间间隔(IFS)

        1) SIFS: 最短的IFS, 分隔属于一次对话的各帧, 如ACK帧
    
        2) PIFS: 在PCF操作中使用
    
        3) DIFS: 最长的IFS, 用于异步竞争访问的时延。

退避算法:

        1) 当要发送帧的站点检测信道从忙态转为空闲时, 就要执行退避算法(除了非发生不成功的初有数据)。退避计时器设置一个随机退避时间, 当退避计时器减小到零时, 就开始发送数据。
    
        2) 当退避计时器的时间还未减小到零时,信道又转变为忙态, 便冻结退避计时器的数值,重新等待信道变为空闲, 并经过DIFS 后, 继续启动退避计时器。 
    
        3) 为避免一个站点独占信道, 一个站点成功发送完一个数据帧后, 连续发送下一个帧时要启动退避算法。
    
        4) 空闲时等待一个DIFS后发送数据帧。

信道预约:

        1)为减少碰撞的概率和降低碰撞的影响, 源站发送数据帧前要发送一个短的控制帧。即请求发送RTS (Request To Send), 其包括源地址, 目标地址, 通信所需时间(包括确认帧)。
    
        2) 若信道空闲, 目的站就发送一个响应, 即允许发送CTS (Clear To Send )。也包括通信持续时间。
    
        3) 除源站和目的站以外, 其他站收到CTS (或数据帧) 后推迟接入到无线局域网中。如果RST发送碰撞, 需执行退避算法重传RTS。

虚拟载波监听:

        RTS 帧和CTS 帧即数据帧都会携带通信持续时间, 这便叫虚拟载波监听, 但站点检测到正在信道中传送的MAC首部的 "持续时间" 字段时, 会调整自己网络分配向量 NAV (Network Allocation Vector)。

原理图:



        网络分配向量NAV: 指出信道忙的持续时间。源站是SIFS+CTS+SIFS+数据帧+SIFS+ACK, 目的站是SIFS+数据帧+SIFS+ACK。

轮询协议图:



令牌传递协议原理图:

3.5 局域网(Local Area Network)
决定局域网特性的三个要素: 

介质访问控制方式(最重要)
网络拓扑结构
传输介质
局域网分类:

以太网: 逻辑拓扑是总线型结构, 物理拓扑是星形或拓展星形, 符合IEEE802.3标准
令牌环(IEEE802.5): 逻辑拓扑是环形结构, 物理拓扑是星形结构
FDDI(光纤分布数字接口, IEEE802.8): 逻辑拓扑是环形结构, 物理拓扑是双环结构
无限局域网: 采用IEEE802.11标准
IEEE802.1Q: VLAN
        IEEE802标准定义的局域网: 对应OSI参考模型的数据链路层和物理层, 将数据链路层拆分为逻辑链路控制子层(LLC)和媒体接入控制子层(MAC)。

        LLC主要功能: 向网络层提供无确认无连接, 面向连接, 带确认无连接, 高速传送, 给帧加序号
    
        MAC主要功能: 与接入媒体有关的内容, 如组帧, 拆卸帧, 比特传输差错检测, 透明传输

示例图:



3.5.1 以太网
        采用无连接工作方式, 不可靠传输, 差错纠正由高层完成, 发送的数据使用曼彻斯特编码。采用 CSMA/CD 介质访问控制方式。以太网是局域网的一种实现方式, 工作在OSI参考模型的下两层。

        MAC地址: 全球唯一物理地址, 占6字节。

以太网的传输介质图(常识):



MAC帧图:



        填充: 0~46字节(最短MAC帧长度为18字节, 以太网帧数据字段最短帧长64B, 最大1500B) 。
    
        校验码(FCS): 不检验MAC帧数据部分和前导码。 采用32位循环冗余码(CRC)

高速以太网:



        快速以太网: 使用CSMA/CD协议, 保持最短帧长不变, 将最大电缆长度减少到100M。

3.5.2 无线局域网 
IEEE802.11 帧最常见的两种情况:



808.11数据帧:



3.5.3 虚拟局域网VLAN
        将局域网内的设备划分成与物理位置无关的逻辑组的技术, 每个VLAN是一个较小的广播域

IEEE802.1Q帧:





备注:

VLAN标记的后12位是VLAN标识符VID， 唯一表示了该以太网帧属于哪个VLAN。
VLAN的有效VID取值范围为1～4094。 
IEEE 802.1Q帧是由交换机来处理的，而不是由用户主机来处理的。
 以太网交换机构成虚拟局域网:



        备注: 交换机与交换机之间是802.1Q帧, 交换机与主机之间是标准以太网帧。 

划分VLAN的方式:

        1) 基于交换机接口: 
    
        2) 基于MAC地址: 主机与从一个交换机移动到另一个交换机, 也仍属于一个子网
    
        3) 基于IP地址: 跨路由器扩展子网

3.6 广域网
        将分布在不同地区的局域网或计算机系统互连起来, 达到资源共享的目的。如因特网(Internet)是最大的广域网。点对点通信。工作在OSI参考模型的下三层

广域网与局域网的区别与联系:



3.6.1 ppp协议
        只支持全双工链路。标志字节7E, 转义字节7D

ppp协议的三个组成部分:

一个将IP数据报封装到串行链路的方法
链路控制协议(LCP): 用于建立、配置、测试和管理数据链路。身份验证
网络控制协议(NCP): ppp可支持多种网络层协议, 每个不同的网络层协议要用一个相应的NCP来配置
ppp协议状态图:



ppp协议帧格式图:



ppp协议特点:

提供差错检测但不提供纠错功能, 不可靠传输, 即不使用序号和确认机制
仅支出点对点的链路通信, 无需CSMA/CD协议, 也就无最短帧长限制。
只支持全双工链路
ppp的两端可以运行不同的网络层协议
面向字节, PPP帧的长度是整数个字节
异步传输使用字节填充法, 同步传输采用硬件来零比特填充法。
3.6.2 HDLC协议***
        面向比特, 可靠传输, 差错检测不纠错, 采用全双工通信。

HDLC帧格式图:



3.7 数据链路层设备
物理层扩展以太网:



链路层扩展以太网:



         网段: 一般指一个计算机网络中使用同一物理层设备(传输介质, 中继器, 集线器)能够直接通讯的那一部分。

以太网交换机的两种交换方式:

        1) 直通式交换机: 查完目的地址(6B) 就立刻转发, 延迟小, 可靠性低, 不支持不同速率的端口交换。
    
        2) 存储转发式交换机: 检查帧是否正确, 可靠性高, 支持不同速率的端口交换。

冲突域和广播域: 



        VLAN: 可隔离冲突域, 也可隔离广播域
    
        网卡: 主要功能在物理层和数据链路层。

第四章 网络层
4.1 网络层概述
        异构网络互连, 向上只提供简单灵活的, 无连接的, 尽最大努力交付的数据报服务。

        网络拥塞: 当网络中有大量分组需要从某条链路转发时, 出现分组丢失的情况。(队满情况)

拥塞控制的两种方法:

开环控制: 静态预防方法, 设计网络时事先将有关发生拥塞的因素考虑周到。
闭环控制: 动态方法, 采用监测网络系统去监视, 并解决拥塞。
        无连接服务：不事先为分组的传输确定传输路径，每个分组独立确定传输路径，不同分组传输路径可能不同。

4.1.1 网络层提供的两种服务
         1) 虚电路：一条源主机到目的主机类似于电路的路径（逻辑连接, 电路不是专用）, 分组包含虚电路号, 区别其他虚电路上的分组。

虚电路网络图:



        虚电路特点: 提供了可靠通信功能, 不会乱序、重复或丢失。两个端系统之间也可有多条虚电路为不同的进程服务。缺点是某个结点出现故障时, 经过该结点的所有虚电路将遭到破坏。 

2) 数据报网络图:



 数据报与虚电路区别图:



4.1.2 路由器
         历史原因, 有称为网关, 网络层最核心的功能:  分组转发和路由选择。用路由器互连的多个局域网的网络层协议可以不同 (如IPV4与IPV6)

        转发: 仅涉及一个路由器, 转发表根据路由表得出。
    
        路由选择: 涉及很多路由器, 

路由器的结构:



 三种交换结构图***: 



4.1.3 软件定义网络SDN
        采用集中式的控制平面和分布式的数据平面, 两个平面互相分离, 通过Openflow协议将转发表下发给路由器。路由器查找转发分组即可。

        SDN的可编程性通过北向接口提供编程接口, 和转发设备建立双向会议的称为南向接口, SDN控制器之间的通信接口称为东西向接口

SDN特点:

全局集中式控制和分布式高速转发, 灵活可编程与性能平衡
集中管理易受攻击, 随着网络规模扩大, 控制器可能成为网络性能瓶颈 
4.2 IPV4与IPV6及其相关协议
        IP地址实际上标记的是一个主机(或路由器)和一条链路的接口。

4.2.1 IPV4       
        首部的固定长度占20个字节, 后面是可选字段, 首部长度可变。

IP数据报图:



各字段:

1) 版本 : 占4位, IP协议版本, 如4 (IPv4)

2) 首部长度: 占4位, 单位是32位即4个字节。不足4字节由填充字段补齐。

3) 总长度: 占 16位, 首部和数据之和的长度, 单位为字节。一般大于576字节,小于1500字节

4) 标识 :占16位, 每产生一个数据报, 计数器+1, 用于分片时使用。标识同一个数据报

5) 标志: 占3位,第一位为MF, MF=1表示后面还有分片; 第二位为DF, DF=0表示可以分片。

6) 片偏移: 占13位, 单位是8个字节, 表示某片在原分组中的相对位置, 分片的长度一定是8字节的整数倍。

7) 生存时间(TTL): 占8位, 每一跳减少1;

8) 首部检验和: 占16位, 仅校验首部

9) 协议: 6表示TCP, 17表示UDP

检验和计算图: 



数据报分片图:



4.2.2 IP地址及编址方式
        点分十进制记法: IP地址由32位二进制构成, 每8位用等效十进制数字表示。

        多归属主机: 一个主机同时连接到两个网络上时, 该主机必须同时具有两个相应的IP地址, 如: 路由器
    
        分类编址: 每一类地址由两个固定长度字段组成, 一个是网络号, 一个是主机号

分类编址图:



私有地址: 



特殊IP地址:



        网络地址转换(Network Address Translation): NAT能使内部专用地址的专用网络用户共享少量外部全球地址, 以此来访问因特网上的主机和资源。NAT工作在传输层

 NAT原理图:



子网掩码示例图:



        无分类编址CIDR: 无分类域路由选择, 把32位IP地址分成两个部分, 前面连续的全1表示网络号, 后面全0部分指明主机。 

举例:



        斜线记法:即在IP地址后面加上斜线 "/" , 然后写上网络前缀所占的位数。如上图: 192.168.10.215/24
    
        CIDR地址块: 把网络前缀都相同的连续IP地址组成一个CIDR地址块。即路由聚合, 又称构成超网。

构成超网:



        最长前缀匹配: 路由表中可能存在多个包含关系的地址块前缀, 查找可能不止一个匹配结果, 应当从匹配结果中选择具有最长网络前缀的路由。 
    
        默认路由: 用特殊0.0.0.0/0 表示默认路由。
    
        子网划分: 分为等长子网划分 (如: 00,01,10,11 (子网号能否全0全1看情况) ) 和不等长子网划分(如: 0,10,110,1110), 子网划分不增加网络数量。

4.2.3 地址解析协议 ARP (Addresss Resolution Protocol) 
        IP地址放在IP数据报首部, 物理地址则放在MAC帧首部; 物理地址是数据链路层及以下使用的地址, IP地址是网络层及以上各层使用的地址, 是一种逻辑地址。

        ARP: 地址解析协议, 由IP地址找出相应的物理地址
    
        RARP: 逆地址解析协议, 由物理地址, 得出IP地址

IP地址与物理地址图: 



原理:

        1) 每一个主机都有一个ARP高速缓存, 其中存有本局域网上个主机和路由器的IP地址到物理地址的映射表。
    
        2) 主机A向本局域网主机B发送IP数据报时, 先查看ARP高速缓存有无B主机的IP地址, 若有, 则通过局域网把MAC帧发往此物理地址, 若无, APR进程在本局域网广播一个ARP请求分组 (目的MAC为地址为FFFF-FFFF-FFFF)。
    
        3) ARP请求分组是数据链路层的广播, 但ARP响应分组是数据链路层单播
    
        4) 主机A在发送ARP请求分组时, 就把自己的IP地址核物理地址映射写入ARP请求分组, 所有接收到ARP广播的主机都会更新自己的ARP高速缓存。
    
        5) ARP用于解决同一个局域网上的主机或路由器的IP地址和物理地址映射问题。
    
        6) ARP高速缓存中的每一个映射地址项目都设置有生存时间(10~20min)。

原理图:


4.2.4 网际控制报文协议 ICMP (Internet Control Message Protocol)
        ICMP差错报告中的数据字段由IP数据报的首部和数据字段的前8个字节组成。是网络层协议。

ICMP差错报文图:



ICMP差错报告报文:

        1) 终点不可达: 路由器或主机不能交付数据报时, 就向源点发送终点不可达报文
    
        2) 源点抑制: 因拥塞而丢弃数据报时。
    
        3) 时间超时: 当目的地址不是自己时, 会将TTL-1再转发出去, TTL减为0时。
    
        4) 参数问题: 收到的数据报的首部中有的字段的值不正确时
    
        5) 改变路由: 即重定向, 让主机知道下次应将数据报发送给另外的路由器。

以下情况不发送ICMP差错报告:

        1) 对ICMP差错报文不再发送ICMP差错报文
    
        2) 对第一个分片的数据报片的所有后续数据报片
    
        3) 具有多播地址的数据报
    
        4) 对特殊地址, 如:127.0.0.1

ICMP询问报文类型:

回送请求和回答报文
时间戳请求和回答报文
地址掩码请求和回答报文
路由器询问和通告报文 
应用举例:

        1) ping指令: 使用了ICMP的回送请求和回答报文
    
        2) tracert指令(Windows操作系统)

4.2.5 IPV6
        从更本上解决地址耗尽问题, 支持QoS。没有IPV4的校验和字段。

IPV6数据报格式:



特点:

地址位扩大到128位
支持即插即用, 不需要DHCP协议
首部长度必须是8B整数倍
只能在主机处分片
取消了检验和字段
地址表示形式:

        1) 一般形式: 冒号十六进制记法
    
        2) 压缩形式: 省略开头连续的0, 但在域中至少要一个数字; 或双冒号表示法, 进一步省略连续的0, 仅能出现一次。

示例图:



基本地址类型:

单播
多播
任播
IPV6过渡策略:

        1) 双栈协议:一台设备同时启用IPV4和IPV6协议栈。
    
        2) 隧道技术: IPV6要进入IPV4时, 把整个IPV6数据报封装到IPV4数据报的数据部分。

4.3 路由算法及其相关协议
        因特网将整个互联网划分为许多较小的自治系统, 称AS。一个大的ISP就是一个自治系统。AS之间再做路由。

        静态路由算法: 又称非自适应路由算法, 需由网络管理员手工配置路由信息。
    
        动态路由算法: 即自适应路由算法, 通过相互连接的路由器之间彼此交换信息, 按照一定算法优化出路由表, 一定时间时隙里不断更新路由信息。 
    
        内部网关协议 IGP:  自治系统内部使用的路由选择协议, 也称域内路由选择, 如RIP、OSPF协议。
    
        外部网关协议 EGP:  自治系统间的路由选择协议, 也称域间路由选择, 如BGP协议。

关系图:



 4.3.1 RIP (Routing Information Protocol)
        RIP协议即路由信息协议, 是一种分布式的基于距离向量(DV)的路由选择算法。应用层协议, 使用UDP传送数据。

 RIP协议报文格式:



工作原理:

        1) 每一个路由器都要维护从它自己到其他每一个目的网络的距离记录
    
        2) 距离即跳数, 每经过一个路由器, 跳数就+1, 距离=16相当于不可达。
    
        3) 仅和相邻路由器交换路由表, 交换的信息是自己的路由表, 按固定时间(如30s)周期性更新, 或网络拓扑变化时更新, 即触发更新。 
    
        4) 收到相邻路由器的路由表,找出到达每个目的网络的最短距离和下一跳路由器, 并更新自己的路由表。

特点:

实现简单, 但只适用于小型互联网
坏消息传播得慢, 导致回路的更本原因
坏消息传递慢示例图:



4.3.2 OSPF (Open Shortest Path First)
        OSPF 协议即开放最短路径优先。使用分布式的链路转态(LS)路由选择算法, 是网络层协议(IP首部协议字段为89)。

OSPF分组: 



工作原理:

        1) 向本自治系统中所有路由器发送与本路由相邻的所有路由器的链路状态, 最终所有路由器都建立一个链路状态数据库, 即全网的拓扑结构图, 再根据 dijkstra算法求得最优路径的路由表 (路由表不会存储完整路径, 仅有下一跳)。
    
        2) 当链路转态发生变化时, 路由器向所有路由器泛洪法发送此信息, 同时也会周期性洪泛更新信息。
    
        3) 为了使OSPF能用于规模很大的网络, 可以把一个自治系统划分为若干更小的范围, 叫作区域, 一个区域内的路由器最好不超过200个。
    
        4) 刚刚开始工作时, 路由器只知道直接连接的网络的距离, 经过若干次更新后, 所有路由器都会知道到达本自治系统中任意一个网络的最短距离和下一跳路由器地址。
    
        划分区域: OSPF将一个自治系统划分为若干更小的范围, 称为区域, 好处是泛洪法交换链路状态信息范围便局部在每个区域。 

划分区域示例图:



特点:

        1)  可以有多条相同代价路径, 可以将流量分配给这几条路径, 实现负载平衡。
    
        2) 每10s交换一次问候分组, 每30min更新一次, 更新过程收敛的快, 适用于互联网规模很大时
    
        3) 对于不同类型业务可以计算不同的路由
    
        4) 每个链路状态都带上一个32位序号, 序号越大, 状态越新。

4.3.3 外部网关协议 BGP (Broder Gateway Protocol)
        只是力求寻找一条能够到达目的网络且比较好的路由,需要根据策略进行路由选择(策略包括政治、经济、安全方面)。

        只需要在发生变化时更新有变化的部分。是应用层协议, 基于TCP。

BGP协议报文格式: 



工作原理:

        建立TCP连接, 相邻结点互相通告自己到所有目的地的路径信息。
    
        每一个AS的管理员选择至少一个路由器作为AS的BGP代言人, 负责在AS间交换路由信息。
    
        各BGP根据所采用的策略从收到的路由信息中构建出树形结构的AS连通图。

示例图: 





BGP-4的四种报文:

OPEN(打开)报文: 用来与相邻的另一个BGP发言人建立关系
UPDATE(更新)报文: 通知新路径或撤销原路径
KEEPALIVE(保活)报文: 周期性证实邻站的连通性
NOTIFICATION(通知)报文: 报告先前报文的差错, 或用于关闭连接。
三种协议的比较图:  



4.4 IP组播与移动IP
4.4.1 IP组播
        组播一定仅应用与UDP, 把一个分组发送给多个目的主机, 使用D类地址, 组播地址标识一组地址。

1) 单播:



2) 多播(组播): 



硬件组播:



        备注: 组播IP地址与以太网硬件地址的映射关系不是唯一的, 还需要在IP层利用软件进行过滤。 
    
        因特网组管理协议IGMP: 让路由器知道本局域网是否有主机参加或退出了某个组播组。实际上就是要找出以源主机为根节点的组播转发树。使用IP数据报传递报文。

IGMP工作的两个阶段：

        1) 主机要加入组播组, 向组播组的组播地址发送一个IGMP报文, 本地组播路由器收到后, 利用组播路由选择协议把这组成员关系发给因特网上其他组播路由器。
    
        2) 本地组播路由器周期性探询本地局域网上的主机, 只要一个主机对某个组响应, 就认为这个组是活跃的, 几次探询没有回应, 则不再把这组成员关系发给其他的组播路由器。

4.4.2 移动IP
        指移动站以固定的网络IP地址实现跨越不同网段的漫游功能。代理功能在应用层完成。

相关术语: 

移动结点: 具有永久IP地址的移动设备(区别于DHCP分配的私有地址)
归属代理: 本地代理, 一个移动结点拥有的就"居所"。
外部代理: 外地代理, 在外部网络中帮助移动节点完成移动管理功能的实体
移动通信过程: 



第五章 传输层
网络层与传输层区别:

       网络层提供主机到主机之间的逻辑通信, 而传输层为应用进程之间提供端到端的逻辑通信

区别图:



​        

        复用: 多个应用进程可同时使用传输层的服务
    
        分用: 传输层把收到的信息分别交付给上面应用层的相应进程
    
        端口: 端口是应用层与传输层之间接口的抽象, 端口号是应用进程的传输层地址。端口用16位端口号进行标记, 允许有65535个端口号,分为熟知端口、登记端口、动态端口。
    
        熟知端口: 其数值为0~1023。由因特网赋号管理局分配给常用的应用层程序固定使用。

如: 

DNS - 53



        登记端口: 数值为1024-49151。不分配也不控制, 可以先IANA注册登记, 防止重复使用。
    
        动态端口: 其数值为49152-65535。留给客户进程选择的临时端口。

常见应用:



5.1 UDP
        DUP传送的数据单元是用户数据报，首部字段由四个部分组成, 每个部分都是2个字节,共8个字节。

特点:

        1) 无连接, 减少开销和发送数据前的时延
    
        2) 尽最大努力交付, 即不可靠交付, 但不需要维持许多参数、复杂连接状态表。
    
        3) 没有拥塞控制, 不因拥塞降低发送速率, 适合实时应用。
    
        4) 面向报文, 不对应用层交下来的报文行划进分分组, 因此应用层要交合适大小的报文, 太大,IP传送时需要进行分片, 太小, IP首部相对较大, 都会降低IP层的效率。
    
        5) 支持一对一, 一对多, 多对一, 多对多交互通信。
    
        6) 首部只有8个字节开销, 比TCP至少20个字节是首部要短。

 UDP首部字段图:



首部字段: 

        1) 源端口: 源端口号
    
        2) 目标端口: 目标端口号
    
        3) 长度: 首部和数据之和的长度, 单位为字节。
    
        4) 检验和: 差错检验码, 防止UDP用户数据报在传输中出错, 可选字段(全0表示不检验)

 UDP计算检验和方法:

        1) 与IP只检验首部不同, UDP的检验会把首部和数据部分一起检验。
    
        2) 首先将全0放入检验和字段中, 将伪首部及用户数据看成16位的字串,不是偶数个字节, 则加入一个全0字节。而后按二进制反码计算出这些16位字的和, 将此二进制反码写入检验和中。
    
        3) 接收方收到的UDP用户数据报连同伪首部一起, 按二进制反码求这些16位字的和, 无差错时结果为全1, 否则就丢弃这个错误的UDP数据报。
    
        4) 伪首部既不下传, 也不上交, 仅仅是计算检验和。
    
        5) 伪首部的第三个字段为全0, 第四个字段是UDP协议字段, 固定17。

示例图:



5.2 TCP
        MMS: 最大报文段长度 (数据段部分)

5.2.1 TCP报文段首部格式
        TCP的数据单元是报文段, 首部的前20个字节是固定的, 后面有4N个字节是根据需要而增加的选项。面向字节流

首部字段:

        源端口与目标端口: 各占两个字节,与UDP一样, 用于传输层的复用和分用
    
        序号: 占4个字节, 从0开始到2^32 - 1为止, 可对4GB的数据进行编号。每一个字节都要按顺序编号。整个数据的起始序号在连接建立时约定; 首部中的序号字段值表示本报文段所发送数据的第一个字节序号。
    
        确认号: 占4个字节, 是期望收到对方的下一个报文段的第一个数据字节的序号。如:收到序号为501, 数据长度为200, 则期待收到的下一个数据序号是701。
    
        数据偏移: 占4位, 指出TCP报文段的数据起始处距离TCP报文段的起始处有多远。即TCP报文段首都的长度。数据偏移的单位是32位字,(即4字节) 最大表示范围是60字节, 即TCP首部最大长度。
    
        确认位ACK: 置为1时, 确认号字段才有意义
    
        紧急位URG: URG=1时, 表明报文中有紧急数据。配合紧急指针使用
    
        同步位SYN: SYN=1时, 表明是一个连接请求/接受报文
    
        终止位FIN: FIN=1时, 要求释放链接
    
        保留: 占6位, 暂不使用。
    
        窗口: 占2个字节, 指示发送方的接受窗口大小。窗口用来控制对方发送的数据量。   
    
        检验和: 占2字节, TCP伪首部的第四个字段为TCP的协议号16，其计算与UDP检验和一样。

TCP首部字段图:



TCP的主要特点:

        1) 面向连接: 传输数据前, 必须先建立TCP连接
    
        2) 每一条TCP连接只能是点对点的
    
        3) 可靠交付的服务, 通过TCP连接传送的数据无差错、不丢失、不重复、按序到达。
    
        4) 全双工通信, 允许通信双方的应用进程在任何时候都能发送数据, 两端都设有发送缓存和接收缓存。
    
        5) 面向字节流, TCP把应用进程交下来的数据块看成是一连串无结构的字节流进行封装发送。

5.2.2 TCP连接管理
       TCP是面向连接的议协。TCP连接分三个阶段. 即连接建立, 数据传送, 连接释放。

三次握手:

        1) 客户端进程发出请求报文段, 首部SYN置为1, 同时选择一个序号seq=x。TCP客户端进入SYN-SENT (同步已发送)状态。
    
        2) 服务器进程发回连接确认请求, 在确认报文段中把SYN和ACK都置为1, 确认号是ack=x+1, 同时为自己定义一个序号seq=y。TCP服务进入 SYN-RCVD ( received 同步收到)状态。
    
        3) 客户端进程收到连接确认后, 还要向服务器进程给出确认, 同时可携带数据。ESTABLISHED (已建立连接)状态。第三次握手不携带数据则不消耗序号!
    
        备注: SYN=1的报文段不能携带数据, 但要消耗一个序号。

TCP连接图:



        SYN洪泛攻击: 服务器的资源在完成第二次挥手时分配的, 客户端的资源在完成第三次握手时分配, 因此服务器易受到SYN洪泛攻击。

四次挥手: 

        1) 客户端把发往服务器的报文段首部 FIN=1, seq=u (之前已传送的最后一个字节的序号+1)。TCP客户端进入FIN-WIT-1(终止等待1)状态。
    
        2) 服务器收到释放连接通知后, 发出确认号ack=u+1。服务器进入CLOSE-WAIT(关闭等待)状态。这样, 客户端到服务器的连接就释放了, 连接处于半关闭状态。但客户端仍能接受服务器发送的数据, 并给出确认。客户端进入FIN-WIT-2。
    
        3) 当服务器不再向客户端发送数据时, 发出FIN=1, seq=w, ack=u+1(基于上次), 这时服务器进入 LAST-ACK (最后确认)状态。客户端进入TIME-WAIT。
    
        4) 客户端收到连接释放报文段后, 回复ack=w+1, seq=u+1 但客户端的TCP不能马上释放, 还要等待最长报文段寿命时间(2MSL)才能释放整个连接。因为服务器可能重发(3)。最后, 客户端进入CLOSED(连接关闭)状态。

TCP连接释放图:



5.2.3 TCP可靠传输
        TCP在IP的不可靠的尽最大努力服务的基础上实现了可靠的数据传输服务, 即数据无差错、不丢失、按序不重复。

数据编号与确认:

        1) TCP协议是面向字节的, 一个字节对应一个序号。连接建立时, 双方TCP要各自确定初始序号。报文段中的序号字段值表示该报文中第一个数据字节的序号。
    
        2) TCP使用的是累积确认, 即确认是对所有按序接收到的数据的确认(已按序收到的数据的最高序号+1)。确认号表示接收方期望下次收到的数据中的第一个数据字节序号。如:已经收到了1~700, 801~1000, 那么发送的确认序号应填入701。
    
        4) TCP采用了一种延迟确认机制, 即接收方有数据发送给对方, 则可以捎带确认, 也可能这段时间内又有数据到达, 则可以对这两次到达的数据进行累积确认, 提高效率。
    
        5) 收到重复的报文段, 丢弃的同时要立即发回确认信息。

 累计确认示意图:



        超时重传机制:  TCP发送方每发送一个报文段, 就会为这个报文段设置一个计时器。时间到了但还没有收到确认,就要重传这一报文段。即超时重传。超时重传时间应当比当前往返时间(RRT)要长一些。

超时重传图:



        快速重传机制: 一个报文段的丢失会引起发送方连续收到多个重复确认, 快速重传即当发送方一连收到三个重复确认后, 立即重传丢失的报文段。

快速重传示意图:



5.2.4 TCP流量控制
        TCP采用接收方控制发送方发送窗口大小的方法来实现, 即在TCP报文段首部窗口字段是当前接收方的接受窗口大小。TCP发送方的发送窗口大小必须小于该值。

可变窗口进行流量控制图:



        窗口探测:为防止当发送方窗口为0, 而接收方发送的窗口更新报文段丢失而导致的死锁状态, 当发送方还有数据发送时, 会周期性地(如: 60s)发送只包含1个字节数据的窗口探测报文段, 以便强制接收方发回确认并通告接收窗口大小。

5.2.5 TCP拥塞控制
        慢开始: cwnd<ssthresh时, 每经过一个RRT(往返时间), 发送方的平均发送速率增加一倍。

        2) 慢启动门限(ssthresh): 发生拥塞状态下窗口大小值的一半, 当cwnd>=ssthresh时, 启动拥塞避免算法。
    
        3) 拥塞避免:当cwnd>=慢启动门限时, 就增加一个MSS大小, 按线性规律缓慢增长,直到发生拥塞。同时修改ssthresh。

 慢启动与拥塞避免算法图:



 快重传快恢复图:



        发送窗口上限值: Min( rwnd, cwnd ) 

第六章 应用层
6.1 网络应用体系结构
6.1.1 客户端/服务器结构
        客服端: 服务请求方, 不总是处于开机状态, 主动请求服务,客户端进程间不能直接通信。

        服务器: 服务提供方, 总是处于运行状态, 等待客户端请求, 服务器进程有固定端口号, 运行服务器的主机有固定的IP地址。

C/S模式图:



6.1.2 对等体结构
        没有固定的服务请求者和服务提供者, 分布在网络中的应用进程是对等的, 称为对等方, 每个对等方即是服务请求者, 又是服务提供者。最突出特性是它的可扩展性, 每增加一个对等方, 不仅增加服务请求者, 也增加了服务提供者。

P2P图:

6.2 域名系统 DNS (Domain Name System)
       域名到 IP 地址的转换过程, 以UDP数据报方式发给本地域名服务器。

备注:

多个IP地址可以映射到同一个域名上
负载分配: 允许同一个主机名对应一个IP 地址集合; 热门网站可以多个服务器, 共享同一个域名
一台主机可以映射到多个域名上
每一级域名由数字和英文字母(不区分大小写)组成,不超过63个字符, 完整的的域名不超过255字符。
三类顶级域(TLD):

国家顶级域名: 如 cn 中国 、us 美国 、 uk 英国。
通用顶级域名：如 com 公司企业、 net 网络服务机构、org 非营利性组织、int 国际组织。
反向域: 用于反向域名解析, 将IP 反向解析为域名
域名空间树状图:



四种域名服务器:

根域名服务器: 不直接把待查询的域名转成IP地址, 知道所有顶级域名服务器的域名及其IP 地址
顶级域名服务器: 收到DNS请求可能返回结果, 也可能是下一级权威服务器名服务器的IP地址
权威服务器: 负责管理某个区的域名服务器, 每一个主机的域名都必须在某个权威域名服务器处上登记 (总能将其管辖的主机名转化为IP地址)。也知道其下级权威域名服务器地址。
本地域名服务器: 起DNS代理作用, 将查询报文转发到域名服务器登记结构中。
DNS划分区图:



域名解析过程:

        递归查询:  主机向本地域名服务器的查询一般是递归查询, 即本地域名服务器不知道被查询域名的IP地址时, 本地域名服务器以DNS客户的身份向某个根域名服务器发出查询请求报文(替该主机查询)。
    
        迭代查询:   本地向根域名服务器发出请求后, 根域名服务器将顶级域名服务器的IP 地址告诉本地服务器,由本地服务器再向顶级服务器发出查询, 以此类推,直到向权威服务器查询到结果。

示例图: 



高速缓存域名服务器:

        1) 缓存最近查询过的域名。重复查询相同域名时, 不必在向根域名服务器发起请求。
    
        2) 由于IP 地址的绑定可能会发生变化, 缓存的域名会内置计时器(一般是48小时), 到时后将删除缓存。
    
        3) 增加时间值可以减少网络开销, 减少此时间值可提高域名解析的准确性。

6.3 文件传送协议 FTP (File Transfer Protocol)
        FTP基于客户/服务器体系结构, 主进程, 负责接受请求; 若干个从属进程, 负责处理单个请求, 由此两大部分组成。

两个从属进程:

        1) 控制进程: 控制连接在整个会话期间一直保持,接受客户端发出的各种命令。
    
        2) 数据传输进程: 数据连接是非持续的, 即上传完一个文件后就关闭连接。分以下两种模式: 主动模式PORT服务器的20端口连接到客户端; 被动模式PASV, 客户端连接到服务器随机端口。

原理图:



6.4 电子邮件 (SMTP&POP3)
        电子邮件采用客户端/服务器体系结构, 采用 SMTP(Simple Mail Transfer Protocol) 简单邮件传送协议、POP3(Post Office protocol) 邮局协议。

        用户代理(User Agent): 用户与电子邮件系统的接口, 又称电子邮件客户机软件。  

原理图:



两种不同通信方式:

推: 发件人通过 STMP 协议将邮件 "推" 给用户代理, 用户代理将邮件 "推" 接受方服务器。 
拉: 收件人通过 POP3 把邮件从服务器中 "拉" 过来。
TCP/IP体现的电子邮件地址格式:

收件人@邮箱所在邮件服务器的域名

IMAP（Internet Message Access Protocol）与POP3:

        1) POP3: 邮件协议第三版, 提供下载并删除和下载并保留的两种工作方式。110端口
    
        2) IMAP: 因特网邮件访问协议, 在POP3的工作方式基础上, 可以管理服务器上的邮件。允许用户代理只获取报文的某些部分。

MIME (Multipurpose Internet Mail Extensions) 多用途网际邮件扩充:



        基于HTTP的电子邮件: 客户端到服务器之间使用 HTTP, 而不同服务器间使用 SMTP 协议。 

示意图:



6.5 万维网 WWW (World Wide Web)
        万维网以客户端/服务器方式工作。

        超文本: 带有链接的文本,也叫超链接。
    
        超媒体: 包含文本信息及其他多媒体对象, 如图形、声音、视频等。
    
        超文本传送协议: HTTP
    
        超文本标记语言: HTML
    
        URL的格式: <协议>://<主机>:<端口>/<路径>, Uniform Resource Locator即统一资源定位符。
    
        超文本传送协议 HTTP: 默认端口80, 使用TCP传输层协议, 是无状态协议, 即同一个客户上一次对服务器的访问不影响下一次的访问结果。

HTTP请求过程图:



非持续与持续连接:

        1) HTTP/1.0 协议: 采用非持续连接方式, 即一次请求/响应对应一次TCP连接(三次握手)。
    
        2) HTTP/1.1 协议: 使用持续连接方式, 即响应后仍然保持这条连接。此协议还可以使用流水方式工作, 即收到HTTP的响应报文前,就可以连续发送多个请求报文。

区别图:



HTTP的报文格式:



HTTP请求报文的方法:



状态码:



        Cookie: 对无状态的HTTP进行状态话的技术

Cookie原理图:



万维网缓存与代理服务器***:

        1) web缓存: 即万维网缓存, 可位于客户机或中间系统, 在中间系统称为代理服务器。当请求到达时,若主机有请求的缓存, 则返回缓存的响应报文。
    
        2) web缓存命中率较高时,可减少访问因特网的时延, 代理服务器另一个作用是可以用来隔离内外网络。
    
        3) 实际上web 对象可能被缓存在从浏览器到原始服务器路径的多个地方, 服务器为每个响应的对象设定一个修改时间和有效时间, 对象到期前, 可以直接返回缓存对象, 到期之后,缓存会使用条件GET请求向原始服务器验证对象是否存在最新版, 若修改则返回新版本对象。

6.6 动态主机配置协议 DHCP (Dynamic Host Configuration Protocol)
        允许一台计算机加入新的网络和获取IP地址而不用手工参与,称为即插即用连网。

原理:

        DHCP 使用客户端/服务器方式。
    
        需要自动获取IP地址的主机启动时在本网用UDP广播发送一个DHCP发现报文,其目的IP地址为255.255.255.255，自己的IP 地址默认为全0。
    
        通过DHCP 中继代理转发DHCP发现报文。
    
        DHCP 服务器通过UDP回应DHCP中继代理一个DHCP提供报文, 包含IP地址等配置信息。
    
        DHCP 中继代理在将此DHCP提供报文发回给主机。

————————————————

                            版权声明：本文为博主原创文章，遵循 CC 4.0 BY-SA 版权协议，转载请附上原文出处链接和本声明。

原文链接：https://blog.csdn.net/s6664/article/details/131762041

前言
为了准备期末考试，同时也是为了之后复习方便，特对计算机网络的知识进行了整理。本篇内容大部分是来源于我们老师上课的ppt。而我根据自己的理解，将老师的PPT整理成博文的形式以便大家复习查阅，同时对于一些不是很清楚的地方，我去查阅了相关资料进行补充，当然也会有少部分个人看法夹带其中来帮助大家理解。

应评论要求这里放上本文的思维导图以供大家更好的查看


一、计算机网络概述
1 互联网的构成
网络边缘:位于互联网边缘与互联网相连的计算机和其他设备,如桌面计算机、移动计算机、服务器、其他智能终端设备
网络核心:由互联端系统的分组交换设备和通信链路构成的网状网络
如：分组交换路由器、链路层交换机、通信链路(光纤、铜缆、无线电、激光链路)

2.网络分类
个域网PAN（ Personal Area Network ）

能在便携式消费电器与通信设备之间进行短距离通信的网络
覆盖范围一般在10米半径以内，如蓝牙耳机等
局域网LAN（Local Area Network）

局部地区形成的区域网络，如企业网络
分布地区范围有限，可大可小，大到一栋建筑、小到办公室内的组网
电脑WLAN接入，打印机共享等等
城域网MAN（Metropolitan Area Network ）

范围覆盖一个城市的网络
广域网WAN（Wide Area Network）

覆盖很大地理区域，乃至覆盖地区和国家
3.接入网
接入网的用途

接入网的用途是将主机连接到边缘路由器上
边缘路由器是端系统Host去往任何其他远程端系统的路径上的第一台路由器
各种异构网络通过边缘路由器接入

接入网分类：

光纤到户FTTH
数字用户线DSL
同轴电缆
无线接入
企业和家庭网络
4.网络核心的两大功能
①路由
确定数据分组从源到目标所使用的路径（全局操作）

②转发
路由器或交换机将接收到的数据分组转发出去（即移动到该设备的某个输出接口）（本地操作）

5.网络分层
①OSI 7层模型


数据链路层 (Data Link Layer)

实现相邻（Neighboring）网络实体间的数据传输
成帧（Framing）：从物理层的比特流中提取出完整的帧
错误检测与纠正：为提供可靠数据通信提供可能
物理地址（MAC address）：48位，理论上唯一网络标识，烧录在网卡，不便更改
流量控制，避免“淹没”（overwhelming）:当快速的发送端遇上慢速的接收端，接收端缓存溢出
共享信道上的访问控制（MAC）：同一个信道，同时传输信号。如同：同一个Wifi热点（AP）连接着多个无线用户（手机），则多个用户同时需要发送数据，如何控制发送顺序？
网络层 (Network Layer)

将数据包跨越网络从源设备发送到目的设备（host to host）
路由（Routing）：在网络中选取从源端到目的端转发路径，常常会根据网络可达性动态选取最佳路径，也可以使用静态路由
路由协议：路由器之间交互路由信息所遵循的协议规范，使得单个路由器能够获取网络的可达性等信息
服务质量（QoS）控制：处理网络拥塞、负载均衡、准入控制、保障延迟
异构网络互联：在异构编址和异构网络中路由寻址和转发
传输层 (Transport Layer)

将数据从源端口发送到目的端口（进程到进程）
网络层定位到一台主机（host），传输层的作用域具体到主机上的某一个进程
网络层的控制主要面向运营商，传输层为终端用户提供端到端的数据传输控制
两类模式：可靠的传输模式，或不可靠传输模式
可靠传输：可靠的端到端数据传输，适合于对通信质量有要求的应用场景，如文件传输等
不可靠传输：更快捷、更轻量的端到端数据传输，适合于对通信质量要求不高，对通信响应速度要求高的应用场景，如语音对话、视频会议等
会话层 (Session Layer)

利用传输层提供的服务，在应用程序之间建立和维持会话，并能使会话获得同步
表示层（Presentation Layer）

关注所传递信息的语法和语义，管理数据的表示方法，传输的数据结构
应用层（Application Layer）

通过应用层协议，提供应用程序便捷的网络服务调用
②TCP/IP 4层模型


③两种模型比较


注：我们教材的是以下分层来讲述的


二、物理层
物理层考虑的是怎样才能在连接各种计算机的传输媒体上传输数据比特流，而不是指具体的传输媒体。
物理层的作用是要尽可能地屏蔽掉不同传输媒体和通信手段的差异。
用于物理层的协议也常称为物理层规程 (procedure)。
1.物理介质
①引导型介质
信号在固体介质中传播，例如铜、光纤、同轴电缆

光纤

高速运行
高速点对点传输（10-100 Gbps）
低错误率
中继器相距很远，对电磁噪声免疫

双绞线

两根绝缘铜线互相缠绕为一对
电话线为1对双绞线，网线为4对双绞线，广泛用于计算机网络（以太网）双向传输
第5类：100 Mbps~1 Gbps；第6类：10Gbps
传输距离一般为为100米


同轴电缆

两根同心铜导线，双向传输
电缆上的多个频率通道
带宽可达100Mbps
传输距离一般为200米


②非引导型介质
信号自由传播，例如无线电（陆地无线电、卫星无线电信道)

无线电

电磁频谱中各种“波段”携带的信号
没有物理“电线”
不依赖介质的广播
半双工（发送方到接收方）
无线链路类型

无线局域网（WiFi）
10-100 Mbps；10米
广域（如3/4/5G蜂窝）
在~10公里范围内
蓝牙：短距离，有限速率
地面微波：点对点；45 Mbps
同步卫星：36000km高空， 280毫秒的往返时延
低轨卫星：近地，但围绕地球高速运动，需要大量卫星才能覆盖地球
2.数据交换方式
①分组交换
分组交换采用把一个个小的数据包存储转发传输来实现数据交换。

主要的一些缺点：
1、不具有实时性。
2、存在延时。
3、会造成通信阻塞。
4、存在无用的重复数据。
5、会出现丢包的情况。

优点：
1、设计简单。
2、资源利用率很高。

②电路交换
电路连接的三个阶段：

1、建立连接。
2、数据传输。
3、释放连接。

优点：
1、传输速度快、高效。
2、实时。

缺点：
1、资源利用率低。
2、新建连接需要占据一定的时间，甚至比通话的时间还长。

电路交换的多路复用
频分多路复用FDM
时分多路复用TDM



3.信道复用
复用 (multiplexing) 是通信技术中的基本概念。
它允许用户使用一个共享信道进行通信，降低成本，提高利用率。

①频分复用
将整个带宽分为多份，用户在分配到一定的频带后，在通信过程中自始至终都占用这个频带。
频分复用的所有用户在同样的时间占用不同的带宽资源（请注意，这里的“带宽”是频率带宽而不是数据的发送速率）。


②时分复用
时分复用则是将时间划分为一段段等长的时分复用帧（TDM 帧）。每一个时分复用的用户在每一个 TDM 帧中占用固定序号的时隙。


③波分复用
波分复用就是光的频分复用。使用一根光纤来同时传输多个光载波信号。


④码分复用
各用户使用经过特殊挑选的不同码型，因此彼此不会造成干扰。

三、数据链路层
1.功能（要解决的问题）
成帧 （Framing）
将比特流划分成“帧”的主要目的是为了检测和纠正物理层在比特传输中可能出现的错误，数据链路层功能需借助“帧”的各个域来实现
差错控制 （Error Control）
处理传输中出现的差错，如位错误、丢失等
流量控制 （Flow Control）
确保发送方的发送速率，不大于接收方的处理速率，避免接收缓冲区溢出

2.数据链路层提供的服务
1.无确认 无连接 服务（ Unacknowledged connectionless ）

接收方不对收到的帧进行确认
适用场景：误码率低的可靠信道；实时通信；
网络实例：以太网
2.有确认 无连接 服务（ Acknowledged connectionless ）

每一帧都得到单独的确认
适用场景：不可靠的信道（无线信道）
网络实例：802.11
3.有确认 有连接 服务（ Acknowledged connection-oriented ）

适用场景：长延迟的不可靠信道
3.成帧（Framing）
3.1 要解决的关键问题：如何标识一个帧的开始？
接收方必须能从物理层接收的比特流中明确区分出一帧的开始和结束，这个问题被称为帧同步或帧定界
关键：选择何种定界符？定界符出现在数据部分如何处理？
3.2 成帧（framing）的方式
①带比特填充的定界符法
定界符：两个0比特之间，连续6个1比特，即01111110，0x7E

发送方检查有效载荷：若在有效载荷中出现连续5个1比特，则直接插入1个0比特


接收方的处理：
若出现连续5个1比特，
若下一比特为0，则为有效载荷，直接丢弃0比特；
若下一比特为1，则连同后一比特的0，构成定界符，一帧结束

②物理层编码违例
核心思想：选择的定界符不会在数据部分出现
4B/5B编码方案
4比特数据映射成5比特编码，剩余的一半码字（16个码字）未使用，可以用做帧定界符
例如： 00110组合不包含在4B/5B编码中，可做帧定界符
前导码
存在很长的 前导码（preamble），可以用作定界符
例如：传统以太网、802.11
曼切斯特编码 / 差分曼切斯特编码
正常的信号在周期中间有跳变，持续的高电平（或低电平）为违例码，可以用作定界符
例如：802.5令牌环网
4.差错控制
4.1 背景
链路层存在的一个问题：信道的噪声导致数据传输问题

差错（ incorrect ）：数据发生错误
丢失（ lost ）：接收方未收到
乱序（out of order）：先发后到，后发先到
重复（repeatedly delivery）：一次发送，多次接收
解决方案：差错检测与纠正、确认重传

确认：接收方校验数据（差错校验），并给发送方应答，防止差错
定时器：发送方启动定时器，防止丢失
顺序号：接收方检查序号，防止乱序递交、重复递交
4.2 差错检验与纠正
目标

保证一定差错检测和纠错能力的前提下，如何减少冗余信息量？

考虑的问题

信道的特征和传输需求
冗余信息的计算方法、携带的冗余信息量
计算的复杂度等
两种主要策略

检错码（error-detecting code）
在被发送的数据块中，包含一些冗余信息，但这些信息只能使接收方推断是否发生错误但不能推断哪位发生错误，接收方可以请求发送方重传数据主要用在高可靠、误码率较低的信道上，例如光纤链路偶尔发生的差错，可以通过重传解决差错问题

纠错码（error-correcting code)
发送方在每个数据块中加入足够的冗余信息，使得接收方能够判断接收到的数据是否有错，并能纠正错误（定位出错的位置）主要用于错误发生比较频繁的信道上，如无线链路也经常用于物理层，以及更高层（例如，实时流媒体应用和内容分发）使用纠错码的技术通常称为前向纠错（FEC，Forward Error Correction)

常用的检错码包括：

①奇偶检验 (Parity Check)
1位奇偶校验是最简单、最基础的检错码。

1位奇偶校验：增加1位校验位，可以检查奇数位错误。


②校验和 (Checksum)
主要用于TCP/IP体系中的网络层和传输层


③循环冗余校验 (Cyclic Redundancy Check，CRC)
数据链路层广泛使用的校验方法

CRC校验码计算方法

设原始数据D为k位二进制位模式
如果要产生n位CRC校验码，事先选定一个n+1位二进制位模式G (称为生成多项式，收发双方提前商定)，G的最高位为1
将原始数据D乘以2^n （相当于在D后面添加 n 个 0），产生k+n位二进制位模式，用G对该位模式做模2除，得到余数R（n位，不足n位前面用0补齐）即为CRC校验码


CRC校验码计算示例

D = 1010001101
n = 5
G = 110101 或 G = x5 + x4 + x2 + 1
R = 01110
实际传输数据：101000110101110

④汉明码
目标：以奇偶校验为基础，找到出错位置，提供1位纠错能力

给定n位待发送的数据，首先确定校验位的个数k（根据2^k≥k+n+1）
确定校验位在码流中的位置，2^i,i=0,1,2,……，得到校验位P_1,P_2,P_4,P_8,……
确定分组，即每个校验位分别负责哪些数据位
P_1负责位置号的二进制符合XXXX1形式的数据位，即1,3,5,7,9,……
P_2负责位置号的二进制符合XXX1X形式的数据位，即2,3,6,7,10,……
P_3负责位置号的二进制符合XX1XX形式的数据位，即4,5,6,7,12,13,14,15,……
基于偶校验确定每组的校验位（0或1）
注： 汉明码是采用奇偶校验的码。它采用了一种非常巧妙的方式，把这串数字分了组，通过分组校验来确定哪一位出现了错误。

实际的海明码编码的过程也并不复杂，我们通过用不同过的校验位，去匹配多个不同的数据组，确保任何一个数据位出错，都会产生一个多个校验码位出错的唯一组合。这样，在出错的时候，我们就可以反过来找到出错的数据位，并纠正过来。当只有一个校验码位出错的时候，我们就知道实际出错的是校验码位了。

5.流量控制
链路层存在的另一个问题：接收方的处理速率

接收方的接收缓冲区溢出
解决方案

基于反馈 (feedback-based) 的流量控制
接收方反馈，发送方调整发送速率
基于速率 (rate-based) 的流量控制
发送方根据内建机制，自行限速
6.媒体接入控制 MAC (Medium Access Control)子层
数据链路层分为两个子层：
MAC子层：介质访问
LLC子层：承上启下（弱层）


6.1 信道分配问题
① 时分多址接入-TDMA
TDMA: time division multiple access

按顺序依次接入并使用信道
每个用户使用固定且相同长度的时隙
某时隙轮到某用户使用时，该用户没有数据要发送，则该时隙被闲置
例子: 6-user LAN, 1,3,4时隙有数据发送, 2,5,6时隙被闲置


② 频分多址接入-FDMA
FDMA: frequency division multiple access

信道总频带被划分为多个相同宽度的子频带
每个用户占用一个子频带，不管用户是否有数据发送
例子: 6-user LAN, 1,3,4频带有数据发送, 2,5,6频带被闲置


6.2 多路访问协议


6.2.1 随机访问协议
特点：冲突不可避免

①ALOHA
纯ALOHA协议

原理：想发就发！

特点：

冲突：两个或以上的帧
随时可能冲突
冲突的帧完全破坏
破坏了的帧要重传
分隙ALOHA

分隙ALOHA是把时间分成时隙（时槽）
时隙的长度对应一帧的传输时间。
帧的发送必须在时隙的起点。
冲突只发生在时隙的起点

②载波侦听多路访问协议CSMA
特点：“先听后发”
改进ALOHA的侦听/发送策略分类


非持续式CSMA

1.特点
①经侦听，如果介质空闲，开始发送
②如果介质忙，则等待一个随机分布的时间，然后重复步骤①

2.好处
等待一个随机时间可以减少再次碰撞冲突的可能性

3.缺点
等待时间内介质上如果没有数据传送，这段时间是浪费的

持续式CSMA

p-持续式CSMA

1.特点

①经侦听，如介质空闲，那么以 p的概率 发送，以(1–p)的概率延迟一个时间单元发送
②如介质忙，持续侦听，一旦空闲重复①
③如果发送已推迟一个时间单元，再重复步骤①

1-持续式CSMA

1.特点
①经侦听，如介质空闲，则发送
②如介质忙，持续侦听，一旦空闲立即发送
③如果发生冲突，等待一个随机分布的时间再重复步骤①

2.好处：持续式的延迟时间要少于非持续式

3.主要问题：如果两个以上的站等待发送，一旦介质空闲就一定会发生冲突

4.注意
1-持续式是p-持续式的特例

6.2.2 受控访问协议


特点：克服了冲突

①位图协议（预留协议）




竞争期：在自己的时槽内发送竞争比特

举手示意
资源预留
传输期：按序发送

明确的使用权，避免了冲突
②令牌传递
令牌：发送权限

令牌的运行：发送工作站去抓取，获得发送权

除了环，令牌也可以运行在其它拓扑上，如令牌总线
发送的帧需要目的站或发送站将其从共享信道上去除；防止无限循环
缺点：令牌的维护代价



③二进制倒计数协议


站点：编序号，序号长度相同
竞争期：有数据发送的站点从高序号到低序号排队，高者得到发送权
特点：高序号站点优先

6.2.3 有限竞争协议
利用上述二者的优势

①自适应树搜索协议（Adaptive Tree Walk Protocol）
在一次成功传输后的第一个竞争时隙，所有站点同时竞争。
如果只有一个站点申请，则获得信道。
否则在下一竞争时隙，有一半站点参与竞争（递归），下一时隙由另一半站点参与竞争
即所有站点构成一棵完全二叉树。

6.3虚拟局域网VLAN
广播域（Broadcasting Domain）

广播域是广播帧能够到达的范围；
缺省情况下，交换机所有端口同属于一个广播域，无法隔离广播域；
广播帧在广播域中传播，占用资源，降低性能，且具有安全隐患。


VLAN是一个在物理网络上根据用途，工作组、应用等来逻辑划分的局域网络，与用户的物理位置没有关系。



通过路由器或三层交换机进行VLAN间路由，实现VLAN间通信。

VLAN类型

基于端口的VLAN


基于MAC地址的VLAN


基于协议的VLAN


基于子网的VLAN


6.4无线局域网WLAN
无线局域网（Wireless Local Area Network，WLAN)：指以无线信道作为传输介质的计算机局域网

基础架构模式（Infrastructure）


分布式系统（DS）
访问点（AP）
站点（STA）
基本服务集（BSS）
扩展服务集（ESS）
站点之间通信通过AP转发
自组织模式（Ad hoc）


站点（STA）
独立基本服务集（IBSS）
站点之间直接通信
共享同一无线信道
无线局域网需要解决的问题

1.有限的无线频谱带宽资源

通道划分、空间重用
提高传输速率，解决传输问题
提高抗干扰能力和保密性
2.共享的无线信道

介质访问控制方法（CSMA/CA）
可靠性传输、安全性
3.组网模式管理

BSS构建、认证、关联
移动性支持（漫游）
睡眠管理（节能模式）
四、网络层
1.网络层概述
网络层在数据链路层提供的两个相邻端点之间的数据帧的传送功能上，进一步管理网络中的数据通信，将数据设法从源端经过若干个中间节点传送到目的端，从而向运输层提供最基本的端到端的数据传送服务。


2.网络层关键功能
路由（控制面）
选择数据报从源端到目的端的路径
核心：路由算法与协议
转发（数据面）
将数据报从路由器的输入接口传送到正确的输出接口
3.Internet网际协议
3.1 IPv4协议及其相关技术
3.1.1 基本概念
IPv4协议，网际协议版本4，一种无连接的协议，是互联网的核心，也是使用最广泛的网际协议版本，其后继版本为IPv6

internet协议执行两个基本功能

寻址(addressing)
分片(fragmentation)
3.1.2 IPv4数据报格式


版本： 4bit ，表示采用的IP协议版本
首部长度： 4bit，表示整个IP数据报首部的长度
区分服务： 8bit ，该字段一般情况下不使用
总长度： 16bit ，表示整个IP报文的长度,能表示的最大字节为2^16-1=65535字节
标识： 16bit ， IP软件通过计数器自动产生，每产生1个数据报计数器加1；在ip分片以后，用来标识同一片分片
标志： 3bit，目前只有两位有意义。
MF，置1表示后面还有分片，置0表示这是数据报片的最后1个；
DF，不能分片标志，置0时表示允许分片
片偏移： 13bit，表示IP分片后，相应的IP片在总的IP片的相对位置
生存时间TTL(Time To Live) ：8bit,表示数据报在网络中的生命周期，用通过路由器的数量来计量，即跳数（每经过一个路由器会减1）
协议：8bit，标识上层协议（TCP/UDP/ICMP…）
首部校验和：16bit ，对数据报首部进行校验，不包括数据部分
源地址：32bit，标识IP片的发送源IP地址
目的地址：32bit，标识IP片的目的地IP地址
选项：可扩充部分，具有可变长度，定义了安全性、严格源路由、松散源路由、记录路由、时间戳等选项
填充：用全0的填充字段补齐为4字节的整数倍
3.1.3 数据报分片
分片原因

数据报长度大于传输链路的MTU

MTU（Maximum Transmission Unit）, 最大传输单元

链路MTU
路径MTU (Path MTU)
分片策略

允许途中分片：根据下一跳链路的MTU实施分片
不允许途中分片：发出的数据报长度小于路径MTU（路径MTU发现机制）
重组策略

途中重组，实施难度太大
目的端重组（互联网采用的策略）
重组所需信息：原始数据报编号、分片偏移量、是否收集所有分片



IPv4分片策略

IPv4分组在传输途中可以多次分片
源端系统，中间路由器（可通过标志位设定是否允许路由器分片，DF标志位）
IPv4分片只在目的IP对应的目的端系统进行重组
IPv4分片、重组字段在基本IP头部
标识、标志、片偏移
IPv6分片机制有较大变化（见IPv6部分的介绍）
注：分组 (packet) 与 帧(frame)的关系



3.1.4 IP协议功能及报头字段总结
网络层基本功能

支持多跳寻路将IP数据报送达目的端：目的IP地址
表明发送端身份：源IP地址
根据IP头部协议类型，提交给不同上层协议处理：协议
其它相关问题

数据报长度大于传输链路的MTU的问题，通过分片机制解决：标识、标志、片偏移
防止循环转发浪费网络资源（路由错误、设备故障…），通过跳数限制解决：生存时间TTL
IP报头错误导致无效传输，通过头部机校验解决：首部校验和
3.2 IP地址
3.2.1 概述
IP地址，网络上的每一台主机（或路由器）的每一个接口都会分配一个全球唯一的32位的标识符

将IP地址划分为固定的类，每一类都由两个字段组成

网络号相同的这块连续IP地址空间称为地址的前缀，或网络前缀

IP地址共分为A、B、C、D、E五类，A类、B类、C类为单播地址

IP地址的书写采用点分十进制记法，其中每一段取值范围为0到255



IP特殊地址


3.2.1 子网划分
子网划分(subnetting)，在网络内部将一个网络块进行划分以供多个内部网络使用，对外仍是一个网络
子网(subnet )，一个网络进行子网划分后得到的一系列结果网络称为子网
子网掩码(subnet mask )，与 IP 地址一一对应，是32 bit 的二进制数，置1表示网络位，置0表示主机位
子网划分减少了 IP 地址的浪费、网络的组织更加灵活、便于维护和管理



3.2.3 无类域间路由
将32位的IP地址划分为前后两个部分，并采用斜线记法，即在IP地址后加上“/”，然后再写上网络前缀所占位数


一个 CIDR 地址块可以表示很多地址，这种地址的聚合常称为路由聚合（route aggregation），也称为构成超网 (supernet)
聚合技术在Internet中大量使用，它允许前缀重叠，数据包按具体路由的方向发送，即具有最少IP地址的最长匹配前缀
注：当路由器收到一个IP数据包时，它会将数据包的目的IP地址与自己本地路由表中的所有路由表进行逐位（Bit-By-Bit）对比，直到找到匹配度最长的条目，这就是最长前缀匹配机制。（路由比对之前会用相应路由的目的网络掩码进行逻辑与运算，再拿结果与路由路径比对）

3.3 DHCP动态主机配置协议
DHCP ：动态主机配置协议

当主机加入IP网络，允许主机从DHCP服务器动态获取IP地址
可以有效利用IP地址，方便移动主机的地址获取
工作模式：客户/服务器模式（ C/S ）
基于 UDP 工作，服务器运行在 67 号端口， 客户端运行在 68 号端口



DHCP 客户从UDP端口68以广播形式向服务器发送发现报文（DHCPDISCOVER）
DHCP 服务器广播发出提供报文（DHCPOFFER）
DHCP 客户从多个DHCP服务器中选择一个，并向其以广播形式发送DHCP请求报文（DHCPREQUEST）
被选择的DHCP服务器广播发送确认报文（DHCPACK）
3.4 ARP地址解析协议
背景
网络设备有数据要发送给另一台网络设备时，必须要知道对方的网络层地址（即IP地址）。IP地址由网络层来提供，但是仅有IP地址是不够的，IP数据报文必须封装成帧才能通过数据链路进行发送。数据帧必须要包含目的MAC地址，因此发送端还必须获取到目的MAC地址。通过目的IP地址二获取的MAC地址的过程是由ARP（Address Resolution Protocol）协议来实现的。

注：因为下层协议是通过MAC地址来确定各自身份的，所以下层发送必须要MAC地址

IP 与 MAC地址


ARP协议工作过程


A已知B的IP地址，需要获得B的MAC地址（物理地址）
如果A的ARP表中缓存有B的IP地址与MAC地址的映射关系，则直接从ARP表获取
如果A的ARP表中未缓存有B的IP地址与MAC地址的映射关系，则A广播包含B的IP地址的ARP query分组
在局域网上的所有节点都可以接收到ARP query
B接收到ARP query分组后，将自己的MAC地址发送给A
A在ARP表中缓存B的IP地址和MAC地址的映射关系
超时时删除
路由到另一个局域网


A创建IP数据包（源为A、目的为E）
在源主机A的路由表中找到路由器R的IP地址223.1.1.4
A根据R的IP地址223.1.1.4，使用ARP协议获得R的MAC地址
A创建数据帧（目的地址为R的MAC地址）
数据帧中封装A到E的IP数据包
A发送数据帧，R接收数据帧
3.5 网络地址转换(NAT)
定义
网络地址转换(NAT)用于解决IPv4地址不足的问题，是一种将私有（保留）地址转化为公有IP地址的转换技术

私有IP地址：
A类地址：10.0.0.0–10.255.255.255
B类地址：172.16.0.0–172.31.255.555
C类地址：192.168.0.0–192.168.255.255

NAT工作机制


出数据报：外出数据报用 NAT IP地址(全局), 新port # 替代 源IP地址(私有), port #

NAT转换表：每个 (源IP地址, port #)到(NAT IP地址, 新port #) 映射项

入数据报：对每个入数据报的地址字段用存储在NAT表中的(源IP地址, port #)替代对应的 (NAT IP地址, 新port #)

NAT根据不同的IP上层协议进行NAT表项管理
TCP，UDP，ICMP

传输层TCP/UDP拥有16-bit 端口号字段
所以一个WAN侧地址可支持60,000个并行连接

NAT的优势

节省合法地址，减少地址冲突
灵活连接Internet
保护局域网的私密性
3.6 ICMP: 互联网控制报文协议
ICMP: 互联网控制报文协议

ICMP 允许主机或路由器报告差错情况和提供有关异常情况的报告
由主机和路由器用于网络层信息的通信
ICMP 报文携带在IP 数据报中： IP上层协议号为1
ICMP报文类型

ICMP 差错报告报文
终点不可达：不可达主机、不可达网络，无效端口、协议
ICMP 询问报文
回送请求/回答 (ping使用)
ICMP 报文格式


ICMP报文的前 4 个字节包含格式统一的三个字段：类型、代码、检验和
相邻的后四个字节内容与ICMP的报文类型有关
ICMP报文类型及功能


4.路由算法
路由算法须满足的特性：

正确性
简单性
鲁棒性
稳定性
公平性
有效性
根据路由算法是否随网络的通信量或拓扑自适应划分

静态路由选择策略（非自适应路由选择）
动态路由选择策略（自适应路由选择）
4.1 距离向量路由
算法基本思想

每个节点周期性地向邻居发送它自己到某些节点的距离向量；

当节点x接收到来自邻居的新DV估计，它使用B-F方程更新其自己的DV :
Dx(y) ← minv{c(x,v) + Dv(y)} for each node y ∊ N

上述过程迭代执行，Dx(y)收敛为实际最小费用 dx(y)

距离向量算法特点：迭代的、分布式的

每次本地迭代由下列引起: 本地链路费用改变、邻居更新报文
分布式:各节点依次计算，相互依赖
注：路由器只掌握物理相连的邻居以及链路费用

算法过程
路由器启动时初始化自己的路由表

初始路由表包含所有直接相连的网络路径，距离均为0

路由器周期性地向其相邻路由器广播自己知道的路由信息

相邻路由器可以根据收到的路由信息修改和刷新自己的路由表


路由器经过若干次更新后，最终都会知道到达所有网络的最短距离

所有的路由器都得到正确的路由选择信息时网络进入“收敛”（convergence）状态



特殊情况考虑
计数到无穷问题（The Count-to-Infinity Problem）







好消息传播快，坏消息传播慢，是距离向量路由的一个主要缺点

4.2 链路状态路由
注：所有路由器掌握完整的网络拓扑和链路费用信息

算法过程
链路状态（Link State）路由可分为五个部分：

发现邻居，了解他们的网络地址；


设置到每个邻居的成本度量；

开销/度量/代价：
自动发现设置或人工配置
度量：带宽、跳数、延迟、负载、可靠性等
常用度量：链路带宽（反比）
例如：1-Gbps以太网的代价为1，100-Mbps以太网的代价为10
可选度量：延迟
发送一个echo包，另一端立即回送一个应答
通过测量往返时间RTT，可以获得一个合理的延迟估计值
构造一个分组，分组中包含刚收到的所有信息；
构造链路状态分组（link state packet，LSP）

发送方标识
序列号
年龄
邻居列表


将此分组发送给其他的路由器；
每个LSP分组包含一个序列号，且递增
路由器记录所收到的所有（源路由器、序列号）对
当一个新分组到达时，路由器根据记录判断：
如果是新分组，洪泛广播
如果是重复分组，丢弃
如果是过时分组，拒绝
计算到其他路由器的最短路径。
Dijkstra算法示例
D(k)：从计算节点到目的节点k当前路径代价
p(k)：从计算节点到目的节点k的路径中k节点的前继节点



距离向量和链路状态算法比较
网络状态信息交换的范围

DV:邻居间交换
LS:全网扩散
网络状态信息的可靠性

DV:部分道听途说
LS:自己测量
4.3 层次路由
产生原因

过于庞大的路由表存储、查找困难，路由信息交互开销高
现实情况：

地址分配往往是随机的，难以进行高效的地址聚合
每个网络的网络管理员有自己的管理方法和思路，并不希望每个路由器都干涉本网络内部的地址分配等问题
层次路由可以解决：

网络扩展性问题：当网络扩大时，控制路由表条目和路由表存储空间的增长
管理的自治问题：网络管理员可以控制和管理自己网络的路由
基本思路

互联网由大量不同的网络互连，每个管理机构控制的网络是自治的

自治系统（AS，Autonomous System）

一个管理机构控制之下的网络
一个AS内部通常使用相同的路由算法/路由协议，使用统一的路由度量（跳数、带宽、时延 …）
不同的AS可以使用不同的路由算法/路由协议
每个AS有一个全球唯一的ID号：AS ID
自治系统内的还可以进一步划分层次：私有自治系统或区域

效果


4.4 广播路由
广播（Broadcasting）：源主机同时给全部目标地址发送同一个数据包

实现方法
①给每个主机单独发送一个数据包

效率低、浪费带宽
Server需要知道每个目的地址
②多目标路由（multi-destination routing）

在需要转发的路由器线路复制一次该数据报
网络利用率高
Server依然需要知道所有的目的地址
注：以上方法难以实现

③泛洪（flooding）

一种将数据包发送到所有网络节点的简单方法
将每个进入数据包发送到除了进入线路外的每条出去线路
用途

保证性：一种有效广播手段，可确保数据包被传送到网络中每个节点
鲁棒性：即使大量路由器被损坏，也能找到一条路径（如果存在）
简单性：仅需知道自己的邻居
无控制的泛洪

实现广播最显而易见的技术
环路可能导致广播风暴
路由器可能收到多个副本
节点需要跟踪已泛洪的数据包以阻止洪泛
即使利用跳数来限制，也会出现成倍爆炸
解决方法：受控制的泛洪（每个路由器进行有选择的泛洪）

序号控制泛洪
逆向路径转发
④生成树（spanning tree）

源节点向所有属于该生成树的特定链路发送分组
改进了逆向路径转发
没有环路
最佳使用带宽
最少副本，消除了冗余分组
一个路由器可以不必知道整颗树，只需要知道在一颗树中的邻居即可


5.Internet路由协议
5.1 路由选择协议RIP
概述

路由选择协议RIP（ Routing Information Protocol）是基于距离矢量算法的协议
使用跳数衡量到达目的网络的距离
RIP 认为一个好的路由就是它通过的路由器的数目少，即“距离短”
RIP 允许一条路径最多只能包含 15 个路由器
RIP协议的基本思想
仅和相邻路由器交换信息
路由器交换的内容是自己的路由表
周期性更新：30s
工作过程

初始化


周期性更新

小结

RIP协议的特点

算法简单，易于实现
收敛慢
需要交换的信息量较大
RIP协议的适用场合

中小型网络
RIP协议的防环路机制

触发更新
毒性反转
水平分割
其他
5.2 BGP-外部网关路由协议
路由协议

内部网关协议 IGP： 有 RIP 和、OSPF、ISIS 等多种具体的协议
外部网关协议 EGP：目前使用的协议就是 BGP
边界网关协议BGP (Border Gateway Protocol)

目前互联网中唯一实际运行的自治域间的路由协议
BGP功能

eBGP：从相邻的AS获得网络可达信息
iBGP： 将网络可达信息传播给AS内的路由器
基于网络可达信息和策略决定到其他网络的“最优”路由
BGP会话: 两个BGP路由器通过TCP连接交换BGP报文

通告到不同网络前缀的路径，即路径向量协议
BGP路径通告


AS2的路由器2c从AS3的路由器3a接收到路径AS3, X
根据AS2的策略，AS2的路由器2c接受路径AS3, X，通过iBGP传播给AS2的所有路由器
根据AS2策略，AS2的路由器2a通过eBGP向AS1的路由器1c通告从AS3的路由器3a接收到路径AS2, AS3, X


路由器可能会学到多条到达目的网络的路径:

AS1的路由器1c从2a学到路径AS2, AS3, X
AS1的路由器1c从3a学到路径AS3, X
由策略，AS1路由器1c可能选择路径AS3, X, 并在AS1中通过iBGP通告路径
6.路由器的工作原理
6.1 路由器概述
路由器是互联网最主要的网络设备，包含2个核心功能

控制层：运行各种路由协议：BGP、OSPF、RIP，学习去往不同目的的转发路径：路由表
数据层：根据上述路由表，将收到的IP分组转发到正确的下一跳链路


6.2 路由器控制层
路由器可同时运行多个路由协议
路由器也可不运行任何路由协议，只使用静态路由和直连路由
路由管理根据路由优先级，选择最佳路由，形成核心路由表
控制层将核心路由表下发到数据层，形成转发表（FIB）
若存在多个“去往同一目的IP前缀”的不同类型路由，路由器根据优先级选择最佳路由
优先级数值越小，优先级越高

6.3 路由器数据层
路由器中IP报文转发核心功能

链路层解封装，IP头部校验
获取报文目的IP地址
用目的IP地址，基于最长前缀匹配规则查询转发表
查询失败，丢弃报文
查询成功
获取转发出接口和下一跳IP地址
IP头部“TTL”字段值减1，重新计算IP头部“校验和”
重新进行链路层封装，发送报文
注：普通IP报文转发过程中，路由器不查看传输层及以上层协议的内容

IP报文在路由器转发前后的变化

链路层封装更新，IP头部“TTL”减1，IP头部“校验和”更新
数据报在不同硬件单元的处理

报文输入的接口卡
链路层解封装
转发表查询（该工作在输入接口卡处理）
通过交换结构将报文排队发往目的接口卡（发送过快将产生拥塞）
交换结构
从输入接口卡发往输出接口卡
报文输出的接口卡
从交换结构接收报文（排队进行后续处理，到达太快将产生拥塞）
链路层封装
从输出接口发送报文
3种典型的交换结构



7.拥塞控制算法
7.1 概述
拥塞
网络中存在太多的数据包导致数据包传输延迟或丢失，从而导致网络吞吐量下降

拥塞控制（congestion control）
需要确保通信子网能够承载用户提交的通信量，是一个全局性问题，涉及主机、路由器等多种因素

产生拥塞的原因

主机发送到网络的数据包数量过多，超过了网络的承载能力
突发的流量填满了路由器的缓冲区，造成某些数据包会被丢弃
拥塞控制的基本策略

开环控制----事先对通信流参数进行协商，协商后，不管网络是拥塞还是带宽充足，参数不能动态改变
开环控制属于预防性拥塞控制，它竭力使网络总是处于无拥塞状态运行。开环控制的方法包括决定什么时候接受新流量，什么时候丢弃数据包和丢弃哪些数据包。其缺点是没有考虑网络的当前状态
闭环控制—根据网络状态进行动态控制，包括两部分：反馈机制和控制机制。闭环控制方法分为两个子类：显式反馈与隐式反馈
7.2 流量调节
抑制包(Choke Packets)：用于通知发送方减小发送量，路由器选择一个被拥塞的数据包，给该数据包的源主机返回一个抑制包，抑制包中的目的地址取自该拥塞数据包。源主机收到抑制包后，减少发向特定目的地址的流量
逐跳的抑制包(Hop-by-Hop Choke Packets)：在高速或长距离网络中，由于源主机响应太慢，抑制包算法对拥塞控制的效果并不好，可采用逐跳抑制方法；其核心思想是抑制包对它经过的每个路由器都起作用，能够迅速缓解发生拥塞处的拥塞，但要求上游路由器有更大的缓冲区
显式拥塞通告（ECN，Explicit Congestion Notification），在IP包头中记录数据包是否经历了拥塞。在数据包转发过程中，路由器可以在包头中标记为经历拥塞，然后接收方在它的下一个应答数据包里显示该标记作为显式拥塞信号
RFC2474中重新定义TOS域为包含一个6位的区分服务码点(DSCP) 和2位未使用位；RFC3168重新定义RFC2474中TOS域未使用的两位为ECN域，包含如下值：
00：发送主机不支持ECN
01或者10：发送主机支持ECN
11：路由器正在经历拥塞
7.3 随机早期检测RED (Random Early Detection)
使路由器的队列维持两个参数，即队列长度最小门限 THmin 和最大门限 THmax
RED 对每一个到达的数据报都先计算平均队列长度 LAV
若平均队列长度小于最小门限 THmin ，则将新到达的数据报放入队列进行排队
若平均队列长度超过最大门限 THmax，则将新到达的数据报丢弃
若平均队列长度在最小门限 THmin 和最大门限THmax 之间，则按照某一概率 p 将新到达的数据报丢弃
RED 将路由器的到达队列划分成为三个区域

丢弃概率 p 与 THmin 和 Thmax 的关系

当 LAV <Thmin 时，丢弃概率 p = 0
当 LAV >Thmax 时，丢弃概率 p = 1
当 THmin < LAV < THmax时， 0  p  1
例如，按线性规律变化，从 0 变到 pmax
8.服务质量
8.1概述
问题的提出

互联网本身只能提供“尽力而为的服务”或称“尽最大努力交付的服务”
当互联网越来越多的用于传输多媒体信息时，由于这些实时业务对网络的传输延时、延时抖动等特性较为敏感，这样网络的传输质量就难以保障了
IP网络不能保证特定业务的QoS要求，已经成为IP网络发展的巨大障碍
网络的服务质量越来越多的引起人们的关注，甚至成为网络技术研究的热点问题
什么是网络服务质量？（QoS, Quality of Service）

QoS是网络在传输数据流时要满足一系列服务请求，具体可以量化为带宽、时延、抖动、丢包率等性能指标

8.2 流量整形
流量整形(traffic shaping)：其作用是限制流出某一网络的某一连接的流量与突发，使这类报文以比较均匀的速度向外发送

①漏桶算法
到达的数据包（网络层的PDU）被放置在底部具有漏孔的桶中（数据包缓存）
漏桶最多可以排队b个字节，漏桶的这个尺寸受限于内存。如果数据包到达的时候漏桶已经满了，那么数据包应被丢弃
数据包从漏桶中漏出，以常量速率（r字节/秒）注入网络，因此平滑了突发流量


②令牌桶算法
产生令牌：周期性的以速率r向令牌桶中增加令牌，桶中的令牌不断增多。如果桶中令牌数已到达上限，则丢弃多余令牌
消耗令牌：输入数据包会消耗桶中的令牌。在网络传输中，数据包的大小通常不一致。大的数据包相较于小的数据包消耗的令牌要多
判断是否通过：输入数据包经过令牌桶时存在两种可能：输出该数据包或者被丢弃。当桶中的令牌数量可以满足数据包对令牌的需求，则将数据包输出，否则将其丢弃
注：漏桶算法和令牌桶算法的区别在于漏桶算法输出的流量永远不可能超过一定限制，而令牌桶算法可以容忍短时间内的高流量输出，对于一些突发流量的需求比较友好

8.3 数据包调度
在同一个流的数据包之间以及在竞争流之间分配路由器资源的算法称为包调度算法，它负责分配带宽和其他路由器资源，负责确定把缓冲区中的哪些数据包发送到输出链路上

先来先服务FCFS（First-Come First-Serve）
公平队列算法（Fair Queueing/Round Robin）
加权公平队列算法（Weighted Fair Queueing）
优先级调度（Priority Scheduling）
9.三层交换
9.1 三层交换的技术背景
二层交换网络中的广播，限制了网络规模的扩展
交换机对目标地址无法匹配的数据帧进行广播转发
交换机对目标地址为广播地址的数据帧进行广播转发
交换机为维护生成树状态产生大量的桥协议数据单元(Bridge Protocol Data Unit，BPDU)
这些广播帧会大量消耗网络资源，并频繁影响用户的数据通信
VLAN虽然可以将广播的影响限定在一定范围内，但同时也隔离了正常的用户间数据通信
传统路由器致力于解决VLAN间互联互通，但是其转发效率和拓扑复杂性带来的网络通信瓶颈无法有效应对规模扩展
9.2 三层交换的动机
利用第三层协议中的信息来加强第二层交换功能，形成带有路由功能的交换
融合VLAN 间的二层隔离和三层互通，消除大规模网络中广播对性能的影响
简化网络配置，简化网络拓扑，优化网络管理，降低网络部署成本


9.3 三层交换机的工作原理


10.虚拟专用网VPN (Virtual Private Network)
10.1 VPN的技术背景
计算机网络按用途分类
专用、公用
专用网络的实现方式
使用专用链路：铺设、租用（费用高，不灵活）
使用公共链路：不安全
虚拟专用网VPN (Virtual Private Network)
专用网络的经济、可靠、灵活的解决方案
利用安全隧道技术将专用网络在公共网络上扩展
VPN的设计原则
安全性、隧道与加密、数据验证、用户验证、防火墙与攻击检测
10.2 VPN的原理
VPN指利用公用网络架设专用网络的远程访问技术
VPN通过隧道技术在公共网络上模拟出一条点到点的逻辑专线，从而达到安全数据传输的目的




VPN对数据机密性和完整性的保护

10.3 VPN的实现方式
用VPN连接合作伙伴


用VPN实现专用网络的远程访问


11.IPv6协议
初始动机：应付“32-bit地址空间耗尽”问题（CIDR和NAT都无法从根本上解决地址短缺问题），增加地址空间
IPv6 地址

地址长度为128bit，是IPv4地址长度的4倍
IPv6地址空间数量约为3*1038
IPv6地址表示法，冒分十六进制，x : x : x : x : x : x : x : x
简化方法：每个x前面的0可省略，可把连续的值为0的x表示为“::”, 且“::”只能出现1次
简化前地址，2001:0DA8:0000:0000:200C:0000:0000:00A5
简化后地址，2001:DA8:0000:0000:200C::A5
五、传输层
1.传输层概述
传输层位于应用层和网络层之间：
基于网络层提供的服务，向分布式应用程序提供通信服务
按照因特网的“端到端”设计原则：
应用程序只运行在终端上，即不需要为网络设备编写程序
站在应用程序的角度：
传输层应提供进程之间本地通信的抽象：即运行在不同终端上的应用进程仿佛是直接连在一起的
1.1 套接字
设想在应用程序和网络之间存在一扇“门”：
需要发送报文时：发送进程将报文推到门外
门外的运输设施（因特网）将报文送到接收进程的门口
需要接收报文时：接收进程打开门，即可收到报文
在TCP/IP网络中，这扇“门”称为套接字（socket），是应用层和传输层的接口，也是应用程序和网络之间的API
1.2 传输层提供的服务
因特网的网络层提供“尽力而为”的服务：
网络层尽最大努力在终端间交付分组，但不提供任何承诺
具体来说，不保证交付，不保证按序交付，不保证数据完整，不保证延迟，不保证带宽等
传输层的有所为、有所不为:
传输层可以通过差错恢复、重排序等手段提供可靠、按序的交付服务
但传输层无法提供延迟保证、带宽保证等服务
1.3 因特网传输层提供的服务
最低限度的传输服务：
将终端-终端的数据交付扩展到进程-进程的数据交付
报文检错
增强服务：
可靠数据传输
流量控制
拥塞控制
因特网传输层通过UDP协议和TCP协议，向应用层提供两种不同的传输服务：
UDP协议：仅提供最低限度的传输服务
TCP协议：提供基础服务和增强服务
2.传输层基本服务——复用和分用
2.1 复用和分用概述
传输层基本服务：将主机间交付扩展到进程间交付，通过复用和分用实现


复用：
发送方传输层将套接字标识置于报文段中，交给网络层
分用：
接收方传输层根据报文段中的套接字标识，将报文段交付到正确的套接字
2.2 套接字标识与端口号
端口号是套接字标识的一部分：
每个套接字在本地关联一个端口号
端口号是一个16比特的数
端口号的分类：
熟知端口：0～1023，由公共域协议使用
注册端口：1024～49151，需要向IANA注册才能使用
动态和/或私有端口：49152～65535，一般程序使用
报文段中有两个字段携带端口号
源端口号：与发送进程关联的本地端口号
目的端口号：与接收进程关联的本地端口号

2.3 TCP/UDP套接字（复用和分用）
UDP套接字

使用<IP地址，端口号>二元组标识UDP套接字
服务器使用一个套接字服务所有客户
TCP套接字
使用<源IP地址，目的IP地址，源端口号，目的端口号> 四元组标识连接套接字
服务器使用一个监听套接字和多个连接套接字服务多个客户，每个连接套接字服务一个客户
3.无连接传输：UDP
3.1 UDP报文段结构
UDP报文：
报头：携带协议处理需要的信息
载荷（payload）：携带上层数据
用于复用和分用的字段：
源端口号
目的端口号
用于检测报文错误的字段：
报文总长度
校验和（checksum）


3.2 UDP校验和（checksum）
校验和字段的作用: 对传输的报文段进行检错
以下是报文段的字段

key	human	hex
Source	192.168.1.106	c0a8 016a
Destination	11.111.111.111	0b6f 6f6f
Protocol	UDP(17)	11
Length	17	11
Source Port	63549	f83d
Destination Port	12345	3039
Length	17	11
Checksum	0xb12d	b12d
Data	hello UDP	6865 6c6c 6f20 5544 5000
将上表中所有的 16 进制数加起来，之后取反码。有一点需要注意的是，如果遇到最高位进位，那么需要对结果进行回卷，意思是



求出来的即是校验和。

3.3 为什么需要UDP？
为什么需要UDP？

应用可以尽可能快地发送报文：
无建立连接的延迟
不限制发送速率（不进行拥塞控制和流量控制）
报头开销小
协议处理简单
UDP适合哪些应用？

容忍丢包但对延迟敏感的应用：
如流媒体
以单次请求/响应为主的应用：
如DNS
若应用要求基于UDP进行可靠传输：
由应用层实现可靠性
4.面向连接的传输：TCP
4.1 可靠传输
数据包有序、无差错到达接收端

如何实现可靠传输，基本原则是什么？

利用ACK确认
重传机制
差错检测
可靠传输实现举例-Stop and Wait

注：该实现俗称tcp的三次握手和四次挥手。三次挥手我们也常称为“请求 -> 应答 -> 应答之应答”的三个回合，主要就是为了建立连接

建立一条TCP连接需要确定两件事：

双方都同意建立连接（知晓另一方想建立连接）
初始化连接参数（序号，MSS等）

四次挥手：目的就是确保断开连接时双方都是确认结束的状态



4.2 流水线技术
由于信道上一直有数据不间断地传送，这种传输方式可获得很高的信道利用率。


①GBN 协议（回退 N 步协议）
发送窗口
发送方维持的发送窗口，它的意义是：位于发送窗口内的分组都可连续发送出去，而不需要等待对方的确认。这样，信道利用率就提高了。
发送方每收到一个确认，就把发送窗口向前滑动一个分组的位置。


累积确认

接收方一般采用累积确认的方式。即不必对收到的分组逐个发送确认，而是对按序到达的最后一个分组发送确认，这样就表示：到这个分组为止的所有分组都已正确收到了。
优点：容易实现，即使确认丢失也不必重传。
缺点：不能向发送方反映出接收方已经正确收到的所有分组的信息。
如果发送方发送了前 5 个分组，而中间的第 3 个分组丢失了。这时接收方只能对前两个分组发出确认。发送方无法知道后面三个分组的下落，而只好把后面的三个分组都再重传一次。
这就叫做 Go-back-N（回退 N），表示需要再退回来重传已发送过的 N 个分组。
可见当通信线路质量不好时，连续 ARQ 协议会带来负面的影响。

②SR 协议（选择重传协议）
SR 协议在 GBN 协议的基础上进行了改进，它通过让发送方仅重传那些它怀疑在接收方出错（即丢失或受损）的分组而避免了不必要的重传。选择重传协议只重传真正丢失的分组。

选择重传的接收窗口与发送窗口一样大
选择重传协议允许与接收窗口一样多的分组失序到达,并保存这些失序到达的分组,直到连续的一组分组被交付给应用层。
标记发出分组,当ACK=Sf 时,将窗口滑过所有连续的已确认的分组
如果还有未确认的分组,则重发所有检测到的未被确认的分组并重启计时器
如果所有分组都被确认了则停止计时器
确认，确认号(ACK)只定义完好接收的那一个分组的序号,并不反馈任何其他分组的信息
注：SR协议ack确认和GBN的累计确认不同，是一个一个确认

计时器
理论上选择重传协议要为每个分组使用一个计时器。当某个计时器超时后,只有相应的分组被重传。换而言之，返回N协议将所有的分组当做一个整体对待，而选择重传协议则分别对待每一个分组。但是大多数SR的运输层仅使用了一个计时器.。注意只使用一个计时器而做到跟踪所有发出去的分组的情况的做法是：标记发出分组,当ACK=Sf 时,将窗口滑过所有连续的已确认的分组，如果还有未确认的分组，则重发所有检测到的未被确认的分组并重启计时器，如果所有分组都被确认了则停止计时器。

快速重传

仅靠超时重发丢失的报文段，恢复太慢！

发送方可利用重复ACK检测报文段丢失：

发送方通常连续发送许多报文段
若仅有个别报文段丢失，发送方将收到多个重复序号的ACK
多数情况下IP按序交付分组，重复ACK极有可能因丢包产生
TCP协议规定： 当发送方收到对同一序号的3次重复确认时，立即重发包含该序号的报文段

所谓快速重传，就是在定时器到期前重发丢失的报文段

③TCP 可靠通信的具体实现
TCP 连接的每一端都必须设有两个窗口——一个发送窗口和一个接收窗口。
TCP 的可靠传输机制用字节的序号进行控制。TCP 所有的确认都是基于序号而不是基于报文段。
TCP 两端的四个窗口经常处于动态变化之中。
TCP连接的往返时间 RTT 也不是固定不变的。需要使用特定的算法估算较为合理的重传时间
GBN、SR和TCP小结
Go-Back-N协议
接收方：

使用累积确认
不缓存失序的分组
对失序分组发送重复ACK
发送方：

超时后重传从基序号开始的所有分组
SR
接收方：

缓存失序的分组
单独确认每个正确收到的分组
发送方：

每个分组使用一个定时器
仅重传未被确认的分组
TCP协议

接收方：

使用累积确认
缓存失序的报文段
对失序报文段发送重复ACK
增加了推迟确认
发送方：

超时后仅重传最早未确认的报文段
增加了快速重传
4.3 TCP报文段结构


最大段长度（MSS）：
TCP段中可以携带的最大数据字节数
建立连接时，每个主机可声明自己能够接受的MSS，缺省为536字节
窗口比例因子（window scale）：
建立连接时，双方可以协商一个窗口比例因子
实际接收窗口大小 = window size * 2^window scale
选择确认（SACK）：
最初的TCP协议只使用累积确认
改进的TCP协议引入选择确认，允许接收端指出缺失的数据字节
发送序号和确认序号的含义

5.TCP流量控制
TCP接收端

使用显式的窗口通告，告知发送方可用的缓存空间大小
在接收窗口较小时，推迟发送确认
仅当接收窗口显著增加时，通告新的窗口大小
TCP发送端

使用Nagle算法确定发送时机
使用接收窗口限制发送的数据量，已发送未确认的字节数不超过接收窗口的大小
Nagle算法的解决方法：

在新建连接上，当应用数据到来时，组成一个TCP段发送（那怕只有一个字节）
在收到确认之前，后续到来的数据放在发送缓存中
当数据量达到一个MSS或上一次传输的确认到来（取两者的较小时间），用一个TCP段将缓存的字节全部发走
Nagle算法的优点：

适应网络延时、MSS长度及应用速度的各种组合 常规情况下不会降低网络的吞吐量
6.拥塞控制
发送方根据自己感知的网络拥塞程度，限制其发送速率

6.1 拥塞控制的类型
网络辅助的拥塞控制
路由器向端系统提供显式的反馈，例如：
设置拥塞指示比特
给出发送速率指示
ATM、X.25采用此类方法
端到端拥塞控制
网络层不向端系统提供反馈
端系统通过观察丢包和延迟，自行推断拥塞的发生
TCP采用此类方法
6.2 TCP拥塞控制要解决的问题
发送方如何感知网络拥塞？

发送方利用丢包事件感知拥塞：
拥塞造成丢包和分组延迟增大
-无论是丢包还是分组延迟过大，对于发送端来说都是丢包了
丢包事件包括：
-重传定时器超时
-发送端收到3个重复的ACK
发送方采用什么机制限制发送速率?

发送方使用拥塞窗口cwnd限制已发送未确认的数据量:
LastByteSent-LastByteAcked <= cwnd


cwnd随发送方感知的网络拥塞程度而变化

发送方感知到网络拥塞后，采取什么策略调节发送速率？

①AIMD

乘性减（Multiplicative Decrease）
发送方检测到丢包后，将cwnd的大小减半（但不能小于一个MSS）
目的：迅速减小发送速率，缓解拥塞
加性增（Additive Increase）
若无丢包，每经过一个RTT，将cwnd增大一个MSS，直到检测到丢包
目的：缓慢增大发送速率，避免振荡
注：MSS是发送速率TCP建立连接时双方确定的每一个报文段所能承载的最大数据长度



②TCP慢启动

慢启动的策略：
每经过一个RTT，将cwnd加倍
慢启动的具体实施：
每收到一个ACK段，cwnd增加一个MSS
只要发送窗口允许，发送端可以立即发送下一个报文段
特点：
以一个很低的速率开始，按指数增大发送速率
区分不同的丢包事件

超时：说明网络交付能力很差
收到3个重复的ACK：说明网络仍有一定的交付能力

收到3个重复的ACK：
将cwnd降至一半
使用AIMD调节cwnd
超时：
设置门限 =cwnd/2
cwnd=1MSS
使用慢启动增大cwnd至门限
使用AIMD调节cwnd
6.3 TCP拥塞控制的实现
发送方维护变量ssthresh
发生丢包时，ssthresh=cwnd/2
ssthresh是从慢启动转为拥塞避免的分水岭：
cwnd低于门限时，执行慢启动
cwnd高于门限：执行拥塞避免
拥塞避免阶段，拥塞窗口线性增长：
每当收到ACK， cwnd=cwnd + MSS*(MSS/cwnd)
检测到3个重复的ACK后：
TCP Reno实现： cwnd= ssthresh+3，线性增长
TCP Tahoe实现：cwnd=1 MSS，慢启动

TCP发送端的事件与动作


六、应用层
1.应用层概述
每个应用层协议都是为了解决某一应用问题，通过位于不同主机中的多个应用进程之间的通信和协同工作来完成
两台主机通信实际是其对应的两个应用进程(process)在通信
应用进程: 为解决具体应用问题而彼此通信的进程
应用层的具体内容就是规定应用进程在通信时所遵循的协议
客户/服务器（C/S, Client/Server）方式
对等（P2P，Peer to Peer）方式
1.1 应用进程通信方式
①客户/服务器（C/S, Client/Server）方式
应用层的许多协议是基于C/S方式，例如，在移动互联网环境下，每个应用APP都是一个客户端
客户(client)和服务器(server)是指通信中所涉及的2个应用进程
客户/服务器方式描述的是应用进程之间服务和被服务的关系
客户是服务请求方（主动请求服务，被服务）
服务器是服务提供方（被动接受服务请求，提供服务）
C/S方式可以是面向连接的，也可以是无连接的
面向连接时，C/S通信关系一旦建立，通信就是双向的，双方地位平等，都可发送和接收数据


客户进程的特点

在进行通信时临时成为客户，它也可在本地进行其它的计算
用户计算机上运行，在打算通信时主动向远地服务器发起通信
客户方必须知道服务器进程所在主机的IP地址才能发出服务请求
需要时可以与多个服务器进行通信
服务器进程的特点

专门用来提供某种服务的程序，可“同时”处理多个远地或本地客户的请求
必须始终处于运行状态才有可能提供服务
通信开始之前服务器进程不需要知道客户进程所在主机的IP地址，无论客户请求来自哪里，服务器进程被动等待服务请求的到来即可
通常是当系统启动时即自动调用并一直运行着。某些服务器程序也可以由用户或其它进程在通信前启动
被动等待并接受来自多个客户的通信请求
②对等（P2P，Peer to Peer）方式
对等方式是指两个进程在通信时并不区分服务的请求方和服务的提供方
只要两个主机都运行P2P软件，它们就可以进行平等、对等的通信
双方都可以下载对方存储在硬盘中的共享文档，如果权限允许的话
音频/视频应用推动了P2P对等通信方式的发展（BitTorrent）
音频/视频流量已占主要比
P2P方式从本质上看仍然是使用了C/S方式，但强调的是通信过程中的对等，这时每一个P2P进程既是客户同时也是服务器


1.2 服务器进程工作方式
循环方式(iterative mode)

一次只运行一个服务进程
当有多个客户进程请求服务时，服务进程就按请求的先后顺序依次做出响应 (阻塞方式)
并发方式(concurrent mode)

可以同时运行多个服务进程
每一个服务进程都对某个特定的客户进程做出响应 (非阻塞方式)
无连接循环方式服务

使用无连接的UDP服务进程通常都工作在循环方式，即一个服务进程在同一时间只能向一个客户进程提供服务。(顺序服务)
服务进程收到客户进程的请求后，就发送UDP用户数据报响应该客户
对其他客户进程发来的请求则暂时不予理睬，这些请求都在服务端的队列中排队等候服务进程的处理
当服务进程处理完毕一个请求时，就从队列中读取来自下一个客户进程的请求，然后继续处理


面向连接的并发方式服务

面向连接的TCP服务进程通常都工作在并发服务方式，服务进程在同一时间可同时向多个客户进程提供服务。(并发服务)
在TCP服务进程与多个客户进程之间必须建立多条TCP连接，每条TCP连接在其数据传送完毕后释放
一个TCP连接对应一个（熟知）服务端口
主服务进程在熟知端口等待客户进程发出的请求。一旦收到客户的请求，就创建一个从属服务进程，并指明从属服务进程使用临时套接字与该客户建立TCP连接，然后主服务进程继续在原来的熟知端口等待向其他客户提供服务




2.域名系统
2.1 概述
域名系统（DNS，Domain Name System）是互联网重要的基础设施之一，向所有需要域名解析的应用提供服务，主要负责将可读性好的域名映射成IP地址
Internet采用层次结构的命名树作为主机的名字，并使用分布式的域名系统 DNS。Internet的DNS是一个联机分布式数据库系统
名字到域名的解析是由若干个域名服务器程序完成的。域名服务器程序在专设的结点上运行，相应的结点也称为名字服务器(Name Server)或域名服务器(Domain Name Server)


2.2 域名系统名字空间和层次结构




2.3 域名解析过程
递归查询
当收到查询请求报文的域名服务器不知被查询域名的IP地址时，该域名服务器就以DNS客户的身份向下一步应查询的域名服务器发出查询请求，即替本地域名字服务器继续查询
较少使用

迭代查询
当收到查询请求报文的域名服务器不知道被查询域名的IP地址时，就把自己知道的下一步应查询的域名服务器IP地址告诉本地域名字服务器，由本地域名字服务器继续向该域名服务器查询，直到得到所要解析的域名的IP地址，或者查询不到所要解析的域名的IP地址
通常使用


3.电子邮件
3.1 邮件发送的常用协议
简单邮件传输协议SMTP（Simple Mail Transfer Protocol）——邮件服务器之间传递邮件使用的协议

最终交付（邮件访问）协议::从邮件服务器的邮箱中获取邮件
POP3：Post Office Protocol-Version 3，第三版邮局协议
IMAP：Internet Message Access Protocol，Internet邮件访问协议
Webmail（HTTP）：基于Web的电子邮件


3.2 Webmail
Webmail——基于Web的电子邮件

提供电子邮件服务的IMAP和SMTP替代方案
使用Web作为界面，用户代理就是普通的浏览器
用户及其远程邮箱之间的通信通过HTTP进行


4.WWW
4.1 WWW体系结构与协议
WWW=World Wide Web=万维网
HTTP服务器和客户端，以及它们之间执行的HTTP协议

服务器

Web页面（HTML文档）：包含多种对象或链接
Web对象（包括：静态对象和动态对象）：可以是 HTML文档、 图像文件、视频文件、声音文件、脚本文件等
对象用URL（统一资源定位符）编址：协议类型://主机名:端口//路径和文件名
客户端

发出请求、接收响应、解释HTML文档并显示
有些对象需要浏览器安装插件


统一资源定位器URLs


www协议


4.2 HTTP
概述
超文本传输协议HTTP（ HyperText Transfer Protocol）在传输层通常使用TCP协议，缺省使用TCP的80端口
HTTP为无状态协议，服务器端不保留之前请求的状态信息
无状态协议：效率低、但简单
有状态协议：维护状态相对复杂，需要维护历史信息，在客户端或服务器出现故障时，需要保持状态的一致性等
HTTP标准
HTTP/1.0: RFC 1945（1996年）
HTTP/1.1: RFC 2616（1999年）
HTTP/2: RFC 7540（2015年）、RFC 8740（2020年）
HTTP发展现状
HTTP/1.0（1996）
无状态，非持久连接
与HTTP/1.1（1999）
支持长连接和流水线机制
缓存策略优化、部分资源请求及断点续传
HTTPS：HTTP+TLS（2008）
增加SSL/TLS（TLS 1.2）层，在TCP之上提供安全机制
HTTP/2.0（2015、2020）
目标：提高带宽利用率、降低延迟
增加二进制格式、TCP多路复用、头压缩、服务端推送等功能


Web安全与隐私：Cookie
HTTP 无状态协议，服务器 用cookies保持用户状态

HTTP在响应的首部行里使用一个关键字头set-cookie：选择的cookie号具有唯一性
后继的HTTP请求中使用服务器响应分配的cookie：
Cookie文件保存在用户的主机中，内容是服务器返回的一些附加信息，由用户主机中的浏览器管理
Web服务器建立后端数据库，记录用户信息，cookie作为关键字
例如：
Set-Cookie: SID=31d4d96e407aad42; Path=/; Domain=example.com
Cookie: SID=31d4d96e407aad42



Cookies一般包含5个字段
域指明Cookie来自何方，每个域为每个客户分配Cookie有数量限制
路径标明服务器的文件树中哪些部分可以使用该Cookie
内容采用“名字=值”的形式，是Cookie存放内容的地方，可以达到4K容量，内容只是字符串，不是可执行程序
安全指示浏览器只向使用安全传输连接的服务器返回Cookie


Cookie技术是把双刃剑，能分析用户喜好，向用户进行个性化推荐
用Cookie在某网站标识用户信息，查找用户以前浏览网站记录
用Cookie记录用户购物清单
用Cookie可以保存4K内容，跟踪用户浏览网站的喜好
用Cookie跨站点跟踪用户点击广告
Cookie技术是把双刃剑，也能跟踪用户网络浏览痕迹，泄露用户隐私
Cookie跟踪用户以前浏览过哪些网站，跟踪用户频繁浏览哪类网站
Cookie收集用户信息，用户网络交互时关注的关键词
Cookie容易嵌入间谍程序，这是个误区，Cookie文件保存的只是文本串，没有可执行程序
用户可以设置浏览器限制使用Cookie
5.流媒体
5.1 概述
流媒体概念
连续媒体（音视频）经压缩编码、数据打包后，经过网络发送给接收方
接收方对数据进行重组、解码和播放
流媒体的特性
端到端时延约束
时序性约束：流媒体数据必须按照一定的顺序连续播放
具有一定程度的容错性：丢失部分数据包也可完成基本功能
流媒体面临的挑战
约束条件：网络特性（带宽有限、动态变化、延迟与抖动、丢失、异构性）
目标：流媒体服务质量要素（画质、启动延迟、平滑、交互性）
如何在“尽力服务”的网络传输条件下获得良好的视频质量？
5.2 流媒体动态自适应传输
DASH (Dynamic Adaptive Streaming over HTTP)
动态自适应流媒体传输协议DASH，由MPEG组织制定的标准
类似协议：苹果HTTP Live Streaming（HLS）； Adobe的HTTP Dynamic Streaming（HDS）；微软的Microsoft Smooth Streaming
DASH 基本思想
完整视频被拆分为固定时长 (2s-10s) 的视频片段(segment)， 每段提供不同码率
视频片段与其对应的元文件（URL）一同存放于DASH服务器
客户端基于网络条件、缓冲大小等，对每个视频片段，自适应选择合适的视频码率来下


DASH中普遍使用的自适应码率ABR（Adaptive bitrate）

6.内容分发网络CDN
6.1 概述
内容分发网络CDN
Content Delivery Network，or Content Distribution Network
基本思想源于MIT对Web服务瞬间拥塞问题的解决（1998）
一种Web缓存系统，靠近网络边缘（用户）提供内容服务
目前提供更丰富的服务，包括静态内容、流媒体、用户上传视频等
主要优点
降低响应时延，避免网络拥塞
避免原始服务器过载及防止DDoS攻击
分布式架构，具有良好的可扩展性
对用户透明，无需用户感知
6.2 关键问题
怎样将内容（如从百万的视频中选定的内容）分发给同时发起访问的数百万用户？

6.3 机理与解决方式
DNS重定向实现CDN

将请求调度到较近或负载较轻的CDN服务器
HTTP重定向请求内容，服务提供者返回清单CDN
原始服务器决策CDN服务器
HTTP响应：状态码30X，Location：指明新的位置
DNS辅助实现CDN

负载均衡DNS负责决策CDN服务器选择
负载均衡DNS需要收集CDN服务器的位置和负载情况
如果找不到被请求的对象，需要从原始服务器获取


7.P2P网络
P2P文件分发协议：BitTorrent

文件被划分为256Kb大小的块
具有种子(torrents)的节点发送或接收文件


8.远程登录Telnet
Telnet协议引入网络虚拟终端NVT（Network Virtual Terminal），使用一种专门的键盘定义来屏蔽不同计算机系统对键盘输入的差异性，同时定义客户进程与远程服务器进程之间的交互过程
NVT是Telnet协议定义的一组通用字符集，通过这种统一的数据表示方式，来保证不同硬件、软件与数据格式的终端与主机之间通信的兼容性
本地终端输入的字符首先由本地Telnet客户进程转换为NVT格式，通过网络将NVT格式的字符传输到远程主机，远程Telnet服务器进程再将NVT格式的字符转换为远程主机能够识别和处理的字符格式
使用Telnet协议在网络中传输的数据都是NVT格式，不同的用户终端与服务器进程均与本地终端格式无关
Telnet的工作过程

本地Telnet客户进程与远程主机上的Telnet服务器进程建立TCP连接
将本地终端上输入的用户名和口令及以后输入的任何命令或字符以网络虚拟终端NVT格式传输给远程主机
将远程主机输出的NVT格式的数据转化为本地所接受的格式送回本地终端，包括输入命令回显和命令执行结果
本地终端对远程主机撤销连接，从而结束 Telnet远程登录过程


9.FTP
9.1 概述
文件传输协议FTP(File Transfer Protocol) 是Internet上使用最广泛的应用层协议之一

FTP提供交互式的访问，允许用户指明文件的类型与格式，并允许文件具有存取权限
FTP屏蔽了各计算机系统的细节，适用于在异构网络中任意计算机之间传送文件
RFC 959早在1985年就已经成为Internet的正式标准
FTP使用C/S方式实现
9.2 工作过程
服务器主进程打开TCP21端口，等待客户进程发出的连接请求
客户可以用分配的任意一个本地端口号与服务器进程的TCP21端口进行连接
客户请求到来时，服务器主进程启动从属进程来处理客户进程发来的请求
服务器从属进程对客户进程的请求处理完毕后即终止，但从属进程在运行期间根据需要还可能创建其他一些子进程
服务器主进程返回，继续等待接收其他客户进程发来的连接请求，服务器主进程与从属进程并行工作
FTP的两个端口与两个连接

控制连接在整个会话期间一直保持，客户进程发出的文件传输请求通过控制连接发送给服务器控制进程（工作在TCP21端口），但控制连接不用来传输文件
服务器控制进程在接收到客户进程发送来的文件传输请求后就创建数据传输进程（工作在TCP20端口）和数据连接
数据连接用来连接客户进程和服务器数据传输进程，实际完成文件的传输。服务器数据传输进程在文件传输完毕后关闭数据连接并结束运行


写在最后
这篇知识汇总我写了好久，因为ppt的缘故，知识整理需要自己消化一遍然后挑选重要的部分整理摘录下来，同时对于某些知识点的组织结构做了相应调整，对于不太清楚的地方，我也去查阅了相关资料做了补充。但需要注意的是有些知识点并不完整，该知识点整理也只是根据我们当时考试的考点来整理的，所以不足之处请见谅。

愿我们以梦为马，不负人生韶华！
与君共勉
————————————————

                            版权声明：本文为博主原创文章，遵循 CC 4.0 BY-SA 版权协议，转载请附上原文出处链接和本声明。

原文链接：https://blog.csdn.net/qq_46101869/article/details/118108697



第一章 计算机网络概述
        国际标准化组织(ISO): International Organization for Standardization, 制定OSI参考模型

        OSI: 开放系统互连参考模型(Open Systems Interconnection Reference Model)
    
        国际电气电子工程师: 世界上最大的专业技术团体 
    
        网络: 由若干结点(计算机、集线器、交换机、路由器等)和连接这些结点的链路组成。
    
        互联网(internet): 网络的网络。通过路由器将网络互连起来,构成一个覆盖范围更大的网络。
    
        因特网(Internet): 世界上最大的互联网。网络把许多计算机连接在一起, 互联网把许多网络连接在一起
    
        客户机(Client) 与 服务器(Server)方式: 简称C/S方式, 是因特网应用最常使用方式。
    
        对等方式(peer to peer): 简称p2p方式。

计算机网络的功能:

数据通信 (最基本)
资源共享
分布式处理: 提高可靠性, 负载均衡
1.1 计算机网络的分类 
按分布范围分类

广域网(WAN): 也称远程网, 使用点对点网络 
城域网
局域网: 使用广播技术, 广域网使用交换技术, 两者协议不同
个人区域网 
按网络的拓扑结构

总线型网络: 增减结点方便, 重负载时通信效率不高, 总线任意一处故障敏感
星形网络: 便于集中控制管理, 中央设备对故障敏感
环形网络: 如令牌缓局域网
网状网络: 可靠性高, 成本高, 多用在广域网中
分类图:



计算机网络的组成:

        网络边缘: 用户直接使用的,由所有连接在因特网上的主机组成。
    
        网络核心: 为边缘部分提供服务的, 由大量网络和网络的路由器组成。

工作方式图:



        通信子网: 实现数据通信
    
        资源子网: 实现资源共享/数据处理

功能组成图:



1.2 三种交换方式
1.2.1 电路交换
        建立连接-->数据传输-->释放连接, 在通话的全部时间内,建立了一条专用的物理通路, 通话的两个用户始终占用端到端的通信资源。

电话交换图:



        特点: 通信时延小, 有序传输, 没有冲突, 但建立时间长, 独占线路线路利用率低。

1.2.2 报文交换
        整个报文先传送到相邻结点, 全部存储下来后查找转发表,转发到下一个结点。

        存储转发: 先暂时存储下来, 检查首部, 按首部中的目的地址查找转发表, 找到合适的接口转发出去,交给下一个分组交换机。 
    
        特点: 无需建立连接, 可以同时发给多个目的地址, 但转发时延高。

1.2.3 分组交换
        同报文交换一样, 采用了存储转发方式, 但解决了报文交换中大报文的传输问题, 可分为面向连接的虚电路方式和无连接的数据报方式, 这两者方式都由网络层提供。 

        分组交换: 将一个数据报文划分成一个个更小的等长数据段, 每个数据段前加上必要的控制信息,构成分组, 通过路由器以存储转发方式,发送到目标主机。

数据报分组交换图:



        数据报特点: 无建立时延, 线路利用率高, 动态分配线路, 相比报文交换, 减少了出错概率和重发数据量, 但存在存储转发时延, 需要传输额外信息量(控制信息), 可能出现失序(虚电路不会)、丢失、重复。 

三种交换比较图:



1.3 计算机网络主要性能指标
1.3.1 速率
        速率就是数据的传送率,它也称为数据率或比特率, 单位是bit/s (bps)

速率:

        千 1kb/s=b/s
    
        兆 1Mb/s=kb/s
    
        吉 1Gb/s=Mb/s
    
        太 1Tb/s=Gb/s

存储容量:

        1KB=B=1024B
    
        1MB=KB
    
        1GB=MB
    
        1TB=GB

1.3.2 带宽
        在计算机中,带宽用来表示网络的通信线路所能传送数据的能力, 即单位时间从网络中的某一点到另一点所能通过的"最高数据率",单位是bit/s。

1.3.3 吞吐量
         也称吞吐率, 表示在单位时间内通过某个网络(或信道,接口)的数据量。吞吐量受网络的带宽或网络的额定速率的限制。

1.3.4 时延
        时延是指数据从网络的一端传送到另一端所需的时间,也称延迟或迟延。

        传输时延: 主机或路由器将分组发送到通信线路上所需的时间, 从发送分组的第一个比特算起,到该分组的最后一个比特发送到线路上所需的时间。公式是:

发送时延=数据长度/发送速率 (信道带宽)

        传播时延: 电磁波在信道中需要传播一定的距离而花费的时间, 公式是:

传播时延=信道长度/电磁波在信道上的传播速率

        处理时延: 主机或路由器收到分组时要花费一定的时间进行处理(分析分组首部、提取数据、差错检验、查找路由等)
    
        排队时延: 在网络传输时, 经过许多路由器的缓存队列中排队的时间。
    
        时延带宽积: 某段链路现在有多少比特



        往返RTT: 从发送数据开始, 到收到接收方确认的时间
    
        备注: 所谓高速网络链路,提高的仅仅是数据的发送速率而不是比特在链路上的传播速率 。提高发送速率只是减少了数据的传输时延。

1.3.5 丢包率***
        即分组丢失率, 指在一定时间范围内, 分组在传输过程总丢失的分组数量与总的分组数量的比率。丢包率高,用户感觉往往是网络时延变大, 而不是信息丢失。

分组丢失的两种情况:

在传输过程中出现了比特级差错, 被结点丢弃
分组交换机队列已满,被抛弃
1.3.6 利用率***
        信道利用率: 信道利用率指出某信道有百分之几的时间是被利用的。根据排队理论, 信道利用率过高会产生非常大的时延。

        网络利用率: 全网络的信道利用率的加权平均值



1.4 计算机网络体系结构
        协议: 控制两个对等体(或多个实体)进行通信的规则。

协议三要素:

语法: 数据与控制信息的结构或格式
语义: 各个控制信息的具体含义, 完成何种动作及做出何种响应。
同步(时序): 数据应该在何时发送出去, 以什么速率发送。
        服务: 下层为紧邻的上层提供的功能调用。协议是"水平的", 服务是"垂直的"。

        接口:  访问服务点(SAP), 上层使用下层服务的入口。

服务、协议、接口：



        协议数据单元(PDU): OSI 对等层之间传送的数据单元, 包含协议控制单元(PCI), 服务数据单元(SDU)

PDU示例图:





1.4.1 五层协议模型
应用层

        任务: 通过进程间的交互来完成特定的网络应用
    
        协议: 如HTTP协议, SMTP协议, FTP协议等
    
        数据单元: 报文

传输层

        任务: 向两台主机中进程(端到端)之间的通信提供的数据传输服务,
    
        功能: 复用, 分用, 流量控制, 差错控制的功能。
    
        协议: TCP协议、UDP协议
    
        TCP: 提供面向连接的, 可靠的数据传输服务, 数据单元是报文段
    
        UDP: 提供无连接的, 尽最大努力的传输服务, 数据单元是用户数据报
    
        服务访问点(SAP): 端口号字段

网络层(网际层、IP层)

        任务: 选择合适的路由,存储转发,最后到达目标主机。
    
        功能: 路由选择, 流量控制, 差错控制, 拥塞控制
    
        主要协议：IP、IPX、ICMP、 IGMP、ARP、RARP、OSPF
    
        数据单元: IP数据报, 简称数据报
    
        服务访问点(SAP): 协议字段

数据链路层

        任务: 把网络层传下来的数据报组装成帧, 差错控制, 流量控制, 控制对信道的访问的功能。
    
        数据单元: 帧
    
        主要协议：SDLC、HDLC、PPP、 STP
    
        帧: 包括数据和控制信息(一个帧从哪里开始,到哪里结束、差错检测)
    
        服务访问点(SAP): 类型字段

物理层

        任务: 主要任务是在物理媒体上实现比特流的透明传输。
    
        主要功能: 定义接口特性, 定义传输模式(单工、半双工、双工), 定义传输速率, 比特同步, 比特编码
    
        数据单元: 比特
    
        主要协议：Rj45、802.3
    
        传输媒体: 双绞线、同轴电缆、光缆等。

 1.4.2 OSI参考模型
        表示层: 用于处理在两个通信系统中交换信息的表示方式, 如: 数据格式变换, 加密解密, 压缩和恢复。

        会话层: 建立同步（SYN）, 提供建立连接并在连接上有序地传输数据。

示意图：



与TCP/IP的区别:



三者区别图: 



1.5 两个重要的新兴网络技术***
云计算

        定义: 云计算是一种运行在计算机网络上的分布式应用,通过网络以按需、易扩展的方式向用户提供安全、快捷、便捷、廉价的数据存储和网络计算服务。
    
        Iaas: 基础设施即服务, 将硬件设备等基础资源(如处理能力、存储空间、网络组件)封装成服务通过网络提供给用户使用。
    
        Paas: 平台即服务,提供用户应用程序的开发和运行环境
    
        Saas: 软件即服务 ,将某些特定应用软件功能封装成服务

物联网

        定义: 物物相连的互联网。按约定的协议,把任何物体与互联网相连接, 进行信息交换和通信,以实现人与物,物与物的相互沟通和对话, 对物体进行智能化识别、定位、跟踪、管理和控制的一种信息网络。

第二章 物理层
2.1 基本概念
        物理层主要任务是确定与传输媒体接口有关的一些特性, 即定义标准

        信源：产生和发送数据的源头。
    
        信宿：接收数据的终点 。
    
        信道：信号的传输媒介。

三种通信方式:

        单工通信: 只有一个方向的通信
    
        半双工通信: 通信的双方都可以发送或接收信息，但任何一方都不能同时发送和接收
    
        全双工通信: 通信双方可以同时发送和接受信息

物理层接口特性:

        机械特征:  规定物理连接时所采用的规格、接口形状、引线数目、引脚数量和排列情况。
    
        电气特征:  线路上信号的电压范围、阻抗匹配、传输速率和距离限制等。
    
        功能特征: 某条线上出现的某一电平表示何种意义  
    
        规程特征: 定义各条物理线路的工作规程和时序关系

数据传输方式:

1) 串行传输: 速度慢，费用低，适合远距离



2) 并行传输: 速度快，费用高，适合近距离



模拟信号/连续信号图:



数字信号/离散信号图:



        同步传输: 需先送出1个或多个同步字符，再送出整批的数据。
    
        异步传输: 加一个字符起始位和一个字符终止位。发送方可以在任何时刻 发送这些比特组，而接收方不知道它们会在什么时候到达。
    
        码元: 用一个固定时长的数字脉冲, 代表不同离散数值的基本波形, 这个时长内的信号称为k进制码元，而该时长称为码元宽度。1码元可以携带多个比特的信息量
    
        码元传输速率：别名波特率, 或调制速率, 波形速率, 符号速率。 表示单位时间内数字通信系统所传输的码元个数（也可称为脉冲个数或信号变化的次数）, 单位是波特（Baud）, 码元速率与进制数无关，只与码元长度有关。
    
        信息传输速率：别名信息速率、比特率等表示单位时间内数字通信系统传输的二进制码元个数, 单位是比特/秒（b/s）。
    
        波特率与比特率的关系：若一个码元携带n bit的信息量，则M Baud的码元传输速率所对应的信息传输速率为M×n bit/s。 

2.1.1奈氏准则（奈奎斯特定理）
        在没有噪声、带宽有限的信道中, 为了避免码间串扰的极限码元传输速率。

        码间串扰：接收端收到的信号波形失去了码元之间清晰界限的现象。 
    
        采样定理(奈奎斯特定理): 采样率必须大于或等于最大频率的2倍。 

公式: 



说明: 

        1) 在任何信道中，码元传输的速率是有上限的
    
        2) 奈氏准则给出了码元传输速率的限制，但并没有对信息传输速率给出限制。
    
        3) 要提高数据的传输速率, 必须设法使每个码元能携带更多个比特的信息量

2.1.2 香农定理
        在带宽受限且有噪声的信道中，为了不产生误差，信息的数据传输速率有上限值。

公式:  



        信噪比: 信号的平均功率/噪声的平均功率, 用分贝（dB）作为度量单位为:

 


如:  , 则 

        说明:  信道的带宽或信道中的信噪比越大，则信息的极限传输速率就越高。

2.2 编码&调制 
        基带信号: 将数字信号1和0直接用两种不同的电压表示，再送到数字信道上去传输

        宽带信号: 将基带信号进行调制后形成的频分复用模拟信号，再传送到模拟信道上去传输
    
        备注: 传输距离较近时，计算机网络采用基带传输方式, 距离较远时，采用宽带传输方式
    
        编码: 数据转化为数字信号
    
        调制: 数据转化为模拟信号 

相关设备的作用:  

        调制器: 数字数据转化为模拟信号
    
        PCM编码器: 模拟数据转化为数字信号
    
        数字发送器: 数字数据转化为数字信号
    
        放大调制器: 模拟数据转化为模拟信号

2.2.1 数字数据编码为数字信号


        1) 非归零编码【NRZ】: 高1低0, 存在同步问题
    
        2) 曼彻斯特编码: 看前半个, 高1低0, 同差分曼彻斯特编码, 占的频带宽度是原始基带宽度的两倍 (波特率:比特率=2:1, 编码效率是50%), 以太网采用曼彻斯特编码 , 电平跳变用于同步
    
        3) 差分曼彻斯特编码: 看前半个与其前面的关系, 相同为1, 不同为0。常用于局域网。有更强抗干扰能力。
    
        4) 归零编码【RZ】:  高1低0  (return to zero)
    
        5) 反向不归零编码【NRZI】: 遇到0则变 (由高变低. 由低变高)
    
        6) 4B/5B编码: 比特流中插入额外的比特以打破 一连串的0或1，编码效率为80%

2.2.2 数字数据调制为模拟信号


        调幅+调相（QAM）: 数据传输速率为  b/s (B为波特, m个相位, n种振幅)
    
        备注: 调频抗干扰能力强, 调幅抗干扰能力差。

2.2.3 模拟数据编码为数字信号
        根据采样定理, 它主要包括三步：采样, 量化, 编码

示例图: 



2.3 传输介质及物理层设备
2.3.1 传输介质
        它就是数据传输系统中在发送设备和接收设备之间的物理通路。传输媒体/介质并不是物理层。

1) 双绞线 (twisted pair cable): 由两根采用一定规则并排绞合的、相互绝缘的铜导线组成 

示例图:



特点: 价格便宜, 最常用的传输介质之一。 

2) 同轴电缆: 分为两类, 一类用于传送基带数字信号, 又称基带同轴电缆, 一类用于传送宽带信号，又称为宽带同轴电缆



特点: 抗干扰特性比双绞线好，传输距离更远，但价格较双绞线贵。

3) 光纤: 光纤由纤芯(实心)和包层构成, 带宽远远大于其他传输媒体的带宽



光纤分类图:



特点: 传输损耗小, 抗雷电和电磁干扰性能好, 不易被窃听或截取数据。体积小，重量轻。

非导向性传输介质:

        1) 无限电波: 信号向所有方向传播, 有较强穿透能力
    
        2) 微波: 信号固定方向传播, 通信频率较高, 有地面微波接力通信和卫星通信两种方式 
    
        3) 红外线和激光: 信号固定方向传播。

2.3.2 物理层设备 
        中继器(转发器): 对信号进行再生和还原，对衰减的信号进行放大, 中继器两端的网段一定要是同一个协议, 可以是不同传输媒体。

        5-4-3规则：用4个中继器串联的5段通信介质只有3段可以挂计算机。
    
        集线器: 实质上是一个多端口的中继器, 只起信号放大和转发作用。星形网络拓扑结构。

第三章 数据链路层
备注: 

        1）OSI体系的数据链路层有流量控制功能, TCP/IP体系中流量控制在传输层 
    
        2）通信质量较差的无限传输中, 数据链路层使用确认和重传机制, 向上提供可靠传输服务
    
        3）通信质量较好的有线链路不再使用确认和重传机制, 由CRC检错保证上交的帧是正确的。

3.1 封装成帧
        数据链路层以帧为单位传输和处理数据, 将网络层的数据报前面和后面分别添加上首部和尾部, 封装成一个完整的帧。首部和尾部作用之一就是进行帧定界。组帧即定义数据格式。

 帧图:



        组帧的四种方法:  字符计数法, 字符填充法, 零比特填充法, 违规编码法。

3.1.1 字符计数法
        帧首部使用一个计数段来标明帧内字符数

示例图:



3.1.2 字符填充法
        使用某个特殊的控制字符作为帧定界符, 使用字节填充的方法将数据部分的特殊字符与帧定界符区分开来, 即在数据中出现的标记字符前插入一个转义字符。

字节填充原理图:



3.1.3 零比特填充法
        当物理链路传送连续的比特流, 可以使用某个特殊的比特组合, 如HDLC协议使用的"01111110"作为标识, 即数据部分只要发现有5个连续1, 则立即填入一个0。

原理图:



3.1.4 违规编码法
        在物理层进行比特编码时采用, 如曼彻斯特编码采用高-高电平或低-低电平，局域网IEEE802标准采用了此方法。

3.2 差错控制
        FCS: 帧检验序列,帧尾部设置的一个差错检验字段。Frame Check Sequence

        CRC: 循环冗余检验, Cyclic Redundancy Check, 也称多项式编码
    
        随机差错: 通过提高信噪比可以减弱影响
    
        突发差错: 引起传输差错的主要原因,由外界电磁干扰引起。

3.2.1 奇偶检验
        每个数据字节都会增加一个额外的位，称为校验位。校验位被设置为使得每个字节中“1”的位数为奇数（或偶数）。

3.2.2 循环冗余码
        具有纠错功能, 只是数据链路层仅使用了它的检错功能。

 CRC 运算原理:



3.2.3 汉明码
        1) 确定汉明距离: , k为冗余信息位数, n为校验位的位数

        2) 校验位的分布:  (i=0,1,2 ... ) 
    
        3) 求出校验码值
    
        4) 汉明码距: 纠错 (2d+1), 检错(d+1)

示例图:



纠错示例图:  



3.3 流量控制和可靠传输
        在数据链路层中, 流量控制和可靠传输是交织在一起的。

        流量控制: 停止等待协议 和 滑动窗口协议。

3.3.1 停止等待协议 Stop-and-Wait
        收到一个正常分组时, 回复一个ACK; 发现错误则回复NAK, 并使发送方重发, 发送方每发送一个分组必须停下来等待接受确认后才能发下一个分组。

        为防止确认分组丢失, 可以采用超时重传机制。
    
        为防止重复接受, 发送带序号的帧。

SW协议原理图:





停止等待协议的信道利用率:



        信道利用率: 发送方发送数据的时间占整个发送周期的比率。TD,TA为传输时延。

1.4.2 回退 N 帧协议 Go-back-N
        采用流水线传输方式, 利用发送窗口限制发送方连续发送分组的个数,  一个分组出错, 其后续连续发送的所有分组都要重传。

        接收方采用累计确认的方式, 有接受窗口的话, 则GBN协议的接受窗口为1。收到失序分组则丢弃, 并对最近按序接受的分组进行确认。

GBN协议原理图:



流水线传输的信道利用率:



        发送窗口大小: 

1.4.3 选择重传协议 Selective Repeat
        在GBN协议基础上, 接受窗口不再为1, 对正确接受的分组进行逐一确认。超时只重传一个超时的帧。

SR协议原理图:



        滑动窗口长度:    (发送窗口+接受窗口<=)
    
        窗口边界: (下边界, 上边界)

连续ARQ协议的信道利用率:





3.4 介质访问控制
        采取一定措施, 使得两个节点之间的通信不会发送相互干扰的情况。

介质访问控制分类图:



3.4.1 静态划分信道
频分多路复用与时分多路复用示例图:



统计时分多路复用(STDM):  



波分多路复用图: 



码分多路复用:  令S表示A站点的码片向量, 令T表示B站点的码片向量 (0用-1,1用+1 ) 则:

        1) S和T的规格化内积: 
    
        2) 在公共信道上进行线性相加
    
        3) 要去A的信息时, 使S与(S*T)进行规格化内积(相乘,除m), -1为0, +1为1(相同码片内积为1, 不同码片内积为0, 因此过滤掉非S的其他信号)

3.4.2 动态划分信道
        争用型协议。

        纯ALOHA协议: 不监听信道, 不按时间槽发送, 想发就发。一段时间内未收到确认就认为发生了冲突。超时后等一随机时间再重传。
    
        时隙ALOHA协议: 将时间划分为一段段等长的时隙, 只能在每个时隙开始才能发送一个帧。

时隙ALOHA协议示意图:



        CSMA协议: 载波监听多路访问协议, 发送前先监听一下共用信道, 发现空闲后再发送。

三种CSMA对比:



        CSMA/CD协议:   载波监听多址接入/碰撞检测。适用于总线型网络或半双工网络。
    
        碰撞检测: 边发送监听,也称冲突检测, 发送碰撞时, 适配器立即停止发送。

 原理图:



        最小帧长: 2*总线传播时延*数据传输速率

截断二进制指数退避算法:

         帧的发送时延不能小于2倍网络最大传播时延, 即一个争用期, 因此以太网规定最短有效帧长64字节。也称动态退避算法



        CSMA/CA协议: 载波监听多址接入/碰撞避免

 不使用CSMA/CD 协议的原因:

        1) 无限信道传输信号强度的动态范围非常大。
    
        2) 隐蔽站问题:



CSMA/CA 工作原理:



三种帧间间隔IFS: 所有站发送完后必须等待一段的时间, 即帧间间隔(IFS)

        1) SIFS: 最短的IFS, 分隔属于一次对话的各帧, 如ACK帧
    
        2) PIFS: 在PCF操作中使用
    
        3) DIFS: 最长的IFS, 用于异步竞争访问的时延。

退避算法:

        1) 当要发送帧的站点检测信道从忙态转为空闲时, 就要执行退避算法(除了非发生不成功的初有数据)。退避计时器设置一个随机退避时间, 当退避计时器减小到零时, 就开始发送数据。
    
        2) 当退避计时器的时间还未减小到零时,信道又转变为忙态, 便冻结退避计时器的数值,重新等待信道变为空闲, 并经过DIFS 后, 继续启动退避计时器。 
    
        3) 为避免一个站点独占信道, 一个站点成功发送完一个数据帧后, 连续发送下一个帧时要启动退避算法。
    
        4) 空闲时等待一个DIFS后发送数据帧。

信道预约:

        1)为减少碰撞的概率和降低碰撞的影响, 源站发送数据帧前要发送一个短的控制帧。即请求发送RTS (Request To Send), 其包括源地址, 目标地址, 通信所需时间(包括确认帧)。
    
        2) 若信道空闲, 目的站就发送一个响应, 即允许发送CTS (Clear To Send )。也包括通信持续时间。
    
        3) 除源站和目的站以外, 其他站收到CTS (或数据帧) 后推迟接入到无线局域网中。如果RST发送碰撞, 需执行退避算法重传RTS。

虚拟载波监听:

        RTS 帧和CTS 帧即数据帧都会携带通信持续时间, 这便叫虚拟载波监听, 但站点检测到正在信道中传送的MAC首部的 "持续时间" 字段时, 会调整自己网络分配向量 NAV (Network Allocation Vector)。

原理图:



        网络分配向量NAV: 指出信道忙的持续时间。源站是SIFS+CTS+SIFS+数据帧+SIFS+ACK, 目的站是SIFS+数据帧+SIFS+ACK。

轮询协议图:



令牌传递协议原理图:

3.5 局域网(Local Area Network)
决定局域网特性的三个要素: 

介质访问控制方式(最重要)
网络拓扑结构
传输介质
局域网分类:

以太网: 逻辑拓扑是总线型结构, 物理拓扑是星形或拓展星形, 符合IEEE802.3标准
令牌环(IEEE802.5): 逻辑拓扑是环形结构, 物理拓扑是星形结构
FDDI(光纤分布数字接口, IEEE802.8): 逻辑拓扑是环形结构, 物理拓扑是双环结构
无限局域网: 采用IEEE802.11标准
IEEE802.1Q: VLAN
        IEEE802标准定义的局域网: 对应OSI参考模型的数据链路层和物理层, 将数据链路层拆分为逻辑链路控制子层(LLC)和媒体接入控制子层(MAC)。

        LLC主要功能: 向网络层提供无确认无连接, 面向连接, 带确认无连接, 高速传送, 给帧加序号
    
        MAC主要功能: 与接入媒体有关的内容, 如组帧, 拆卸帧, 比特传输差错检测, 透明传输

示例图:



3.5.1 以太网
        采用无连接工作方式, 不可靠传输, 差错纠正由高层完成, 发送的数据使用曼彻斯特编码。采用 CSMA/CD 介质访问控制方式。以太网是局域网的一种实现方式, 工作在OSI参考模型的下两层。

        MAC地址: 全球唯一物理地址, 占6字节。

以太网的传输介质图(常识):



MAC帧图:



        填充: 0~46字节(最短MAC帧长度为18字节, 以太网帧数据字段最短帧长64B, 最大1500B) 。
    
        校验码(FCS): 不检验MAC帧数据部分和前导码。 采用32位循环冗余码(CRC)

高速以太网:



        快速以太网: 使用CSMA/CD协议, 保持最短帧长不变, 将最大电缆长度减少到100M。

3.5.2 无线局域网 
IEEE802.11 帧最常见的两种情况:



808.11数据帧:



3.5.3 虚拟局域网VLAN
        将局域网内的设备划分成与物理位置无关的逻辑组的技术, 每个VLAN是一个较小的广播域

IEEE802.1Q帧:





备注:

VLAN标记的后12位是VLAN标识符VID， 唯一表示了该以太网帧属于哪个VLAN。
VLAN的有效VID取值范围为1～4094。 
IEEE 802.1Q帧是由交换机来处理的，而不是由用户主机来处理的。
 以太网交换机构成虚拟局域网:



        备注: 交换机与交换机之间是802.1Q帧, 交换机与主机之间是标准以太网帧。 

划分VLAN的方式:

        1) 基于交换机接口: 
    
        2) 基于MAC地址: 主机与从一个交换机移动到另一个交换机, 也仍属于一个子网
    
        3) 基于IP地址: 跨路由器扩展子网

3.6 广域网
        将分布在不同地区的局域网或计算机系统互连起来, 达到资源共享的目的。如因特网(Internet)是最大的广域网。点对点通信。工作在OSI参考模型的下三层

广域网与局域网的区别与联系:



3.6.1 ppp协议
        只支持全双工链路。标志字节7E, 转义字节7D

ppp协议的三个组成部分:

一个将IP数据报封装到串行链路的方法
链路控制协议(LCP): 用于建立、配置、测试和管理数据链路。身份验证
网络控制协议(NCP): ppp可支持多种网络层协议, 每个不同的网络层协议要用一个相应的NCP来配置
ppp协议状态图:



ppp协议帧格式图:



ppp协议特点:

提供差错检测但不提供纠错功能, 不可靠传输, 即不使用序号和确认机制
仅支出点对点的链路通信, 无需CSMA/CD协议, 也就无最短帧长限制。
只支持全双工链路
ppp的两端可以运行不同的网络层协议
面向字节, PPP帧的长度是整数个字节
异步传输使用字节填充法, 同步传输采用硬件来零比特填充法。
3.6.2 HDLC协议***
        面向比特, 可靠传输, 差错检测不纠错, 采用全双工通信。

HDLC帧格式图:



3.7 数据链路层设备
物理层扩展以太网:



链路层扩展以太网:



         网段: 一般指一个计算机网络中使用同一物理层设备(传输介质, 中继器, 集线器)能够直接通讯的那一部分。

以太网交换机的两种交换方式:

        1) 直通式交换机: 查完目的地址(6B) 就立刻转发, 延迟小, 可靠性低, 不支持不同速率的端口交换。
    
        2) 存储转发式交换机: 检查帧是否正确, 可靠性高, 支持不同速率的端口交换。

冲突域和广播域: 



        VLAN: 可隔离冲突域, 也可隔离广播域
    
        网卡: 主要功能在物理层和数据链路层。

第四章 网络层
4.1 网络层概述
        异构网络互连, 向上只提供简单灵活的, 无连接的, 尽最大努力交付的数据报服务。

        网络拥塞: 当网络中有大量分组需要从某条链路转发时, 出现分组丢失的情况。(队满情况)

拥塞控制的两种方法:

开环控制: 静态预防方法, 设计网络时事先将有关发生拥塞的因素考虑周到。
闭环控制: 动态方法, 采用监测网络系统去监视, 并解决拥塞。
        无连接服务：不事先为分组的传输确定传输路径，每个分组独立确定传输路径，不同分组传输路径可能不同。

4.1.1 网络层提供的两种服务
         1) 虚电路：一条源主机到目的主机类似于电路的路径（逻辑连接, 电路不是专用）, 分组包含虚电路号, 区别其他虚电路上的分组。

虚电路网络图:



        虚电路特点: 提供了可靠通信功能, 不会乱序、重复或丢失。两个端系统之间也可有多条虚电路为不同的进程服务。缺点是某个结点出现故障时, 经过该结点的所有虚电路将遭到破坏。 

2) 数据报网络图:



 数据报与虚电路区别图:



4.1.2 路由器
         历史原因, 有称为网关, 网络层最核心的功能:  分组转发和路由选择。用路由器互连的多个局域网的网络层协议可以不同 (如IPV4与IPV6)

        转发: 仅涉及一个路由器, 转发表根据路由表得出。
    
        路由选择: 涉及很多路由器, 

路由器的结构:



 三种交换结构图***: 



4.1.3 软件定义网络SDN
        采用集中式的控制平面和分布式的数据平面, 两个平面互相分离, 通过Openflow协议将转发表下发给路由器。路由器查找转发分组即可。

        SDN的可编程性通过北向接口提供编程接口, 和转发设备建立双向会议的称为南向接口, SDN控制器之间的通信接口称为东西向接口

SDN特点:

全局集中式控制和分布式高速转发, 灵活可编程与性能平衡
集中管理易受攻击, 随着网络规模扩大, 控制器可能成为网络性能瓶颈 
4.2 IPV4与IPV6及其相关协议
        IP地址实际上标记的是一个主机(或路由器)和一条链路的接口。

4.2.1 IPV4       
        首部的固定长度占20个字节, 后面是可选字段, 首部长度可变。

IP数据报图:



各字段:

1) 版本 : 占4位, IP协议版本, 如4 (IPv4)

2) 首部长度: 占4位, 单位是32位即4个字节。不足4字节由填充字段补齐。

3) 总长度: 占 16位, 首部和数据之和的长度, 单位为字节。一般大于576字节,小于1500字节

4) 标识 :占16位, 每产生一个数据报, 计数器+1, 用于分片时使用。标识同一个数据报

5) 标志: 占3位,第一位为MF, MF=1表示后面还有分片; 第二位为DF, DF=0表示可以分片。

6) 片偏移: 占13位, 单位是8个字节, 表示某片在原分组中的相对位置, 分片的长度一定是8字节的整数倍。

7) 生存时间(TTL): 占8位, 每一跳减少1;

8) 首部检验和: 占16位, 仅校验首部

9) 协议: 6表示TCP, 17表示UDP

检验和计算图: 



数据报分片图:



4.2.2 IP地址及编址方式
        点分十进制记法: IP地址由32位二进制构成, 每8位用等效十进制数字表示。

        多归属主机: 一个主机同时连接到两个网络上时, 该主机必须同时具有两个相应的IP地址, 如: 路由器
    
        分类编址: 每一类地址由两个固定长度字段组成, 一个是网络号, 一个是主机号

分类编址图:



私有地址: 



特殊IP地址:



        网络地址转换(Network Address Translation): NAT能使内部专用地址的专用网络用户共享少量外部全球地址, 以此来访问因特网上的主机和资源。NAT工作在传输层

 NAT原理图:



子网掩码示例图:



        无分类编址CIDR: 无分类域路由选择, 把32位IP地址分成两个部分, 前面连续的全1表示网络号, 后面全0部分指明主机。 

举例:



        斜线记法:即在IP地址后面加上斜线 "/" , 然后写上网络前缀所占的位数。如上图: 192.168.10.215/24
    
        CIDR地址块: 把网络前缀都相同的连续IP地址组成一个CIDR地址块。即路由聚合, 又称构成超网。

构成超网:



        最长前缀匹配: 路由表中可能存在多个包含关系的地址块前缀, 查找可能不止一个匹配结果, 应当从匹配结果中选择具有最长网络前缀的路由。 
    
        默认路由: 用特殊0.0.0.0/0 表示默认路由。
    
        子网划分: 分为等长子网划分 (如: 00,01,10,11 (子网号能否全0全1看情况) ) 和不等长子网划分(如: 0,10,110,1110), 子网划分不增加网络数量。

4.2.3 地址解析协议 ARP (Addresss Resolution Protocol) 
        IP地址放在IP数据报首部, 物理地址则放在MAC帧首部; 物理地址是数据链路层及以下使用的地址, IP地址是网络层及以上各层使用的地址, 是一种逻辑地址。

        ARP: 地址解析协议, 由IP地址找出相应的物理地址
    
        RARP: 逆地址解析协议, 由物理地址, 得出IP地址

IP地址与物理地址图: 



原理:

        1) 每一个主机都有一个ARP高速缓存, 其中存有本局域网上个主机和路由器的IP地址到物理地址的映射表。
    
        2) 主机A向本局域网主机B发送IP数据报时, 先查看ARP高速缓存有无B主机的IP地址, 若有, 则通过局域网把MAC帧发往此物理地址, 若无, APR进程在本局域网广播一个ARP请求分组 (目的MAC为地址为FFFF-FFFF-FFFF)。
    
        3) ARP请求分组是数据链路层的广播, 但ARP响应分组是数据链路层单播
    
        4) 主机A在发送ARP请求分组时, 就把自己的IP地址核物理地址映射写入ARP请求分组, 所有接收到ARP广播的主机都会更新自己的ARP高速缓存。
    
        5) ARP用于解决同一个局域网上的主机或路由器的IP地址和物理地址映射问题。
    
        6) ARP高速缓存中的每一个映射地址项目都设置有生存时间(10~20min)。

原理图:


4.2.4 网际控制报文协议 ICMP (Internet Control Message Protocol)
        ICMP差错报告中的数据字段由IP数据报的首部和数据字段的前8个字节组成。是网络层协议。

ICMP差错报文图:



ICMP差错报告报文:

        1) 终点不可达: 路由器或主机不能交付数据报时, 就向源点发送终点不可达报文
    
        2) 源点抑制: 因拥塞而丢弃数据报时。
    
        3) 时间超时: 当目的地址不是自己时, 会将TTL-1再转发出去, TTL减为0时。
    
        4) 参数问题: 收到的数据报的首部中有的字段的值不正确时
    
        5) 改变路由: 即重定向, 让主机知道下次应将数据报发送给另外的路由器。

以下情况不发送ICMP差错报告:

        1) 对ICMP差错报文不再发送ICMP差错报文
    
        2) 对第一个分片的数据报片的所有后续数据报片
    
        3) 具有多播地址的数据报
    
        4) 对特殊地址, 如:127.0.0.1

ICMP询问报文类型:

回送请求和回答报文
时间戳请求和回答报文
地址掩码请求和回答报文
路由器询问和通告报文 
应用举例:

        1) ping指令: 使用了ICMP的回送请求和回答报文
    
        2) tracert指令(Windows操作系统)

4.2.5 IPV6
        从更本上解决地址耗尽问题, 支持QoS。没有IPV4的校验和字段。

IPV6数据报格式:



特点:

地址位扩大到128位
支持即插即用, 不需要DHCP协议
首部长度必须是8B整数倍
只能在主机处分片
取消了检验和字段
地址表示形式:

        1) 一般形式: 冒号十六进制记法
    
        2) 压缩形式: 省略开头连续的0, 但在域中至少要一个数字; 或双冒号表示法, 进一步省略连续的0, 仅能出现一次。

示例图:



基本地址类型:

单播
多播
任播
IPV6过渡策略:

        1) 双栈协议:一台设备同时启用IPV4和IPV6协议栈。
    
        2) 隧道技术: IPV6要进入IPV4时, 把整个IPV6数据报封装到IPV4数据报的数据部分。

4.3 路由算法及其相关协议
        因特网将整个互联网划分为许多较小的自治系统, 称AS。一个大的ISP就是一个自治系统。AS之间再做路由。

        静态路由算法: 又称非自适应路由算法, 需由网络管理员手工配置路由信息。
    
        动态路由算法: 即自适应路由算法, 通过相互连接的路由器之间彼此交换信息, 按照一定算法优化出路由表, 一定时间时隙里不断更新路由信息。 
    
        内部网关协议 IGP:  自治系统内部使用的路由选择协议, 也称域内路由选择, 如RIP、OSPF协议。
    
        外部网关协议 EGP:  自治系统间的路由选择协议, 也称域间路由选择, 如BGP协议。

关系图:



 4.3.1 RIP (Routing Information Protocol)
        RIP协议即路由信息协议, 是一种分布式的基于距离向量(DV)的路由选择算法。应用层协议, 使用UDP传送数据。

 RIP协议报文格式:



工作原理:

        1) 每一个路由器都要维护从它自己到其他每一个目的网络的距离记录
    
        2) 距离即跳数, 每经过一个路由器, 跳数就+1, 距离=16相当于不可达。
    
        3) 仅和相邻路由器交换路由表, 交换的信息是自己的路由表, 按固定时间(如30s)周期性更新, 或网络拓扑变化时更新, 即触发更新。 
    
        4) 收到相邻路由器的路由表,找出到达每个目的网络的最短距离和下一跳路由器, 并更新自己的路由表。

特点:

实现简单, 但只适用于小型互联网
坏消息传播得慢, 导致回路的更本原因
坏消息传递慢示例图:



4.3.2 OSPF (Open Shortest Path First)
        OSPF 协议即开放最短路径优先。使用分布式的链路转态(LS)路由选择算法, 是网络层协议(IP首部协议字段为89)。

OSPF分组: 



工作原理:

        1) 向本自治系统中所有路由器发送与本路由相邻的所有路由器的链路状态, 最终所有路由器都建立一个链路状态数据库, 即全网的拓扑结构图, 再根据 dijkstra算法求得最优路径的路由表 (路由表不会存储完整路径, 仅有下一跳)。
    
        2) 当链路转态发生变化时, 路由器向所有路由器泛洪法发送此信息, 同时也会周期性洪泛更新信息。
    
        3) 为了使OSPF能用于规模很大的网络, 可以把一个自治系统划分为若干更小的范围, 叫作区域, 一个区域内的路由器最好不超过200个。
    
        4) 刚刚开始工作时, 路由器只知道直接连接的网络的距离, 经过若干次更新后, 所有路由器都会知道到达本自治系统中任意一个网络的最短距离和下一跳路由器地址。
    
        划分区域: OSPF将一个自治系统划分为若干更小的范围, 称为区域, 好处是泛洪法交换链路状态信息范围便局部在每个区域。 

划分区域示例图:



特点:

        1)  可以有多条相同代价路径, 可以将流量分配给这几条路径, 实现负载平衡。
    
        2) 每10s交换一次问候分组, 每30min更新一次, 更新过程收敛的快, 适用于互联网规模很大时
    
        3) 对于不同类型业务可以计算不同的路由
    
        4) 每个链路状态都带上一个32位序号, 序号越大, 状态越新。

4.3.3 外部网关协议 BGP (Broder Gateway Protocol)
        只是力求寻找一条能够到达目的网络且比较好的路由,需要根据策略进行路由选择(策略包括政治、经济、安全方面)。

        只需要在发生变化时更新有变化的部分。是应用层协议, 基于TCP。

BGP协议报文格式: 



工作原理:

        建立TCP连接, 相邻结点互相通告自己到所有目的地的路径信息。
    
        每一个AS的管理员选择至少一个路由器作为AS的BGP代言人, 负责在AS间交换路由信息。
    
        各BGP根据所采用的策略从收到的路由信息中构建出树形结构的AS连通图。

示例图: 





BGP-4的四种报文:

OPEN(打开)报文: 用来与相邻的另一个BGP发言人建立关系
UPDATE(更新)报文: 通知新路径或撤销原路径
KEEPALIVE(保活)报文: 周期性证实邻站的连通性
NOTIFICATION(通知)报文: 报告先前报文的差错, 或用于关闭连接。
三种协议的比较图:  



4.4 IP组播与移动IP
4.4.1 IP组播
        组播一定仅应用与UDP, 把一个分组发送给多个目的主机, 使用D类地址, 组播地址标识一组地址。

1) 单播:



2) 多播(组播): 



硬件组播:



        备注: 组播IP地址与以太网硬件地址的映射关系不是唯一的, 还需要在IP层利用软件进行过滤。 
    
        因特网组管理协议IGMP: 让路由器知道本局域网是否有主机参加或退出了某个组播组。实际上就是要找出以源主机为根节点的组播转发树。使用IP数据报传递报文。

IGMP工作的两个阶段：

        1) 主机要加入组播组, 向组播组的组播地址发送一个IGMP报文, 本地组播路由器收到后, 利用组播路由选择协议把这组成员关系发给因特网上其他组播路由器。
    
        2) 本地组播路由器周期性探询本地局域网上的主机, 只要一个主机对某个组响应, 就认为这个组是活跃的, 几次探询没有回应, 则不再把这组成员关系发给其他的组播路由器。

4.4.2 移动IP
        指移动站以固定的网络IP地址实现跨越不同网段的漫游功能。代理功能在应用层完成。

相关术语: 

移动结点: 具有永久IP地址的移动设备(区别于DHCP分配的私有地址)
归属代理: 本地代理, 一个移动结点拥有的就"居所"。
外部代理: 外地代理, 在外部网络中帮助移动节点完成移动管理功能的实体
移动通信过程: 



第五章 传输层
网络层与传输层区别:

       网络层提供主机到主机之间的逻辑通信, 而传输层为应用进程之间提供端到端的逻辑通信

区别图:



​        

        复用: 多个应用进程可同时使用传输层的服务
    
        分用: 传输层把收到的信息分别交付给上面应用层的相应进程
    
        端口: 端口是应用层与传输层之间接口的抽象, 端口号是应用进程的传输层地址。端口用16位端口号进行标记, 允许有65535个端口号,分为熟知端口、登记端口、动态端口。
    
        熟知端口: 其数值为0~1023。由因特网赋号管理局分配给常用的应用层程序固定使用。

如: 

DNS - 53



        登记端口: 数值为1024-49151。不分配也不控制, 可以先IANA注册登记, 防止重复使用。
    
        动态端口: 其数值为49152-65535。留给客户进程选择的临时端口。

常见应用:



5.1 UDP
        DUP传送的数据单元是用户数据报，首部字段由四个部分组成, 每个部分都是2个字节,共8个字节。

特点:

        1) 无连接, 减少开销和发送数据前的时延
    
        2) 尽最大努力交付, 即不可靠交付, 但不需要维持许多参数、复杂连接状态表。
    
        3) 没有拥塞控制, 不因拥塞降低发送速率, 适合实时应用。
    
        4) 面向报文, 不对应用层交下来的报文行划进分分组, 因此应用层要交合适大小的报文, 太大,IP传送时需要进行分片, 太小, IP首部相对较大, 都会降低IP层的效率。
    
        5) 支持一对一, 一对多, 多对一, 多对多交互通信。
    
        6) 首部只有8个字节开销, 比TCP至少20个字节是首部要短。

 UDP首部字段图:



首部字段: 

        1) 源端口: 源端口号
    
        2) 目标端口: 目标端口号
    
        3) 长度: 首部和数据之和的长度, 单位为字节。
    
        4) 检验和: 差错检验码, 防止UDP用户数据报在传输中出错, 可选字段(全0表示不检验)

 UDP计算检验和方法:

        1) 与IP只检验首部不同, UDP的检验会把首部和数据部分一起检验。
    
        2) 首先将全0放入检验和字段中, 将伪首部及用户数据看成16位的字串,不是偶数个字节, 则加入一个全0字节。而后按二进制反码计算出这些16位字的和, 将此二进制反码写入检验和中。
    
        3) 接收方收到的UDP用户数据报连同伪首部一起, 按二进制反码求这些16位字的和, 无差错时结果为全1, 否则就丢弃这个错误的UDP数据报。
    
        4) 伪首部既不下传, 也不上交, 仅仅是计算检验和。
    
        5) 伪首部的第三个字段为全0, 第四个字段是UDP协议字段, 固定17。

示例图:



5.2 TCP
        MMS: 最大报文段长度 (数据段部分)

5.2.1 TCP报文段首部格式
        TCP的数据单元是报文段, 首部的前20个字节是固定的, 后面有4N个字节是根据需要而增加的选项。面向字节流

首部字段:

        源端口与目标端口: 各占两个字节,与UDP一样, 用于传输层的复用和分用
    
        序号: 占4个字节, 从0开始到2^32 - 1为止, 可对4GB的数据进行编号。每一个字节都要按顺序编号。整个数据的起始序号在连接建立时约定; 首部中的序号字段值表示本报文段所发送数据的第一个字节序号。
    
        确认号: 占4个字节, 是期望收到对方的下一个报文段的第一个数据字节的序号。如:收到序号为501, 数据长度为200, 则期待收到的下一个数据序号是701。
    
        数据偏移: 占4位, 指出TCP报文段的数据起始处距离TCP报文段的起始处有多远。即TCP报文段首都的长度。数据偏移的单位是32位字,(即4字节) 最大表示范围是60字节, 即TCP首部最大长度。
    
        确认位ACK: 置为1时, 确认号字段才有意义
    
        紧急位URG: URG=1时, 表明报文中有紧急数据。配合紧急指针使用
    
        同步位SYN: SYN=1时, 表明是一个连接请求/接受报文
    
        终止位FIN: FIN=1时, 要求释放链接
    
        保留: 占6位, 暂不使用。
    
        窗口: 占2个字节, 指示发送方的接受窗口大小。窗口用来控制对方发送的数据量。   
    
        检验和: 占2字节, TCP伪首部的第四个字段为TCP的协议号16，其计算与UDP检验和一样。

TCP首部字段图:



TCP的主要特点:

        1) 面向连接: 传输数据前, 必须先建立TCP连接
    
        2) 每一条TCP连接只能是点对点的
    
        3) 可靠交付的服务, 通过TCP连接传送的数据无差错、不丢失、不重复、按序到达。
    
        4) 全双工通信, 允许通信双方的应用进程在任何时候都能发送数据, 两端都设有发送缓存和接收缓存。
    
        5) 面向字节流, TCP把应用进程交下来的数据块看成是一连串无结构的字节流进行封装发送。

5.2.2 TCP连接管理
       TCP是面向连接的议协。TCP连接分三个阶段. 即连接建立, 数据传送, 连接释放。

三次握手:

        1) 客户端进程发出请求报文段, 首部SYN置为1, 同时选择一个序号seq=x。TCP客户端进入SYN-SENT (同步已发送)状态。
    
        2) 服务器进程发回连接确认请求, 在确认报文段中把SYN和ACK都置为1, 确认号是ack=x+1, 同时为自己定义一个序号seq=y。TCP服务进入 SYN-RCVD ( received 同步收到)状态。
    
        3) 客户端进程收到连接确认后, 还要向服务器进程给出确认, 同时可携带数据。ESTABLISHED (已建立连接)状态。第三次握手不携带数据则不消耗序号!
    
        备注: SYN=1的报文段不能携带数据, 但要消耗一个序号。

TCP连接图:



        SYN洪泛攻击: 服务器的资源在完成第二次挥手时分配的, 客户端的资源在完成第三次握手时分配, 因此服务器易受到SYN洪泛攻击。

四次挥手: 

        1) 客户端把发往服务器的报文段首部 FIN=1, seq=u (之前已传送的最后一个字节的序号+1)。TCP客户端进入FIN-WIT-1(终止等待1)状态。
    
        2) 服务器收到释放连接通知后, 发出确认号ack=u+1。服务器进入CLOSE-WAIT(关闭等待)状态。这样, 客户端到服务器的连接就释放了, 连接处于半关闭状态。但客户端仍能接受服务器发送的数据, 并给出确认。客户端进入FIN-WIT-2。
    
        3) 当服务器不再向客户端发送数据时, 发出FIN=1, seq=w, ack=u+1(基于上次), 这时服务器进入 LAST-ACK (最后确认)状态。客户端进入TIME-WAIT。
    
        4) 客户端收到连接释放报文段后, 回复ack=w+1, seq=u+1 但客户端的TCP不能马上释放, 还要等待最长报文段寿命时间(2MSL)才能释放整个连接。因为服务器可能重发(3)。最后, 客户端进入CLOSED(连接关闭)状态。

TCP连接释放图:



5.2.3 TCP可靠传输
        TCP在IP的不可靠的尽最大努力服务的基础上实现了可靠的数据传输服务, 即数据无差错、不丢失、按序不重复。

数据编号与确认:

        1) TCP协议是面向字节的, 一个字节对应一个序号。连接建立时, 双方TCP要各自确定初始序号。报文段中的序号字段值表示该报文中第一个数据字节的序号。
    
        2) TCP使用的是累积确认, 即确认是对所有按序接收到的数据的确认(已按序收到的数据的最高序号+1)。确认号表示接收方期望下次收到的数据中的第一个数据字节序号。如:已经收到了1~700, 801~1000, 那么发送的确认序号应填入701。
    
        4) TCP采用了一种延迟确认机制, 即接收方有数据发送给对方, 则可以捎带确认, 也可能这段时间内又有数据到达, 则可以对这两次到达的数据进行累积确认, 提高效率。
    
        5) 收到重复的报文段, 丢弃的同时要立即发回确认信息。

 累计确认示意图:



        超时重传机制:  TCP发送方每发送一个报文段, 就会为这个报文段设置一个计时器。时间到了但还没有收到确认,就要重传这一报文段。即超时重传。超时重传时间应当比当前往返时间(RRT)要长一些。

超时重传图:



        快速重传机制: 一个报文段的丢失会引起发送方连续收到多个重复确认, 快速重传即当发送方一连收到三个重复确认后, 立即重传丢失的报文段。

快速重传示意图:



5.2.4 TCP流量控制
        TCP采用接收方控制发送方发送窗口大小的方法来实现, 即在TCP报文段首部窗口字段是当前接收方的接受窗口大小。TCP发送方的发送窗口大小必须小于该值。

可变窗口进行流量控制图:



        窗口探测:为防止当发送方窗口为0, 而接收方发送的窗口更新报文段丢失而导致的死锁状态, 当发送方还有数据发送时, 会周期性地(如: 60s)发送只包含1个字节数据的窗口探测报文段, 以便强制接收方发回确认并通告接收窗口大小。

5.2.5 TCP拥塞控制
        慢开始: cwnd<ssthresh时, 每经过一个RRT(往返时间), 发送方的平均发送速率增加一倍。

        2) 慢启动门限(ssthresh): 发生拥塞状态下窗口大小值的一半, 当cwnd>=ssthresh时, 启动拥塞避免算法。
    
        3) 拥塞避免:当cwnd>=慢启动门限时, 就增加一个MSS大小, 按线性规律缓慢增长,直到发生拥塞。同时修改ssthresh。

 慢启动与拥塞避免算法图:



 快重传快恢复图:



        发送窗口上限值: Min( rwnd, cwnd ) 

第六章 应用层
6.1 网络应用体系结构
6.1.1 客户端/服务器结构
        客服端: 服务请求方, 不总是处于开机状态, 主动请求服务,客户端进程间不能直接通信。

        服务器: 服务提供方, 总是处于运行状态, 等待客户端请求, 服务器进程有固定端口号, 运行服务器的主机有固定的IP地址。

C/S模式图:



6.1.2 对等体结构
        没有固定的服务请求者和服务提供者, 分布在网络中的应用进程是对等的, 称为对等方, 每个对等方即是服务请求者, 又是服务提供者。最突出特性是它的可扩展性, 每增加一个对等方, 不仅增加服务请求者, 也增加了服务提供者。

P2P图:

6.2 域名系统 DNS (Domain Name System)
       域名到 IP 地址的转换过程, 以UDP数据报方式发给本地域名服务器。

备注:

多个IP地址可以映射到同一个域名上
负载分配: 允许同一个主机名对应一个IP 地址集合; 热门网站可以多个服务器, 共享同一个域名
一台主机可以映射到多个域名上
每一级域名由数字和英文字母(不区分大小写)组成,不超过63个字符, 完整的的域名不超过255字符。
三类顶级域(TLD):

国家顶级域名: 如 cn 中国 、us 美国 、 uk 英国。
通用顶级域名：如 com 公司企业、 net 网络服务机构、org 非营利性组织、int 国际组织。
反向域: 用于反向域名解析, 将IP 反向解析为域名
域名空间树状图:



四种域名服务器:

根域名服务器: 不直接把待查询的域名转成IP地址, 知道所有顶级域名服务器的域名及其IP 地址
顶级域名服务器: 收到DNS请求可能返回结果, 也可能是下一级权威服务器名服务器的IP地址
权威服务器: 负责管理某个区的域名服务器, 每一个主机的域名都必须在某个权威域名服务器处上登记 (总能将其管辖的主机名转化为IP地址)。也知道其下级权威域名服务器地址。
本地域名服务器: 起DNS代理作用, 将查询报文转发到域名服务器登记结构中。
DNS划分区图:



域名解析过程:

        递归查询:  主机向本地域名服务器的查询一般是递归查询, 即本地域名服务器不知道被查询域名的IP地址时, 本地域名服务器以DNS客户的身份向某个根域名服务器发出查询请求报文(替该主机查询)。
    
        迭代查询:   本地向根域名服务器发出请求后, 根域名服务器将顶级域名服务器的IP 地址告诉本地服务器,由本地服务器再向顶级服务器发出查询, 以此类推,直到向权威服务器查询到结果。

示例图: 



高速缓存域名服务器:

        1) 缓存最近查询过的域名。重复查询相同域名时, 不必在向根域名服务器发起请求。
    
        2) 由于IP 地址的绑定可能会发生变化, 缓存的域名会内置计时器(一般是48小时), 到时后将删除缓存。
    
        3) 增加时间值可以减少网络开销, 减少此时间值可提高域名解析的准确性。

6.3 文件传送协议 FTP (File Transfer Protocol)
        FTP基于客户/服务器体系结构, 主进程, 负责接受请求; 若干个从属进程, 负责处理单个请求, 由此两大部分组成。

两个从属进程:

        1) 控制进程: 控制连接在整个会话期间一直保持,接受客户端发出的各种命令。
    
        2) 数据传输进程: 数据连接是非持续的, 即上传完一个文件后就关闭连接。分以下两种模式: 主动模式PORT服务器的20端口连接到客户端; 被动模式PASV, 客户端连接到服务器随机端口。

原理图:



6.4 电子邮件 (SMTP&POP3)
        电子邮件采用客户端/服务器体系结构, 采用 SMTP(Simple Mail Transfer Protocol) 简单邮件传送协议、POP3(Post Office protocol) 邮局协议。

        用户代理(User Agent): 用户与电子邮件系统的接口, 又称电子邮件客户机软件。  

原理图:



两种不同通信方式:

推: 发件人通过 STMP 协议将邮件 "推" 给用户代理, 用户代理将邮件 "推" 接受方服务器。 
拉: 收件人通过 POP3 把邮件从服务器中 "拉" 过来。
TCP/IP体现的电子邮件地址格式:

收件人@邮箱所在邮件服务器的域名

IMAP（Internet Message Access Protocol）与POP3:

        1) POP3: 邮件协议第三版, 提供下载并删除和下载并保留的两种工作方式。110端口
    
        2) IMAP: 因特网邮件访问协议, 在POP3的工作方式基础上, 可以管理服务器上的邮件。允许用户代理只获取报文的某些部分。

MIME (Multipurpose Internet Mail Extensions) 多用途网际邮件扩充:



        基于HTTP的电子邮件: 客户端到服务器之间使用 HTTP, 而不同服务器间使用 SMTP 协议。 

示意图:



6.5 万维网 WWW (World Wide Web)
        万维网以客户端/服务器方式工作。

        超文本: 带有链接的文本,也叫超链接。
    
        超媒体: 包含文本信息及其他多媒体对象, 如图形、声音、视频等。
    
        超文本传送协议: HTTP
    
        超文本标记语言: HTML
    
        URL的格式: <协议>://<主机>:<端口>/<路径>, Uniform Resource Locator即统一资源定位符。
    
        超文本传送协议 HTTP: 默认端口80, 使用TCP传输层协议, 是无状态协议, 即同一个客户上一次对服务器的访问不影响下一次的访问结果。

HTTP请求过程图:



非持续与持续连接:

        1) HTTP/1.0 协议: 采用非持续连接方式, 即一次请求/响应对应一次TCP连接(三次握手)。
    
        2) HTTP/1.1 协议: 使用持续连接方式, 即响应后仍然保持这条连接。此协议还可以使用流水方式工作, 即收到HTTP的响应报文前,就可以连续发送多个请求报文。

区别图:



HTTP的报文格式:



HTTP请求报文的方法:



状态码:



        Cookie: 对无状态的HTTP进行状态话的技术

Cookie原理图:



万维网缓存与代理服务器***:

        1) web缓存: 即万维网缓存, 可位于客户机或中间系统, 在中间系统称为代理服务器。当请求到达时,若主机有请求的缓存, 则返回缓存的响应报文。
    
        2) web缓存命中率较高时,可减少访问因特网的时延, 代理服务器另一个作用是可以用来隔离内外网络。
    
        3) 实际上web 对象可能被缓存在从浏览器到原始服务器路径的多个地方, 服务器为每个响应的对象设定一个修改时间和有效时间, 对象到期前, 可以直接返回缓存对象, 到期之后,缓存会使用条件GET请求向原始服务器验证对象是否存在最新版, 若修改则返回新版本对象。

6.6 动态主机配置协议 DHCP (Dynamic Host Configuration Protocol)
        允许一台计算机加入新的网络和获取IP地址而不用手工参与,称为即插即用连网。

原理:

        DHCP 使用客户端/服务器方式。
    
        需要自动获取IP地址的主机启动时在本网用UDP广播发送一个DHCP发现报文,其目的IP地址为255.255.255.255，自己的IP 地址默认为全0。
    
        通过DHCP 中继代理转发DHCP发现报文。
    
        DHCP 服务器通过UDP回应DHCP中继代理一个DHCP提供报文, 包含IP地址等配置信息。
    
        DHCP 中继代理在将此DHCP提供报文发回给主机。

————————————————

                            版权声明：本文为博主原创文章，遵循 CC 4.0 BY-SA 版权协议，转载请附上原文出处链接和本声明。

原文链接：https://blog.csdn.net/s6664/article/details/131762041